<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Presupuestos Corte Laser</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-firestore-compat.js"></script>
    <style>
        /* Estilos generales */
        body { font-family: 'Inter', sans-serif; }
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap');

        /* Ocultar contenido de pestañas por defecto */
        .tab-content { display: none; }
        .active-tab-content { display: block; }

        /* Estilos Pestañas */
        .tab-button { padding: 8px 16px; margin-bottom: -1px; cursor: pointer; border: 1px solid transparent; border-bottom: 2px solid transparent; transition: border-color 0.3s, color 0.3s; color: #6b7280; font-weight: 500; white-space: nowrap; }
        .tab-button.active-tab { border-color: #d1d5db #d1d5db #fff; border-bottom-color: #3b82f6; color: #2563eb; }
        .tab-button:hover:not(.active-tab) { border-bottom-color: #9ca3af; color: #4b5563; } /* Added :not(.active-tab) */
        .tab-button.superadmin-tab { color: #8b5cf6; }
        .tab-button.superadmin-tab.active-tab { border-color: #d1d5db #d1d5db #fff; border-bottom-color: #7c3aed; color: #6d28d9; }
        .tab-button.superadmin-tab:hover:not(.active-tab) { border-bottom-color: #a78bfa; color: #7c3aed; } /* Added :not(.active-tab) */

        /* Visibilidad basada en roles */
        .admin-only, .superadmin-only { display: none; }
        .public-only { display: block; }
        body.logged-in .admin-only { display: block; } /* Default display */
        body.logged-in nav#tab-buttons { display: flex; } /* Ensure nav is flex when logged in */
        body.logged-in .public-only { display: none; }
        body.role-superadmin .superadmin-only { display: block; } /* Default display */
        /* Fine-tune display for specific elements if needed (e.g., inline-block for buttons) */
        body.logged-in #user-email { display: inline; }
        body.logged-in .generic-print-button { display: inline-block; }
        body.logged-in #admin-logout-button { display: inline-block; }
        body.role-superadmin button.superadmin-tab { display: inline-block; }


        /* Estilos tablas y formularios */
        .admin-table { width: 100%; border-collapse: collapse; margin-top: 1rem; font-size: 0.9rem; }
        .admin-table th, .admin-table td { border: 1px solid #ddd; padding: 6px; text-align: left; vertical-align: middle;}
        .admin-table th { background-color: #f2f2f2; font-weight: 600; /* Added font-weight */}
        .admin-table button, .action-button { padding: 4px 8px; font-size: 0.8rem; margin-right: 4px; cursor: pointer; border-radius: 4px; transition: background-color 0.2s; border: none; /* Added border none */ }
        .edit-button { background-color: #facc15; color: #422006; } .edit-button:hover { background-color: #eab308; }
        .delete-button { background-color: #f87171; color: #450a0a; } .delete-button:hover { background-color: #ef4444; }
        .print-button { background-color: #60a5fa; color: #1e3a8a; } .print-button:hover { background-color: #3b82f6; }
        .generic-print-button { background-color: #a78bfa; color: #f5f3ff; } .generic-print-button:hover { background-color: #8b5cf6; }

        /* Colores de estado */
        .status-encargado { background-color: #fbbf24; color: #78350f; padding: 2px 6px; border-radius: 4px; font-weight: 500; font-size: 0.8rem; /* Added font-size */}
        .status-procesando { background-color: #f87171; color: #7f1d1d; padding: 2px 6px; border-radius: 4px; font-weight: 500; font-size: 0.8rem; /* Added font-size */}
        .status-terminado { background-color: #4ade80; color: #14532d; padding: 2px 6px; border-radius: 4px; font-weight: 500; font-size: 0.8rem; /* Added font-size */}

        /* Resaltado fecha vencida */
        .date-overdue { color: #dc2626; font-weight: bold; }

        /* Feedback messages */
        .feedback { padding: 8px; margin-top: 8px; border-radius: 4px; font-size: 0.9rem; min-height: 2em; /* Ensure space even when empty */ }
        .feedback-success { background-color: #dcfce7; color: #166534; border: 1px solid #86efac; }
        .feedback-error { background-color: #fee2e2; color: #991b1b; border: 1px solid #fca5a5; }
        .feedback-info { background-color: #e0f2fe; color: #075985; border: 1px solid #7dd3fc; }

        /* Estilos para impresión */
        @media print {
            body { -webkit-print-color-adjust: exact !important; print-color-adjust: exact !important; }
            .no-print { display: none !important; }
            header, nav#tab-buttons, footer, #client-form, #job-form .no-print, #material-form-admin .no-print, #config-form-admin { display: none !important; }

            /* Estilos para impresión general de sección */
            body.printing-section > *:not(#tab-content-container) { display: none !important; }
            body.printing-section #tab-content-container > *:not(.printing-now) { display: none !important; }
            body.printing-section .printing-now {
                visibility: visible !important;
                display: block !important; /* Ensure the section is block */
                position: absolute; left: 0; top: 0; width: 100%;
                background-color: #fff !important; color: #000 !important; /* Force colors */
                padding: 10px; margin: 0; border: none; box-shadow: none;
                font-size: 10pt; /* Adjust base font size */
            }
            body.printing-section .printing-now * { visibility: visible !important; }
            body.printing-section .printing-now button,
            body.printing-section .printing-now input[type="button"], /* Hide specific input types if needed */
            body.printing-section .printing-now input[type="submit"],
            body.printing-section .printing-now .no-print { display: none !important; }
            /* Allow text/number inputs, selects, textareas to show their values but not be interactive */
            body.printing-section .printing-now input:not([type="button"]):not([type="submit"]),
            body.printing-section .printing-now select,
            body.printing-section .printing-now textarea {
                 border: none !important; background-color: transparent !important; -webkit-appearance: none; appearance: none;
            }
            body.printing-section .printing-now .admin-table { font-size: 9pt; width: 100%; margin-top: 0.5rem;}
            body.printing-section .printing-now .admin-table th,
            body.printing-section .printing-now .admin-table td { padding: 4px; border: 1px solid #ccc !important; color: #000 !important; background-color: #fff !important; } /* Force border/color */
             body.printing-section .printing-now .admin-table th { background-color: #eee !important; font-weight: bold;} /* Header background */
            body.printing-section .printing-now h1, body.printing-section .printing-now h2, body.printing-section .printing-now h3 { color: #000 !important; margin-bottom: 10px; font-size: 14pt; }
            /* Ocultar específicamente la columna de acciones si tiene la clase no-print */
             body.printing-section .printing-now .admin-table th.no-print,
             body.printing-section .printing-now .admin-table td.no-print { display: none !important; }
             /* Show status colors */
            body.printing-section .printing-now .status-encargado,
            body.printing-section .printing-now .status-procesando,
            body.printing-section .printing-now .status-terminado {
                -webkit-print-color-adjust: exact !important; print-color-adjust: exact !important;
                display: inline-block !important; /* Ensure they show */
                border: 1px solid #ccc; /* Add border for clarity if needed */
                padding: 1px 4px !important; /* Adjust padding */
                font-size: 8pt !important; /* Adjust font size */
            }


            /* Estilos específicos para Ticket */
            body.printing-ticket { margin: 0; padding: 0; background-color: #fff !important; } /* Reset body */
            body.printing-ticket > *:not(#print-area-wrapper) { display: none !important; visibility: hidden !important; } /* Hide everything except the wrapper */
            body.printing-ticket #print-area-wrapper {
                visibility: visible !important; display: block !important;
                position: static !important; /* Use static for normal flow in print */
                width: 80mm !important; /* Typical thermal printer width */
                max-width: 100%;
                margin: 5mm auto !important; /* Center or position */
                padding: 0 !important;
                background-color: #fff !important;
                box-shadow: none !important; border: none !important;
                font-family: 'Courier New', Courier, monospace !important; /* Typical receipt font */
                font-size: 9pt !important; /* Slightly smaller */
                line-height: 1.3 !important;
                color: #000 !important;
             }
            body.printing-ticket #print-area {
                visibility: visible !important; display: block !important;
                padding: 3mm !important; /* Padding inside the ticket */
                /* border: 1px solid #ccc; */ /* Optional border for the ticket */
            }
            body.printing-ticket #print-area h2 { font-size: 11pt !important; margin-bottom: 6px !important; text-align: center !important; font-weight: bold !important; }
            body.printing-ticket #print-area p { margin: 2px 0 !important; font-size: 9pt !important;}
            body.printing-ticket #print-area hr { border: none !important; border-top: 1px dashed #555 !important; margin: 4px 0 !important; }
            body.printing-ticket #print-area strong { font-weight: bold !important; }
            body.printing-ticket #print-area .item-line { display: flex; justify-content: space-between; }
            body.printing-ticket #print-area .item-line span:last-child { text-align: right; }
            body.printing-ticket #print-area .totals { margin-top: 8px; border-top: 1px solid #555; padding-top: 4px; }
            body.printing-ticket #print-area em { font-style: italic; color: #333; } /* Style for time */
        }
    </style>
</head>
<body class="bg-gray-100 text-gray-800">

    <div class="container mx-auto p-4">

        <header class="bg-white shadow-md rounded-lg p-4 mb-6 no-print">
            <div class="flex flex-col md:flex-row justify-between items-center">
                 <div>
                    <h1 class="text-3xl font-bold text-blue-600 mb-2">Presupuestos Corte Laser</h1>
                    <div class="text-sm text-gray-600">
                        <p>Dirección: Tu Calle 123, Ciudad | Teléfono: (123) 456-7890 | Email: info@tuempresa.com</p>
                        <!-- <p>Redes Sociales: [Iconos o Enlaces]</p> -->
                    </div>
                 </div>
                 <div class="mt-4 md:mt-0 flex items-center space-x-3">
                     <span id="user-email" class="admin-only text-sm text-gray-500 mr-3"></span>
                     <button onclick="printCurrentSection()" title="Imprimir vista actual" class="admin-only generic-print-button action-button">
                         <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="6 9 6 2 18 2 18 9"/><path d="M6 18H4a2 2 0 0 1-2-2v-5a2 2 0 0 1 2-2h16a2 2 0 0 1 2 2v5a2 2 0 0 1-2 2h-2"/><rect width="12" height="8" x="6" y="14"/></svg>
                     </button>
                     <button id="admin-login-button" onclick="showLoginSection()" class="public-only bg-gray-600 hover:bg-gray-700 text-white text-sm font-bold py-1 px-3 rounded transition duration-300">
                         Iniciar Sesión
                     </button>
                     <button id="admin-logout-button" onclick="logoutUser()" class="admin-only bg-red-600 hover:bg-red-700 text-white text-sm font-bold py-1 px-3 rounded transition duration-300">
                         Cerrar Sesión
                     </button>
                 </div>
            </div>
        </header>

        <!-- Tab Buttons container initially hidden, shown by body.logged-in -->
        <nav id="tab-buttons" class="admin-only flex flex-wrap border-b border-gray-300 mb-6 no-print" style="display: none;">
             <button onclick="setActiveTab(this)" data-target="jobs" class="tab-button">Trabajos</button>
             <button onclick="setActiveTab(this)" data-target="new-job-form" class="tab-button">Nuevo Trabajo</button>
             <button onclick="setActiveTab(this)" data-target="clients" class="tab-button">Clientes</button>
             <button onclick="setActiveTab(this)" data-target="deadlines" class="tab-button">Plazos</button>
             <button onclick="setActiveTab(this)" data-target="status" class="tab-button">Estados</button>
             <button onclick="setActiveTab(this)" data-target="reports" class="tab-button">Informes</button>
             <button onclick="setActiveTab(this)" data-target="admin-materials" class="tab-button superadmin-only superadmin-tab">Materiales</button>
             <button onclick="setActiveTab(this)" data-target="admin-config" class="tab-button superadmin-only superadmin-tab">Configuración</button>
        </nav>

        <main id="tab-content-container">

            <!-- Home Section (Visible Publicly) -->
            <section id="home" class="tab-content bg-white p-6 rounded-lg shadow-lg">
               <div class="p-6 rounded-lg text-center">
                    <h2 class="text-4xl font-bold mb-4 text-blue-600">Bienvenido</h2>
                    <p class="text-lg mb-6 text-gray-700">Gestiona tus clientes, trabajos y presupuestos de corte láser.</p>
                    <button onclick="showLoginSection()" class="public-only bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-6 rounded-lg text-xl shadow-md transition duration-300">
                        Iniciar Sesión
                    </button>
                </div>
            </section>

            <!-- Login Section -->
            <section id="login" class="tab-content bg-white p-6 rounded-lg shadow-lg max-w-md mx-auto">
                 <h2 class="text-2xl font-bold mb-6 text-center text-blue-600">Iniciar Sesión</h2>
                 <form id="login-form" class="space-y-4">
                     <div>
                         <label for="login-email" class="block text-sm font-medium text-gray-700">Email:</label>
                         <input type="email" id="login-email" required class="mt-1 block w-full p-2 border border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500">
                     </div>
                     <div>
                         <label for="login-password" class="block text-sm font-medium text-gray-700">Contraseña:</label>
                         <input type="password" id="login-password" required class="mt-1 block w-full p-2 border border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500">
                     </div>
                     <button type="submit" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-lg shadow-md transition duration-300">
                         Entrar
                     </button>
                     <div id="login-error" class="mt-2 text-red-600 text-sm text-center min-h-[1.25em]"></div>
                 </form>
            </section>

            <!-- Clients Section (Admin Only) -->
            <section id="clients" class="tab-content admin-only bg-white p-6 rounded-lg shadow-lg">
                <h2 class="text-2xl font-bold mb-6 text-center text-blue-600">Gestión de Clientes</h2>
                <form id="client-form" class="bg-gray-50 p-4 rounded border border-gray-200 space-y-3 mb-6 no-print">
                     <h3 id="client-form-title" class="text-lg font-medium">Añadir Nuevo Cliente</h3>
                     <input type="hidden" id="client-id">
                     <div>
                         <label for="client-name" class="block text-sm font-medium text-gray-700">Nombre:</label>
                         <input type="text" id="client-name" required class="mt-1 block w-full p-2 border border-gray-300 rounded-md">
                     </div>
                     <div>
                         <label for="client-phone" class="block text-sm font-medium text-gray-700">Celular:</label>
                         <input type="tel" id="client-phone" class="mt-1 block w-full p-2 border border-gray-300 rounded-md">
                     </div>
                     <div>
                         <label for="client-email" class="block text-sm font-medium text-gray-700">Email:</label>
                         <input type="email" id="client-email" class="mt-1 block w-full p-2 border border-gray-300 rounded-md">
                     </div>
                     <div class="flex space-x-2">
                         <button type="submit" class="action-button bg-green-500 hover:bg-green-600 text-white">Guardar Cliente</button>
                         <button type="button" onclick="resetClientForm()" class="action-button bg-gray-500 hover:bg-gray-600 text-white">Cancelar</button>
                     </div>
                     <div id="client-form-feedback" class="mt-2 text-sm feedback"></div>
                 </form>
                 <div class="overflow-x-auto">
                     <table id="clients-table" class="admin-table">
                         <thead>
                             <tr>
                                 <th>Nombre</th>
                                 <th>Celular</th>
                                 <th>Email</th>
                                 <th class="no-print">Acciones</th>
                             </tr>
                         </thead>
                         <tbody><!-- Data will be loaded here by JS --></tbody>
                     </table>
                 </div>
            </section>

            <!-- Jobs Section (Admin Only) -->
            <section id="jobs" class="tab-content admin-only bg-white p-6 rounded-lg shadow-lg">
                 <h2 class="text-2xl font-bold mb-6 text-center text-blue-600">Gestión de Trabajos</h2>
                  <div class="mb-4 text-center no-print">
                      <button onclick="setActiveTab(document.querySelector('[data-target=new-job-form]')); resetJobForm();" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded">
                          + Nuevo Trabajo
                      </button>
                  </div>
                  <div class="overflow-x-auto">
                     <table id="jobs-table" class="admin-table">
                         <thead>
                             <tr>
                                 <th>Cliente</th>
                                 <th>Detalles</th>
                                 <th>F. Pedido</th>
                                 <th>F. Entrega</th>
                                 <th>Estado</th>
                                 <th class="text-right">Total ($)</th> <!-- Align right -->
                                 <th class="text-right">Seña ($)</th> <!-- Align right -->
                                 <th class="text-right">Pendiente ($)</th> <!-- Align right -->
                                 <th class="no-print">Acciones</th>
                             </tr>
                         </thead>
                         <tbody><!-- Data will be loaded here by JS --></tbody>
                     </table>
                 </div>
            </section>

            <!-- New/Edit Job Form Section (Admin Only) -->
            <section id="new-job-form" class="tab-content admin-only bg-white p-6 rounded-lg shadow-lg">
                <h2 id="job-form-title" class="text-2xl font-bold mb-6 text-center text-blue-600">Nuevo Trabajo</h2>
                <form id="job-form" class="space-y-4">
                    <input type="hidden" id="job-id">
                    <div>
                        <label for="job-client" class="block text-sm font-medium text-gray-700">Cliente:</label>
                        <select id="job-client" required class="mt-1 block w-full p-2 border border-gray-300 rounded-md">
                            <option value="">Selecciona un cliente...</option>
                            <!-- Options loaded by JS -->
                        </select>
                        <p class="text-xs text-gray-500 mt-1 no-print">Añade clientes nuevos en la pestaña "Clientes".</p>
                    </div>
                    <div>
                        <label for="job-details" class="block text-sm font-medium text-gray-700">Detalles del Trabajo:</label>
                        <textarea id="job-details" rows="3" required class="mt-1 block w-full p-2 border border-gray-300 rounded-md"></textarea>
                    </div>
                    <!-- Cotización -->
                    <div class="border p-4 rounded bg-gray-50 space-y-3">
                         <h3 class="text-md font-semibold text-gray-800">Detalles de Cotización</h3>
                         <div>
                             <label for="job-material" class="block text-sm font-medium text-gray-700">Material:</label>
                             <select id="job-material" required class="mt-1 block w-full p-2 border border-gray-300 rounded-md">
                                 <option value="">Selecciona material...</option>
                                 <!-- Options loaded by JS -->
                             </select>
                         </div>
                         <div class="grid grid-cols-2 gap-4">
                             <div>
                                 <label for="job-length" class="block text-sm font-medium text-gray-700">Largo (mm):</label>
                                 <input type="number" id="job-length" required min="1" class="mt-1 block w-full p-2 border border-gray-300 rounded-md">
                             </div>
                             <div>
                                 <label for="job-width" class="block text-sm font-medium text-gray-700">Ancho (mm):</label>
                                 <input type="number" id="job-width" required min="1" class="mt-1 block w-full p-2 border border-gray-300 rounded-md">
                             </div>
                         </div>
                         <div>
                             <label for="job-job-type" class="block text-sm font-medium text-gray-700">Tipo Trabajo:</label>
                             <select id="job-job-type" required class="mt-1 block w-full p-2 border border-gray-300 rounded-md">
                                 <option value="corte">Solo Corte</option>
                                 <option value="grabado">Solo Grabado</option>
                                 <option value="ambos">Corte y Grabado</option>
                             </select>
                         </div>
                         <div id="job-time-estimation" class="space-y-2">
                             <p class="text-xs text-gray-600 no-print">Estimar minutos de máquina:</p>
                             <div id="job-cut-time-field" class="grid grid-cols-2 gap-2 items-center">
                                 <label for="job-cut-minutes" class="text-sm font-medium text-gray-700">Min. Corte:</label>
                                 <input type="number" id="job-cut-minutes" min="0" value="0" class="block w-full p-1 border border-gray-300 rounded-md text-sm">
                             </div>
                             <div id="job-engrave-time-field" class="grid grid-cols-2 gap-2 items-center">
                                 <label for="job-engrave-minutes" class="text-sm font-medium text-gray-700">Min. Grabado:</label>
                                 <input type="number" id="job-engrave-minutes" min="0" value="0" class="block w-full p-1 border border-gray-300 rounded-md text-sm">
                             </div>
                         </div>
                         <button type="button" onclick="calculateJobQuote()" class="w-full bg-indigo-500 hover:bg-indigo-600 text-white text-sm font-bold py-1 px-3 rounded no-print">Calcular Costo Base y Final</button>
                         <div id="job-quote-base-result" class="mt-1 text-sm text-gray-600 font-medium">Costo Base Estimado: $0.00</div>
                    </div>
                    <!-- Fechas y Estado -->
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                         <div>
                             <label for="job-order-date" class="block text-sm font-medium text-gray-700">Fecha Pedido:</label>
                             <input type="date" id="job-order-date" required class="mt-1 block w-full p-2 border border-gray-300 rounded-md">
                         </div>
                         <div>
                             <label for="job-delivery-date" class="block text-sm font-medium text-gray-700">Fecha Entrega:</label>
                             <input type="date" id="job-delivery-date" required class="mt-1 block w-full p-2 border border-gray-300 rounded-md">
                         </div>
                         <div>
                             <label for="job-status" class="block text-sm font-medium text-gray-700">Estado:</label>
                             <select id="job-status" required class="mt-1 block w-full p-2 border border-gray-300 rounded-md">
                                 <option value="Encargado">Encargado</option>
                                 <option value="Procesando">Procesando</option>
                                 <option value="Terminado">Terminado</option>
                             </select>
                         </div>
                    </div>
                    <!-- Costos Finales -->
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                         <div>
                             <label for="job-final-cost" class="block text-sm font-medium text-gray-700">Total Trabajo ($) (Auto-calculado):</label>
                             <input type="number" id="job-final-cost" required min="0" step="0.01" readonly class="mt-1 block w-full p-2 border border-gray-300 rounded-md bg-gray-100">
                             <p class="text-xs text-gray-500 mt-1 no-print">Se calcula al presionar "Calcular Costo Base y Final".</p>
                         </div>
                         <div>
                             <label for="job-deposit" class="block text-sm font-medium text-gray-700">Seña ($):</label>
                             <input type="number" id="job-deposit" min="0" step="0.01" value="0" required class="mt-1 block w-full p-2 border border-gray-300 rounded-md">
                         </div>
                    </div>
                    <!-- Observaciones -->
                    <div>
                        <label for="job-observations" class="block text-sm font-medium text-gray-700">Observaciones:</label>
                        <textarea id="job-observations" rows="3" class="mt-1 block w-full p-2 border border-gray-300 rounded-md"></textarea>
                    </div>
                    <!-- Botones Formulario -->
                     <div class="flex space-x-2 pt-4 no-print">
                        <button type="submit" class="action-button bg-green-500 hover:bg-green-600 text-white">Guardar Trabajo</button>
                        <button type="button" onclick="setActiveTab(document.querySelector('[data-target=jobs]')); resetJobForm();" class="action-button bg-gray-500 hover:bg-gray-600 text-white">Cancelar</button>
                    </div>
                    <div id="job-form-feedback" class="mt-2 text-sm feedback"></div>
                </form>
            </section>

             <!-- Deadlines Section (Admin Only) -->
            <section id="deadlines" class="tab-content admin-only bg-white p-6 rounded-lg shadow-lg">
                 <h2 class="text-2xl font-bold mb-6 text-center text-blue-600">Plazos de Entrega Próximos (No Terminados)</h2>
                 <div class="overflow-x-auto">
                     <table id="deadlines-table" class="admin-table">
                         <thead><tr><th>Cliente</th><th>Detalles</th><th>F. Pedido</th><th>F. Entrega</th><th>Estado</th><th>Días Restantes</th></tr></thead>
                         <tbody><!-- Data will be loaded here by JS --></tbody>
                     </table>
                 </div>
            </section>

            <!-- Status Section (Admin Only) -->
            <section id="status" class="tab-content admin-only bg-white p-6 rounded-lg shadow-lg">
                 <h2 class="text-2xl font-bold mb-6 text-center text-blue-600">Estado de Trabajos</h2>
                  <div class="overflow-x-auto">
                     <table id="status-table" class="admin-table">
                         <thead><tr><th>Cliente</th><th>Detalles</th><th>Estado</th><th>F. Entrega</th></tr></thead>
                         <tbody><!-- Data will be loaded here by JS --></tbody>
                     </table>
                 </div>
            </section>

            <!-- Reports Section (Admin Only) -->
            <section id="reports" class="tab-content admin-only bg-white p-6 rounded-lg shadow-lg">
                 <h2 class="text-2xl font-bold mb-6 text-center text-blue-600">Informes Generales</h2>
                 <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6 text-center">
                     <div class="bg-blue-100 p-4 rounded shadow"><h3 class="font-semibold text-blue-800">Total Facturado</h3><p id="report-total-value" class="text-2xl font-bold">$0.00</p></div>
                     <div class="bg-green-100 p-4 rounded shadow"><h3 class="font-semibold text-green-800">Total Señado</h3><p id="report-total-deposit" class="text-2xl font-bold">$0.00</p></div>
                     <div class="bg-red-100 p-4 rounded shadow"><h3 class="font-semibold text-red-800">Total Pendiente</h3><p id="report-total-outstanding" class="text-2xl font-bold">$0.00</p></div>
                 </div>
                 <h3 class="text-xl font-semibold mb-4">Detalle Pendiente por Cliente</h3>
                  <div class="overflow-x-auto">
                     <table id="outstanding-table" class="admin-table">
                         <thead><tr><th>Cliente</th><th class="text-right">Total Trabajos ($)</th><th class="text-right">Total Señado ($)</th><th class="text-right">Pendiente ($)</th></tr></thead>
                         <tbody><!-- Data will be loaded here by JS --></tbody>
                     </table>
                 </div>
            </section>

            <!-- Materials Section (SuperAdmin Only) -->
            <section id="admin-materials" class="tab-content superadmin-only bg-white p-6 rounded-lg shadow-lg">
                 <h2 class="text-2xl font-bold mb-6 text-center text-purple-600">Gestionar Materiales</h2>
                 <form id="material-form-admin" class="bg-gray-50 p-4 rounded border border-gray-200 space-y-3 mb-6 no-print">
                     <h4 id="material-form-title-admin" class="text-lg font-medium">Añadir Material</h4>
                     <input type="hidden" id="material-id-admin">
                     <div><label for="material-name-admin" class="block text-sm font-medium text-gray-700">Nombre:</label><input type="text" id="material-name-admin" required class="mt-1 block w-full p-2 border border-gray-300 rounded-md"></div>
                     <div><label for="material-thickness-admin" class="block text-sm font-medium text-gray-700">Grosor(mm):</label><input type="number" id="material-thickness-admin" required min="0.1" step="0.1" class="mt-1 block w-full p-2 border border-gray-300 rounded-md"></div>
                     <div><label for="material-cost-admin" class="block text-sm font-medium text-gray-700">Costo/Plancha($):</label><input type="number" id="material-cost-admin" required min="0" step="0.01" class="mt-1 block w-full p-2 border border-gray-300 rounded-md"></div>
                     <div><label for="material-width-admin" class="block text-sm font-medium text-gray-700">Ancho Plancha(mm):</label><input type="number" id="material-width-admin" placeholder="1300" value="1300" min="1" class="mt-1 block w-full p-2 border border-gray-300 rounded-md"></div>
                     <div><label for="material-height-admin" class="block text-sm font-medium text-gray-700">Alto Plancha(mm):</label><input type="number" id="material-height-admin" placeholder="900" value="900" min="1" class="mt-1 block w-full p-2 border border-gray-300 rounded-md"></div>
                     <div><label class="flex items-center"><input type="checkbox" id="material-availability-admin" checked class="rounded border-gray-300 text-purple-600 shadow-sm focus:border-purple-300 focus:ring focus:ring-purple-200 focus:ring-opacity-50"> <span class="ml-2 text-sm text-gray-600">Disponible para cotizar</span></label></div>
                     <div class="flex space-x-2"><button type="submit" class="action-button bg-green-500 hover:bg-green-600 text-white">Guardar</button><button type="button" onclick="resetMaterialFormAdmin()" class="action-button bg-gray-500 hover:bg-gray-600 text-white">Cancelar</button></div>
                     <div id="material-form-feedback-admin" class="mt-2 text-sm feedback"></div>
                 </form>
                 <div class="overflow-x-auto">
                     <table id="materials-admin-table" class="admin-table">
                         <thead><tr><th>Nombre</th><th class="text-right">Grosor(mm)</th><th class="text-right">Costo/Plancha($)</th><th class="text-center">Dimensiones(mm)</th><th class="text-center">Disp.</th><th class="no-print">Acciones</th></tr></thead>
                         <tbody><!-- Data will be loaded here by JS --></tbody>
                     </table>
                 </div>
            </section>

            <!-- Config Section (SuperAdmin Only) -->
            <section id="admin-config" class="tab-content superadmin-only bg-white p-6 rounded-lg shadow-lg">
                 <h2 class="text-2xl font-bold mb-6 text-center text-purple-600">Configuración de Costos</h2>
                 <form id="config-form-admin" class="bg-gray-50 p-4 rounded border border-gray-200 space-y-3 no-print">
                      <h4 class="text-lg font-medium">Costos Mensuales y Parámetros de Cálculo</h4>
                      <p class="text-xs text-gray-600">Estos valores se usan para calcular el costo base por minuto de máquina.</p>
                      <div>
                        <label for="config-minutes-admin" class="block text-sm font-medium text-gray-700">Minutos Productivos Estimados/Mes:</label>
                        <input type="number" id="config-minutes-admin" required min="1" value="2400" class="mt-1 block w-full p-2 border border-gray-300 rounded-md">
                        <p class="text-xs text-gray-500 mt-1">Ej: 8hs/día * 20 días/mes * 60 min/hr * 25% uso = 2400 min</p>
                      </div>
                      <fieldset id="monthly-costs-fieldset-admin" class="border p-3 rounded">
                          <legend class="text-sm font-medium px-1">Costos Fijos Mensuales ($)</legend>
                          <div id="monthly-costs-container" class="grid grid-cols-1 md:grid-cols-2 gap-x-4 gap-y-2">
                              <!-- Cost inputs will be loaded/added here by JS -->
                          </div>
                          <button type="button" onclick="addMonthlyCostInput()" class="mt-2 text-sm text-purple-600 hover:text-purple-800">+ Añadir Otro Costo</button>
                      </fieldset>
                      <div class="mt-4 pt-4 border-t">
                        <h4 class="text-md font-medium">Costo por Minuto Calculado:</h4>
                        <p id="calculated-cost-per-minute" class="text-lg font-bold text-purple-700">$0.0000 / min</p>
                      </div>
                      <button type="submit" class="action-button bg-green-500 hover:bg-green-600 text-white mt-4">Guardar Configuración</button>
                      <div id="config-form-feedback-admin" class="mt-2 text-sm feedback"></div>
                 </form>
            </section>

        </main>

        <!-- Print Area Wrapper (Hidden by default, contains print-area) -->
        <div id="print-area-wrapper" aria-hidden="true" class="absolute left-[-9999px] top-auto w-[1px] h-[1px] overflow-hidden bg-white">
            <div id="print-area">
                <!-- Ticket/Section content will be injected here by JS for printing -->
            </div>
        </div>


        <footer class="text-center text-gray-500 text-sm mt-8 no-print">
            © <span id="current-year"></span> Presupuestos Corte Laser. Todos los derechos reservados.
        </footer>

    </div>

    <!-- ****** START OF JAVASCRIPT ****** -->
    <script>
        // --- Configuración de Firebase ---
        // IMPORTANTE: Reemplaza con tu configuración real y ASEGURA tu API Key
        // NUNCA expongas API keys sin restricciones en código público.
        const firebaseConfig = {
            apiKey: "AIzaSyAVBHUX8Ey9lLUCiz6mNDOemrNfrR-3Szs",
            authDomain: "presupuestadorcortelaser.firebaseapp.com",
            projectId: "presupuestadorcortelaser",
            storageBucket: "presupuestadorcortelaser.firebasestorage.app",
            messagingSenderId: "159566854109",
            appId: "1:159566854109:web:8d7351cef717697f3ea834"
        };

        // --- Inicialización de Firebase ---
        try {
            firebase.initializeApp(firebaseConfig);
            const db = firebase.firestore();
            const auth = firebase.auth();
             console.log("Firebase inicializado correctamente.");
        } catch (error) {
            console.error("Error inicializando Firebase:", error);
            alert("Error crítico: No se pudo inicializar la conexión con la base de datos. La aplicación no funcionará correctamente.");
             // Podrías deshabilitar la UI o mostrar un mensaje más prominente aquí
        }


        // --- ID del Super Administrador ---
        const SUPER_ADMIN_UID = 'WirMlSEvm5UdlAkns4KNr7ND0wr1'; // <-- REEMPLAZA con el UID real del Super Admin

        // --- Variables Globales ---
        let materialsData = {}; // Cache for materials { id: data }
        let configData = { cost_per_minute: 0, minutes_per_month: 2400, monthly_costs: {} }; // Default/Cache config
        let clientsData = {}; // Cache for clients { id: data }
        let jobsData = []; // Cache for jobs [ { id: data } ]
        let currentUser = null;
        let currentUserRole = null; // null, 'operator', 'superadmin'
        let currentJobQuoteBaseCost = 0; // Base cost calculated for the current job form
        let dataLoaded = { clients: false, jobs: false, materials: false, config: false };
        let activeSectionId = 'home'; // Track active section/tab

        // --- Navegación por Pestañas ---
        function setActiveTab(buttonElement) {
            if (!buttonElement) {
                console.error("setActiveTab: Intento de activar tab con elemento nulo.");
                return;
            }
            const targetId = buttonElement.getAttribute('data-target');
            if (!targetId) {
                console.error("setActiveTab: Botón de tab sin data-target:", buttonElement);
                return;
            }

            console.log("Activando tab:", targetId);
            activeSectionId = targetId; // Update global tracker

            // Ocultar todos los contenidos y quitar active de botones
            document.querySelectorAll('#tab-content-container .tab-content').forEach(content => content.classList.remove('active-tab-content', 'printing-now'));
            document.querySelectorAll('#tab-buttons .tab-button').forEach(button => button.classList.remove('active-tab'));

            // Mostrar el contenido correcto
            const sectionToShow = document.getElementById(targetId);
            if (sectionToShow) {
                sectionToShow.classList.add('active-tab-content');
                buttonElement.classList.add('active-tab');
                loadDataForSection(targetId); // Cargar datos si es necesario
            } else {
                console.error(`setActiveTab: Contenido para '${targetId}' no encontrado.`);
                // Fallback a una pestaña segura si la destino no existe
                 const defaultButton = document.querySelector('#tab-buttons .tab-button[data-target="jobs"]'); // Default logged-in tab
                 if (defaultButton) setActiveTab(defaultButton);
            }
        }

        function showLoginSection() {
             console.log("Mostrando sección de login");
             activeSectionId = 'login';
             // Ocultar todos los contenidos de pestañas principales
            document.querySelectorAll('#tab-content-container .tab-content').forEach(content => {
                content.classList.remove('active-tab-content', 'printing-now');
            });
             // Quitar clase activa de todos los botones de pestaña
            document.querySelectorAll('#tab-buttons .tab-button').forEach(button => {
                button.classList.remove('active-tab');
            });
             // Mostrar solo el login
             const loginSection = document.getElementById('login');
             if(loginSection) {
                 loginSection.classList.add('active-tab-content');
             } else {
                 console.error("showLoginSection: Sección #login no encontrada");
             }
             // Limpiar campos de login y error
             const loginForm = document.getElementById('login-form');
             if(loginForm) loginForm.reset();
             const errorDiv = document.getElementById('login-error');
             if(errorDiv) errorDiv.textContent = '';
         }

        // --- Autenticación y Roles ---
        auth?.onAuthStateChanged(user => { // Check if auth exists
            if (!auth) {
                 console.error("Auth service not available.");
                 showLoginSection(); // Show login as fallback
                 return;
            }

            console.log("Auth state changed. User:", user ? user.uid : 'null');
            currentUser = user;
            const userEmailSpan = document.getElementById('user-email');
            document.body.classList.remove('logged-in', 'role-superadmin', 'role-operator', 'public-only');

            if (user) {
                currentUserRole = (user.uid === SUPER_ADMIN_UID) ? 'superadmin' : 'operator';
                console.log("User logged in. Role:", currentUserRole);
                document.body.classList.add('logged-in', `role-${currentUserRole}`);
                if (userEmailSpan) userEmailSpan.textContent = user.email;

                // Cargar datos esenciales al iniciar sesión
                loadInitialDataForLoggedInUser().then(() => {
                    console.log("Initial data loaded for logged-in user.");
                    // Determinar a qué pestaña ir después del login
                    const defaultTab = 'jobs'; // Pestaña por defecto para usuarios logueados
                    const targetButton = document.querySelector(`#tab-buttons .tab-button[data-target="${defaultTab}"]`);

                    if (targetButton) {
                        setActiveTab(targetButton);
                    } else {
                        console.error("onAuthStateChanged: Botón para tab por defecto 'jobs' no encontrado.");
                        // Fallback si 'jobs' no existe por alguna razón
                        const firstVisibleButton = document.querySelector('#tab-buttons .tab-button:not(.superadmin-only)');
                         if (firstVisibleButton) setActiveTab(firstVisibleButton);
                         else { // Superadmin solo puede ver superadmin tabs?
                             const firstSuperButton = document.querySelector('#tab-buttons .tab-button.superadmin-only');
                             if (firstSuperButton) setActiveTab(firstSuperButton);
                             else console.error("onAuthStateChanged: No se encontró ninguna pestaña para activar.");
                         }
                    }
                }).catch(error => {
                    console.error("Error cargando datos iniciales post-login:", error);
                    // Mostrar error en un lugar visible, quizás el feedback del form de trabajos
                    const jobFeedback = document.getElementById('job-form-feedback');
                    if (jobFeedback) showFeedback(jobFeedback, 'Error crítico al cargar datos iniciales. Intente recargar.', 'error');
                    else alert("Error crítico al cargar datos iniciales. Intente recargar la página.");
                });

            } else {
                console.log("User logged out or not logged in.");
                currentUserRole = null;
                document.body.classList.add('public-only');
                if (userEmailSpan) userEmailSpan.textContent = '';
                // Limpiar datos cacheados al desloguear
                materialsData = {}; clientsData = {}; jobsData = []; configData = { cost_per_minute: 0, minutes_per_month: 2400, monthly_costs: {} };
                dataLoaded = { clients: false, jobs: false, materials: false, config: false };

                // Mostrar la sección 'home'
                document.querySelectorAll('#tab-content-container .tab-content').forEach(content => content.classList.remove('active-tab-content', 'printing-now'));
                document.querySelectorAll('#tab-buttons .tab-button').forEach(button => button.classList.remove('active-tab'));
                const homeSection = document.getElementById('home');
                if (homeSection) {
                    homeSection.classList.add('active-tab-content');
                    activeSectionId = 'home';
                } else {
                     console.error("onAuthStateChanged: Sección #home no encontrada para usuario deslogueado.");
                }
            }
        });

        // --- Login / Logout ---
        document.getElementById('login-form')?.addEventListener('submit', async (e) => {
            e.preventDefault();
             if (!auth) { console.error("Auth service not available for login."); return; }

            const email = document.getElementById('login-email').value;
            const password = document.getElementById('login-password').value;
            const errorDiv = document.getElementById('login-error');
            if(errorDiv) errorDiv.textContent = ''; // Clear previous errors

            try {
                console.log("Intentando iniciar sesión con:", email);
                await auth.signInWithEmailAndPassword(email, password);
                console.log("Inicio de sesión exitoso.");
                // onAuthStateChanged se encargará del resto (UI update, data load)
            } catch (error) {
                console.error("Error de login:", error.code, error.message);
                if(errorDiv) {
                    if (error.code === 'auth/user-not-found' || error.code === 'auth/wrong-password' || error.code === 'auth/invalid-credential') {
                         errorDiv.textContent = 'Email o contraseña incorrectos.';
                    } else if (error.code === 'auth/invalid-email') {
                        errorDiv.textContent = 'El formato del email es inválido.';
                    } else {
                        errorDiv.textContent = 'Error al iniciar sesión. Verifique la conexión.'; // Mensaje genérico
                    }
                }
            }
        });

        function logoutUser() {
             if (!auth) { console.error("Auth service not available for logout."); return; }
            console.log("Cerrando sesión...");
            auth.signOut().then(() => {
                console.log("Sesión cerrada exitosamente.");
                // onAuthStateChanged manejará el cambio de UI a estado público/home
            }).catch(error => {
                console.error("Error al cerrar sesión:", error);
                alert("Error al cerrar sesión: " + error.message);
            });
        }

        // --- Carga de Datos ---
        async function loadInitialDataForLoggedInUser() {
            // Verifica si db está disponible antes de cargar
             if (!db) {
                 console.error("loadInitialDataForLoggedInUser: Firestore service (db) no disponible.");
                 throw new Error("La base de datos no está disponible.");
             }

            console.log("loadInitialDataForLoggedInUser: Cargando datos esenciales (materials, config, clients)...");
            const loadPromises = [
                loadMaterials(), // Necesario para cotizar
                loadConfig(),    // Necesario para cotizar
                loadClients()    // Necesario para seleccionar cliente en nuevo trabajo
            ];
            await Promise.all(loadPromises);
            console.log("loadInitialDataForLoggedInUser: Datos esenciales cargados.");
        }

        function loadDataForSection(sectionId) {
            // Verifica si db está disponible
             if (!db) {
                 console.error(`loadDataForSection: Firestore service (db) no disponible al intentar cargar datos para ${sectionId}.`);
                 // Podría mostrar un error al usuario aquí
                 return;
             }
            // Carga datos bajo demanda al entrar a una sección, evitando recargas innecesarias
            // pero permitiendo refrescar datos que cambian (como trabajos)
            console.log(`loadDataForSection: Verificando datos para ${sectionId}`);
            if (!currentUser) {
                console.warn(`loadDataForSection: Intento de cargar datos para ${sectionId} sin usuario logueado.`);
                return; // No cargar datos si no está logueado
            }

            switch(sectionId) {
                case 'clients':
                    if (!dataLoaded.clients) loadClients();
                    else populateClientsTable(); // Repopular por si acaso
                    break;
                case 'jobs':
                    loadJobs(); // Siempre recargar trabajos al ver la tabla principal
                    break;
                 case 'deadlines':
                    if (!dataLoaded.jobs) loadJobs().then(populateDeadlinesTable);
                    else populateDeadlinesTable();
                    break;
                 case 'status':
                     if (!dataLoaded.jobs) loadJobs().then(populateStatusTable);
                     else populateStatusTable();
                     break;
                 case 'reports':
                     if (!dataLoaded.jobs) loadJobs().then(generateReports);
                     else generateReports();
                     break;
                case 'new-job-form':
                     const clientPromise = dataLoaded.clients ? Promise.resolve() : loadClients();
                     const materialPromise = dataLoaded.materials ? Promise.resolve() : loadMaterials();
                     Promise.all([clientPromise, materialPromise]).then(() => {
                         populateClientDropdown('job-client');
                         populateMaterialDropdown('job-material');
                     }).catch(err => console.error("Error cargando datos para New Job Form:", err));
                     resetJobForm(); // Limpiar el formulario cada vez que se entra
                    break;
                case 'admin-materials':
                    if (currentUserRole === 'superadmin') {
                        if (!dataLoaded.materials) loadMaterials();
                        else populateMaterialsAdminTable();
                    }
                    break;
                case 'admin-config':
                    if (currentUserRole === 'superadmin') {
                        if (!dataLoaded.config) loadConfig();
                        else populateConfigFormAdmin();
                    }
                    break;
                 default:
                     console.log(`loadDataForSection: No hay carga de datos definida para ${sectionId}`);
            }
        }

        async function loadMaterials() {
             if (!db) { console.error("loadMaterials: db no disponible."); return; }
            console.log("Cargando materiales...");
             try {
                 const snapshot = await db.collection('materials').orderBy('name').get();
                 const tempData = {};
                 snapshot.forEach(doc => {
                     tempData[doc.id] = { ...doc.data(), id: doc.id };
                 });
                 materialsData = tempData;
                 console.log(`Materiales cargados: ${Object.keys(materialsData).length}`);
                 dataLoaded.materials = true;
                 populateMaterialDropdown('job-material');
                 if (currentUserRole === 'superadmin') populateMaterialsAdminTable();
             } catch (error) {
                 console.error("Error cargando materiales:", error);
                 const feedback = document.getElementById('material-form-feedback-admin');
                 if (feedback) showFeedback(feedback, `Error al cargar materiales: ${error.message}`, 'error');
                 dataLoaded.materials = false;
             }
         }

        async function loadConfig() {
             if (!db) { console.error("loadConfig: db no disponible."); return; }
            console.log("Cargando configuración...");
             try {
                const configDoc = await db.collection('config').doc('main').get();
                if (configDoc.exists) {
                    const data = configDoc.data();
                    configData = {
                        minutes_per_month: data.minutes_per_month || 2400,
                        monthly_costs: data.monthly_costs || {},
                        cost_per_minute: 0 // Se recalculará
                    };
                    const totalMonthly = Object.values(configData.monthly_costs)
                                            .reduce((sum, val) => sum + (Number(val) || 0), 0);
                    if (configData.minutes_per_month > 0) {
                        configData.cost_per_minute = totalMonthly / configData.minutes_per_month;
                    } else {
                        configData.cost_per_minute = 0;
                        console.warn("loadConfig: minutes_per_month es 0 o inválido, cost_per_minute será 0.");
                    }
                     console.log(`Config cargada. Costo/min calculado: $${configData.cost_per_minute.toFixed(4)}`);
                } else {
                    console.warn("Doc 'config/main' no encontrado. Usando valores por defecto.");
                     configData = { cost_per_minute: 0, minutes_per_month: 2400, monthly_costs: {} };
                }
                 dataLoaded.config = true;
                 if (currentUserRole === 'superadmin') populateConfigFormAdmin();
             } catch (error) {
                 console.error("Error cargando config:", error);
                  const feedback = document.getElementById('config-form-feedback-admin');
                 if (feedback) showFeedback(feedback, `Error al cargar config: ${error.message}`, 'error');
                 dataLoaded.config = false;
             }
         }

        async function loadClients() {
             if (!currentUser || !db) { console.warn("loadClients: No logueado o db no disponible."); return; }
            console.log("Cargando clientes...");
            const tableBody = document.getElementById('clients-table')?.querySelector('tbody');
            if(tableBody) tableBody.innerHTML = '<tr><td colspan="4" class="text-center py-4">Cargando clientes...</td></tr>';

            try {
                const snapshot = await db.collection('clients').orderBy('name', 'asc').get();
                const tempData = {};
                snapshot.forEach(doc => {
                    tempData[doc.id] = { ...doc.data(), id: doc.id };
                });
                clientsData = tempData;
                console.log(`Clientes cargados: ${Object.keys(clientsData).length}`);
                dataLoaded.clients = true;
                populateClientsTable();
                populateClientDropdown('job-client');

            } catch (error) {
                console.error("Error cargando clientes:", error);
                if(tableBody) tableBody.innerHTML = `<tr><td colspan="4" class="text-center py-4 text-red-600">Error al cargar clientes: ${error.message}</td></tr>`;
                dataLoaded.clients = false;
            }
        }

        async function loadJobs() {
             if (!currentUser || !db) { console.warn("loadJobs: No logueado o db no disponible."); return; }
             console.log("Cargando trabajos...");
             ['jobs-table', 'deadlines-table', 'status-table', 'outstanding-table'].forEach(id => {
                 const tableBody = document.getElementById(id)?.querySelector('tbody');
                 if(tableBody) {
                     const colspan = tableBody.closest('table').querySelector('thead th')?.length || 1;
                     tableBody.innerHTML = `<tr><td colspan="${colspan}" class="text-center py-4">Cargando trabajos...</td></tr>`;
                 }
             });
             ['report-total-value', 'report-total-deposit', 'report-total-outstanding'].forEach(id => {
                 const el = document.getElementById(id); if(el) el.textContent = 'Calculando...';
             });

             try {
                 const snapshot = await db.collection('jobs').orderBy('deliveryDate', 'asc').get();
                 const tempJobs = [];
                 snapshot.forEach(doc => {
                    const jobData = doc.data();
                    tempJobs.push({
                        ...jobData,
                        id: doc.id,
                        orderDate: jobData.orderDate instanceof firebase.firestore.Timestamp ? jobData.orderDate.toDate().toISOString().split('T')[0] : jobData.orderDate,
                        deliveryDate: jobData.deliveryDate instanceof firebase.firestore.Timestamp ? jobData.deliveryDate.toDate().toISOString().split('T')[0] : jobData.deliveryDate,
                        finalCost: Number(jobData.finalCost || 0),
                        deposit: Number(jobData.deposit || 0)
                     });
                 });
                 jobsData = tempJobs;
                 console.log(`Trabajos cargados: ${jobsData.length}`);
                 dataLoaded.jobs = true;
                 populateJobsTable();
                 populateDeadlinesTable();
                 populateStatusTable();
                 generateReports();

             } catch (error) {
                 console.error("Error cargando trabajos:", error);
                  ['jobs-table', 'deadlines-table', 'status-table', 'outstanding-table'].forEach(id => {
                     const tableBody = document.getElementById(id)?.querySelector('tbody');
                      if(tableBody) {
                          const colspan = tableBody.closest('table').querySelector('thead th')?.length || 1;
                          tableBody.innerHTML = `<tr><td colspan="${colspan}" class="text-center py-4 text-red-600">Error al cargar trabajos: ${error.message}</td></tr>`;
                      }
                 });
                  dataLoaded.jobs = false;
             }
         }

        // --- Poblado de Dropdowns ---
        function populateClientDropdown(selectId) {
             const select = document.getElementById(selectId);
             if (!select) return;
             const currentVal = select.value;
             select.innerHTML = '<option value="">Selecciona un cliente...</option>';
             const sortedClients = Object.values(clientsData).sort((a, b) => (a.name || "").localeCompare(b.name || ""));
             sortedClients.forEach(client => {
                 const option = document.createElement('option');
                 option.value = client.id;
                 option.textContent = client.name || `ID: ${client.id}`; // Fallback text
                 select.appendChild(option);
             });
             // Try to restore selection if possible
             if (Array.from(select.options).some(opt => opt.value === currentVal)) {
                 select.value = currentVal;
             }
         }

        function populateMaterialDropdown(selectId) {
             const select = document.getElementById(selectId);
             if (!select) return;
             const currentVal = select.value;
             select.innerHTML = '<option value="">Selecciona material...</option>';
             const availableMaterials = Object.values(materialsData)
                .filter(mat => mat.available !== false)
                .sort((a, b) => `${a.name || ''} ${a.thickness || 0}mm`.localeCompare(`${b.name || ''} ${b.thickness || 0}mm`));

             availableMaterials.forEach(mat => {
                 const option = document.createElement('option');
                 option.value = mat.id;
                 option.textContent = `${mat.name || 'Sin Nombre'} - ${mat.thickness || '?'}mm`;
                 select.appendChild(option);
             });
             if (Array.from(select.options).some(opt => opt.value === currentVal)) {
                 select.value = currentVal;
             }
         }

        // --- Poblado de Tablas ---
        function populateClientsTable() {
            const tableBody = document.getElementById('clients-table')?.querySelector('tbody');
            if (!tableBody) return;
            if (Object.keys(clientsData).length === 0 && dataLoaded.clients) {
                 tableBody.innerHTML = '<tr><td colspan="4" class="text-center py-4">No hay clientes registrados.</td></tr>';
                 return;
            }
            let rowsHtml = '';
            const sortedClients = Object.values(clientsData).sort((a, b) => (a.name || "").localeCompare(b.name || ""));
            sortedClients.forEach(client => {
                rowsHtml += `
                    <tr data-client-id="${client.id}">
                        <td>${client.name || 'N/A'}</td>
                        <td>${client.phone || '-'}</td>
                        <td>${client.email || '-'}</td>
                        <td class="no-print space-x-1 whitespace-nowrap">
                            <button onclick="editClient('${client.id}')" class="edit-button" title="Editar Cliente">Editar</button>
                            <button onclick="deleteClient('${client.id}')" class="delete-button" title="Borrar Cliente">Borrar</button>
                            <button onclick="selectClientForNewJob('${client.id}')" class="action-button bg-blue-500 hover:bg-blue-600 text-white" title="Crear Nuevo Trabajo para este Cliente">Nuevo Trabajo</button>
                        </td>
                    </tr>`;
            });
            tableBody.innerHTML = rowsHtml;
        }

        function populateJobsTable() {
             const tableBody = document.getElementById('jobs-table')?.querySelector('tbody');
             if (!tableBody) return;
             if (jobsData.length === 0 && dataLoaded.jobs) {
                 tableBody.innerHTML = '<tr><td colspan="9" class="text-center py-4">No hay trabajos registrados.</td></tr>';
                 return;
             }

             const sortedJobs = [...jobsData].sort((a, b) => (b.orderDate || "").localeCompare(a.orderDate || ""));

             let rowsHtml = '';
             sortedJobs.forEach(job => {
                 const clientName = clientsData[job.clientId]?.name || 'Cliente Borrado/Desconocido';
                 const finalCost = job.finalCost || 0;
                 const deposit = job.deposit || 0;
                 const outstanding = Math.max(0, finalCost - deposit);
                 const deliveryDate = job.deliveryDate ? parseDateForComparison(job.deliveryDate) : null;
                 const today = new Date(); today.setHours(0,0,0,0);
                 const isOverdue = deliveryDate && deliveryDate < today && job.status !== 'Terminado';

                 rowsHtml += `
                     <tr data-job-id="${job.id}">
                         <td>${clientName}</td>
                         <td class="max-w-xs truncate" title="${job.details || ''}">${job.details || '-'}</td>
                         <td>${formatDate(job.orderDate)}</td>
                         <td class="${isOverdue ? 'date-overdue' : ''}">${formatDate(job.deliveryDate)}</td>
                         <td><span class="${getStatusClass(job.status)}">${job.status || 'N/A'}</span></td>
                         <td class="text-right">${finalCost.toFixed(2)}</td>
                         <td class="text-right">${deposit.toFixed(2)}</td>
                         <td class="text-right font-semibold ${outstanding > 0.005 ? 'text-red-600' : 'text-green-600'}">${outstanding.toFixed(2)}</td>
                         <td class="no-print space-x-1 whitespace-nowrap">
                             <button onclick="editJob('${job.id}')" class="edit-button" title="Editar Trabajo">Editar</button>
                             <button onclick="deleteJob('${job.id}')" class="delete-button" title="Borrar Trabajo">Borrar</button>
                             <button onclick="printTicket('${job.id}')" class="print-button" title="Imprimir Ticket">Ticket</button>
                         </td>
                     </tr>`;
             });
             tableBody.innerHTML = rowsHtml;
         }

        function populateDeadlinesTable() {
            const tableBody = document.getElementById('deadlines-table')?.querySelector('tbody');
             if (!tableBody) return;
             if (jobsData.length === 0 && dataLoaded.jobs) {
                 tableBody.innerHTML = '<tr><td colspan="6" class="text-center py-4">No hay trabajos.</td></tr>';
                 return;
             }

             const today = new Date(); today.setHours(0, 0, 0, 0);
             const upcomingJobs = jobsData
                 .filter(job => job.status !== 'Terminado')
                 .sort((a, b) => (a.deliveryDate || "9999-12-31").localeCompare(b.deliveryDate || "9999-12-31"));

             if (upcomingJobs.length === 0) {
                  tableBody.innerHTML = '<tr><td colspan="6" class="text-center py-4">No hay trabajos pendientes con fecha de entrega.</td></tr>';
                 return;
             }

             let rowsHtml = '';
             upcomingJobs.forEach(job => {
                 const clientName = clientsData[job.clientId]?.name || 'Cliente Borrado/Desconocido';
                 const deliveryDate = job.deliveryDate ? parseDateForComparison(job.deliveryDate) : null;
                 let daysRemaining = '-';
                 let rowClass = '';

                 if (deliveryDate) {
                     const diffTime = deliveryDate.getTime() - today.getTime();
                     const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
                     daysRemaining = diffDays;
                      if (diffDays < 0) {
                          daysRemaining = `Vencido (${Math.abs(diffDays)})`;
                          rowClass = 'bg-red-100 date-overdue';
                      } else if (diffDays === 0) {
                          daysRemaining = 'Hoy';
                          rowClass = 'bg-yellow-100 font-semibold';
                      } else if (diffDays <= 3) {
                          daysRemaining = `${diffDays} día(s)`;
                           rowClass = 'bg-yellow-50';
                      } else {
                          daysRemaining = `${diffDays} días`;
                      }
                 }

                 rowsHtml += `
                     <tr data-job-id="${job.id}" class="${rowClass}">
                         <td>${clientName}</td>
                         <td class="max-w-xs truncate" title="${job.details || ''}">${job.details || '-'}</td>
                         <td>${formatDate(job.orderDate)}</td>
                         <td>${formatDate(job.deliveryDate)}</td>
                         <td><span class="${getStatusClass(job.status)}">${job.status || 'N/A'}</span></td>
                         <td>${daysRemaining}</td>
                     </tr>`;
             });
             tableBody.innerHTML = rowsHtml;
        }

        function populateStatusTable() {
             const tableBody = document.getElementById('status-table')?.querySelector('tbody');
             if (!tableBody) return;
             if (jobsData.length === 0 && dataLoaded.jobs) {
                 tableBody.innerHTML = '<tr><td colspan="4" class="text-center py-4">No hay trabajos.</td></tr>';
                 return;
             }

             const statusOrder = { 'Procesando': 1, 'Encargado': 2, 'Terminado': 3 };
             const sortedJobs = [...jobsData].sort((a, b) => {
                 const statusDiff = (statusOrder[a.status] || 99) - (statusOrder[b.status] || 99);
                 if (statusDiff !== 0) return statusDiff;
                 return (a.deliveryDate || "9999-12-31").localeCompare(b.deliveryDate || "9999-12-31");
             });

             let rowsHtml = '';
             sortedJobs.forEach(job => {
                 const clientName = clientsData[job.clientId]?.name || 'Cliente Borrado/Desconocido';
                  const deliveryDate = job.deliveryDate ? parseDateForComparison(job.deliveryDate) : null;
                  const today = new Date(); today.setHours(0,0,0,0);
                 const isOverdue = deliveryDate && deliveryDate < today && job.status !== 'Terminado';
                 rowsHtml += `
                     <tr data-job-id="${job.id}">
                         <td>${clientName}</td>
                          <td class="max-w-xs truncate" title="${job.details || ''}">${job.details || '-'}</td>
                         <td><span class="${getStatusClass(job.status)}">${job.status || 'N/A'}</span></td>
                         <td class="${isOverdue ? 'date-overdue' : ''}">${formatDate(job.deliveryDate)}</td>
                     </tr>`;
             });
             tableBody.innerHTML = rowsHtml;
         }

        function generateReports() {
            let totalValue = 0;
            let totalDeposit = 0;
            let clientTotals = {};

            jobsData.forEach(job => {
                const finalCost = job.finalCost || 0;
                const deposit = job.deposit || 0;
                totalValue += finalCost;
                totalDeposit += deposit;

                const clientId = job.clientId;
                // Skip if client ID is missing (shouldn't happen with validation)
                if (!clientId) return;

                if (!clientTotals[clientId]) {
                    clientTotals[clientId] = {
                        name: clientsData[clientId]?.name || `Cliente Desconocido (ID: ${clientId})`,
                        total: 0,
                        deposit: 0,
                        outstanding: 0
                    };
                }
                clientTotals[clientId].total += finalCost;
                clientTotals[clientId].deposit += deposit;
            });

            const totalOutstanding = totalValue - totalDeposit;

            document.getElementById('report-total-value').textContent = `$${totalValue.toFixed(2)}`;
            document.getElementById('report-total-deposit').textContent = `$${totalDeposit.toFixed(2)}`;
            document.getElementById('report-total-outstanding').textContent = `$${Math.max(0, totalOutstanding).toFixed(2)}`;

            const outstandingTableBody = document.getElementById('outstanding-table')?.querySelector('tbody');
            if (!outstandingTableBody) return;

            const clientsWithOutstanding = Object.values(clientTotals).map(client => {
                client.outstanding = Math.max(0, client.total - client.deposit);
                return client;
            }).filter(client => client.outstanding > 0.005)
              .sort((a, b) => b.outstanding - a.outstanding);

             if (clientsWithOutstanding.length === 0) {
                 outstandingTableBody.innerHTML = '<tr><td colspan="4" class="text-center py-4">Ningún cliente tiene saldo pendiente.</td></tr>';
                 return;
             }

            let rowsHtml = '';
            clientsWithOutstanding.forEach(client => {
                rowsHtml += `
                    <tr>
                        <td>${client.name}</td>
                        <td class="text-right">${client.total.toFixed(2)}</td>
                        <td class="text-right">${client.deposit.toFixed(2)}</td>
                        <td class="text-right font-semibold text-red-600">${client.outstanding.toFixed(2)}</td>
                    </tr>`;
            });
            outstandingTableBody.innerHTML = rowsHtml;
        }

        function populateMaterialsAdminTable() {
             if (currentUserRole !== 'superadmin') return;
             const tableBody = document.getElementById('materials-admin-table')?.querySelector('tbody');
             if (!tableBody) return;

             if (Object.keys(materialsData).length === 0 && dataLoaded.materials) {
                 tableBody.innerHTML = '<tr><td colspan="6" class="text-center py-4">No hay materiales definidos.</td></tr>';
                 return;
             }

             const sortedMaterials = Object.values(materialsData)
                 .sort((a, b) => {
                     const nameCompare = (a.name || "").localeCompare(b.name || "");
                     if (nameCompare !== 0) return nameCompare;
                     return (a.thickness || 0) - (b.thickness || 0);
                 });

             let rowsHtml = '';
             sortedMaterials.forEach(mat => {
                 const dimensions = (mat.width && mat.height) ? `${mat.width}x${mat.height}` : 'N/A';
                 const availableText = mat.available !== false ? 'Sí' : 'No';
                 const availableClass = mat.available !== false ? 'text-green-600' : 'text-red-600';
                 const cost = (mat.costPerSheet !== undefined ? mat.costPerSheet : mat.cost) || 0; // Handle both cost fields

                 rowsHtml += `
                     <tr data-material-id="${mat.id}">
                         <td>${mat.name || 'N/A'}</td>
                         <td class="text-right">${mat.thickness || '-'}</td>
                         <td class="text-right">${cost.toFixed(2)}</td>
                         <td class="text-center">${dimensions}</td>
                         <td class="text-center ${availableClass} font-semibold">${availableText}</td>
                         <td class="no-print space-x-1 whitespace-nowrap">
                             <button onclick="editMaterialAdmin('${mat.id}')" class="edit-button" title="Editar Material">Editar</button>
                             <button onclick="deleteMaterialAdmin('${mat.id}')" class="delete-button" title="Borrar Material">Borrar</button>
                         </td>
                     </tr>`;
             });
             tableBody.innerHTML = rowsHtml;
         }

        function populateConfigFormAdmin() {
             if (currentUserRole !== 'superadmin') return;
             console.log("Poblando form de config con:", configData);

             const minutesInput = document.getElementById('config-minutes-admin');
             const costsContainer = document.getElementById('monthly-costs-container');
             const calculatedCostP = document.getElementById('calculated-cost-per-minute');

             if (!minutesInput || !costsContainer || !calculatedCostP) {
                 console.error("populateConfigFormAdmin: No se encontraron elementos del formulario.");
                 return;
             }

             minutesInput.value = configData.minutes_per_month || 2400;
             costsContainer.innerHTML = ''; // Limpiar costos existentes

             const costs = configData.monthly_costs || {};
             if (Object.keys(costs).length === 0) {
                 addMonthlyCostInput('Ej: Alquiler', ''); // Add empty example if none exist
             } else {
                 // Sort keys alphabetically for consistent order
                 Object.keys(costs).sort().forEach(key => {
                     addMonthlyCostInput(key, costs[key]);
                 });
             }

             calculatedCostP.textContent = `$${(configData.cost_per_minute || 0).toFixed(4)} / min`;
         }

        // --- CRUD Clientes ---
        document.getElementById('client-form')?.addEventListener('submit', async (e) => {
            e.preventDefault();
             if (!db) { console.error("client-form submit: db no disponible."); return; }

            const clientId = document.getElementById('client-id').value;
            const name = document.getElementById('client-name').value.trim();
            const phone = document.getElementById('client-phone').value.trim();
            const email = document.getElementById('client-email').value.trim().toLowerCase(); // Save email in lowercase
            const feedbackDiv = document.getElementById('client-form-feedback');

            if (!name) {
                showFeedback(feedbackDiv, 'El nombre del cliente es obligatorio.', 'error');
                return;
            }
            // Optional: Simple email format validation
            if (email && !/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(email)) {
                showFeedback(feedbackDiv, 'El formato del email no es válido.', 'error');
                return;
            }

            const clientData = {
                name: name,
                phone: phone || null,
                email: email || null,
                // Consider adding/updating a timestamp
                // lastUpdated: firebase.firestore.FieldValue.serverTimestamp()
            };

            try {
                 showFeedback(feedbackDiv, 'Guardando...', 'info');
                 if (clientId) { // Editando
                     await db.collection('clients').doc(clientId).update(clientData);
                     showFeedback(feedbackDiv, 'Cliente actualizado con éxito.', 'success');
                     clientsData[clientId] = { ...clientsData[clientId], ...clientData };
                 } else { // Creando
                     // clientData.createdAt = firebase.firestore.FieldValue.serverTimestamp();
                     const docRef = await db.collection('clients').add(clientData);
                     showFeedback(feedbackDiv, 'Cliente añadido con éxito.', 'success');
                     clientsData[docRef.id] = { ...clientData, id: docRef.id };
                 }
                 resetClientForm();
                 populateClientsTable();
                 populateClientDropdown('job-client');
             } catch (error) {
                 console.error("Error guardando cliente:", error);
                 showFeedback(feedbackDiv, `Error al guardar: ${error.message}`, 'error');
             }
        });

        function editClient(id) {
            const client = clientsData[id];
            if (!client) {
                 console.error(`Cliente con ID ${id} no encontrado en cache.`);
                 showFeedback(document.getElementById('client-form-feedback'), `Error: Cliente ${id} no encontrado.`, 'error');
                 return;
            }
             resetClientForm(); // Clear form before populating
             document.getElementById('client-form-title').textContent = 'Editar Cliente';
             document.getElementById('client-id').value = client.id;
             document.getElementById('client-name').value = client.name || '';
             document.getElementById('client-phone').value = client.phone || '';
             document.getElementById('client-email').value = client.email || '';
             document.getElementById('client-name').focus();
             document.getElementById('client-form').scrollIntoView({ behavior: 'smooth', block: 'start' });
        }

        function resetClientForm() {
            document.getElementById('client-form-title').textContent = 'Añadir Nuevo Cliente';
            const form = document.getElementById('client-form');
            if (form) form.reset();
            const clientIdInput = document.getElementById('client-id');
            if(clientIdInput) clientIdInput.value = '';
             const feedbackDiv = document.getElementById('client-form-feedback');
             if (feedbackDiv) feedbackDiv.textContent = ''; feedbackDiv.className = 'mt-2 text-sm feedback';
        }

        async function deleteClient(id) {
             if (!db) { console.error("deleteClient: db no disponible."); return; }
            const clientName = clientsData[id]?.name || `ID ${id}`;

            // Check for associated jobs BEFORE confirming deletion
            const associatedJobs = jobsData.filter(job => job.clientId === id);
            let confirmationMessage = `¿Está seguro de querer borrar al cliente "${clientName}"?`;
            if (associatedJobs.length > 0) {
                confirmationMessage += `\n\n¡ADVERTENCIA! Este cliente tiene ${associatedJobs.length} trabajo(s) asociado(s). Borrar el cliente NO borrará los trabajos, pero quedarán sin cliente asignado.`;
            }
             confirmationMessage += "\n\nEsta acción no se puede deshacer.";

            if (!confirm(confirmationMessage)) {
                return;
            }

             const feedbackDiv = document.getElementById('client-form-feedback');
             try {
                  showFeedback(feedbackDiv, 'Borrando cliente...', 'info');
                 await db.collection('clients').doc(id).delete();
                 delete clientsData[id];
                 showFeedback(feedbackDiv, `Cliente "${clientName}" borrado.`, 'success');
                 populateClientsTable();
                 populateClientDropdown('job-client');
                  // Need to refresh jobs table etc. if client name was displayed there
                 if(jobsData.some(job => job.clientId === id)) {
                     populateJobsTable();
                     populateDeadlinesTable();
                     populateStatusTable();
                     generateReports();
                 }
                 // Clear form if this client was being edited
                 if (document.getElementById('client-id').value === id) {
                     resetClientForm();
                 }
             } catch (error) {
                 console.error("Error borrando cliente:", error);
                 showFeedback(feedbackDiv, `Error al borrar: ${error.message}`, 'error');
             }
        }

        function selectClientForNewJob(clientId) {
            const clientName = clientsData[clientId]?.name;
            if (!clientName) {
                console.error(`selectClientForNewJob: Cliente ${clientId} no encontrado.`);
                return;
            }
            console.log(`Seleccionado cliente ${clientName} (${clientId}) para nuevo trabajo.`);
             setActiveTab(document.querySelector('[data-target=new-job-form]'));
             // Wait briefly for tab change and potential dropdown population
             setTimeout(() => {
                 const clientSelect = document.getElementById('job-client');
                 if (clientSelect) {
                     resetJobForm(clientId); // Reset form but keep client selected
                     clientSelect.value = clientId; // Ensure it's set after reset
                     console.log(`Dropdown 'job-client' actualizado a ${clientId}`);
                     document.getElementById('job-details')?.focus();
                 } else {
                      console.error("selectClientForNewJob: Dropdown 'job-client' no encontrado tras cambiar de pestaña.");
                 }
             }, 150); // Slightly increased delay
        }

        // --- CRUD Trabajos ---

        document.getElementById('job-job-type')?.addEventListener('change', (e) => {
            const type = e.target.value;
            const cutField = document.getElementById('job-cut-time-field');
            const engraveField = document.getElementById('job-engrave-time-field');
            const cutInput = document.getElementById('job-cut-minutes');
            const engraveInput = document.getElementById('job-engrave-minutes');

            if (!cutField || !engraveField || !cutInput || !engraveInput) return;

            cutField.style.display = (type === 'corte' || type === 'ambos') ? 'grid' : 'none';
            engraveField.style.display = (type === 'grabado' || type === 'ambos') ? 'grid' : 'none';

            if (type === 'grabado') cutInput.value = 0;
            if (type === 'corte') engraveInput.value = 0;
        });

        function calculateJobQuote() {
            console.log("Calculando costo base...");
            const feedbackDiv = document.getElementById('job-form-feedback');
            const resultDiv = document.getElementById('job-quote-base-result');
            const finalCostInput = document.getElementById('job-final-cost');
            currentJobQuoteBaseCost = 0; // Reset global

            try {
                // Clear previous feedback/errors
                 showFeedback(feedbackDiv, '', 'info'); // Clear feedback

                // 1. Costo de Material
                const materialId = document.getElementById('job-material').value;
                const length = parseFloat(document.getElementById('job-length').value) || 0;
                const width = parseFloat(document.getElementById('job-width').value) || 0;
                let materialCost = 0;

                if (materialId && length > 0 && width > 0) {
                    const material = materialsData[materialId];
                    if (!material) throw new Error("Material seleccionado inválido o no cargado.");

                    const sheetCost = parseFloat( (material.costPerSheet !== undefined ? material.costPerSheet : material.cost) || 0);
                    const sheetWidth = parseFloat(material.width || 0);
                    const sheetHeight = parseFloat(material.height || 0);

                    if (sheetWidth <= 0 || sheetHeight <= 0) {
                         throw new Error(`Dimensiones de plancha inválidas (${sheetWidth}x${sheetHeight}mm) para el material "${material.name}". Verifique en Materiales.`);
                    }
                    const sheetArea = sheetWidth * sheetHeight;
                    const jobArea = length * width;

                    materialCost = (sheetCost / sheetArea) * jobArea;
                    console.log(`Material: ${material.name}, Costo Plancha: ${sheetCost.toFixed(2)}, Area Plancha: ${sheetArea} mm², Area Trabajo: ${jobArea} mm², Costo Material: ${materialCost.toFixed(2)}`);
                } else if (materialId && (length <= 0 || width <= 0)) {
                     // Don't throw error, just warn and proceed without material cost
                     console.warn("Dimensiones del trabajo (largo/ancho) inválidas para calcular costo de material.");
                     showFeedback(feedbackDiv, 'Advertencia: Ingrese largo y ancho válidos para incluir costo de material.', 'info');
                }

                // 2. Costo de Máquina
                const jobType = document.getElementById('job-job-type').value;
                const cutMinutes = (jobType === 'corte' || jobType === 'ambos') ? (parseFloat(document.getElementById('job-cut-minutes').value) || 0) : 0;
                const engraveMinutes = (jobType === 'grabado' || jobType === 'ambos') ? (parseFloat(document.getElementById('job-engrave-minutes').value) || 0) : 0;
                const totalMinutes = cutMinutes + engraveMinutes;
                let machineCost = 0;

                 if (configData.cost_per_minute === undefined || configData.cost_per_minute === null) {
                      throw new Error("El costo por minuto no está configurado o no se pudo cargar. Vaya a Configuración.");
                 }
                 if (configData.cost_per_minute <= 0 && totalMinutes > 0) {
                      console.warn("El costo por minuto es $0 o negativo. El costo de máquina será $0.");
                       // Append warning to feedback
                       let currentFeedback = feedbackDiv.textContent;
                       showFeedback(feedbackDiv, (currentFeedback ? currentFeedback + " " : "") + 'Advertencia: Costo por minuto es $0. Revise Configuración.', 'info');
                 }

                if (totalMinutes > 0) {
                    machineCost = totalMinutes * configData.cost_per_minute;
                    console.log(`Tiempo Máquina: ${totalMinutes} min (Corte: ${cutMinutes}, Grabado: ${engraveMinutes}), Costo/Min: ${configData.cost_per_minute.toFixed(4)}, Costo Máquina: ${machineCost.toFixed(2)}`);
                } else {
                    console.log("No se ingresaron minutos de máquina.");
                }

                // 3. Costo Base Total
                currentJobQuoteBaseCost = materialCost + machineCost;
                console.log(`Costo Base Total Calculado: ${currentJobQuoteBaseCost.toFixed(2)}`);

                // 4. Actualizar UI
                if (resultDiv) resultDiv.textContent = `Costo Base Estimado: $${currentJobQuoteBaseCost.toFixed(2)}`;
                if (finalCostInput) {
                     const finalCost = currentJobQuoteBaseCost * 2; // Ganancia 100%
                     finalCostInput.value = finalCost.toFixed(2);
                     console.log(`Costo Final (Base x 2): ${finalCost.toFixed(2)}`);
                      // Append success message to feedback
                      let currentFeedback = feedbackDiv.textContent.includes('Advertencia') ? feedbackDiv.textContent + " // " : "";
                      showFeedback(feedbackDiv, currentFeedback + `Costo base $${currentJobQuoteBaseCost.toFixed(2)}. Costo final actualizado a $${finalCost.toFixed(2)}.`, 'success');
                 } else {
                     showFeedback(feedbackDiv, `Costo base calculado: $${currentJobQuoteBaseCost.toFixed(2)}.`, 'success');
                 }

            } catch (error) {
                console.error("Error calculando costo:", error);
                currentJobQuoteBaseCost = 0;
                 if (resultDiv) resultDiv.textContent = 'Error al calcular';
                 if (finalCostInput) finalCostInput.value = '0.00';
                 showFeedback(feedbackDiv, `Error al calcular: ${error.message}`, 'error');
            }
        }

        document.getElementById('job-form')?.addEventListener('submit', async (e) => {
             e.preventDefault();
             if (!db) { console.error("job-form submit: db no disponible."); return; }

             const jobId = document.getElementById('job-id').value;
             const feedbackDiv = document.getElementById('job-form-feedback');
             showFeedback(feedbackDiv, '', 'info'); // Clear feedback

             const jobData = {
                 clientId: document.getElementById('job-client').value,
                 details: document.getElementById('job-details').value.trim(),
                 materialId: document.getElementById('job-material').value,
                 length: parseFloat(document.getElementById('job-length').value) || null,
                 width: parseFloat(document.getElementById('job-width').value) || null,
                 jobType: document.getElementById('job-job-type').value,
                 cutMinutes: parseFloat(document.getElementById('job-cut-minutes').value) || 0,
                 engraveMinutes: parseFloat(document.getElementById('job-engrave-minutes').value) || 0,
                 orderDate: document.getElementById('job-order-date').value,
                 deliveryDate: document.getElementById('job-delivery-date').value,
                 status: document.getElementById('job-status').value,
                 baseCost: currentJobQuoteBaseCost,
                 finalCost: parseFloat(document.getElementById('job-final-cost').value) || 0,
                 deposit: parseFloat(document.getElementById('job-deposit').value) || 0,
                 observations: document.getElementById('job-observations').value.trim() || null,
                 // timestamp field for sorting/querying might be useful
                 // lastUpdated: firebase.firestore.FieldValue.serverTimestamp()
             };

              // Validation
              let errors = [];
              if (!jobData.clientId) { errors.push('Debe seleccionar un cliente.'); }
              if (!jobData.details) { errors.push('Debe ingresar los detalles del trabajo.'); }
              if (!jobData.materialId) { errors.push('Debe seleccionar un material.'); }
              if (jobData.length <= 0 || jobData.width <= 0) { errors.push('Largo y Ancho deben ser números positivos.');}
              if (!jobData.orderDate) { errors.push('Debe ingresar la fecha de pedido.'); }
              if (!jobData.deliveryDate) { errors.push('Debe ingresar la fecha de entrega.'); }
              if (jobData.orderDate && jobData.deliveryDate && jobData.deliveryDate < jobData.orderDate) {
                   errors.push('La fecha de entrega no puede ser anterior a la fecha de pedido.');
              }
              if (jobData.finalCost < 0) { errors.push('El costo final no puede ser negativo.'); }
              if (jobData.deposit < 0) { errors.push('La seña no puede ser negativa.'); }
              if (jobData.deposit > jobData.finalCost) { errors.push('La seña no puede ser mayor al costo total.'); }
              if (jobData.finalCost <= 0 && currentJobQuoteBaseCost > 0) {
                  // Warn instead of blocking immediately
                  console.warn("Costo final es $0 o no calculado/actualizado.");
              }

             if (errors.length > 0) {
                 showFeedback(feedbackDiv, errors.join(' '), 'error');
                 return;
             }

             // Final confirmation if cost is 0
             if (jobData.finalCost <= 0 && !confirm("El costo final es $0. ¿Está seguro de querer guardar el trabajo así?")) {
                 return;
             }

             try {
                 showFeedback(feedbackDiv, 'Guardando trabajo...', 'info');
                 if (jobId) { // Editando
                     await db.collection('jobs').doc(jobId).update(jobData);
                     showFeedback(feedbackDiv, 'Trabajo actualizado con éxito.', 'success');
                 } else { // Creando
                     // jobData.createdAt = firebase.firestore.FieldValue.serverTimestamp();
                     const docRef = await db.collection('jobs').add(jobData);
                     jobData.id = docRef.id;
                     showFeedback(feedbackDiv, 'Trabajo creado con éxito.', 'success');
                 }

                 dataLoaded.jobs = false; // Mark jobs data as stale
                 setActiveTab(document.querySelector('[data-target=jobs]')); // Go to jobs list (will trigger reload)
                 // resetJobForm(); // Reset is done when entering the 'new-job-form' tab

             } catch (error) {
                 console.error("Error guardando trabajo:", error);
                 showFeedback(feedbackDiv, `Error al guardar trabajo: ${error.message}`, 'error');
             }
        });

        function editJob(id) {
            const job = jobsData.find(j => j.id === id);
             if (!job) {
                 console.error(`Trabajo con ID ${id} no encontrado en cache.`);
                 alert(`Error: No se encontró el trabajo con ID ${id}. Intente recargar la lista.`);
                 return;
             }

             console.log("Editando trabajo:", job);
             resetJobForm(); // Clear form first

             document.getElementById('job-form-title').textContent = 'Editar Trabajo';
             document.getElementById('job-id').value = job.id;

             document.getElementById('job-client').value = job.clientId || '';
             document.getElementById('job-details').value = job.details || '';
             document.getElementById('job-material').value = job.materialId || '';
             document.getElementById('job-length').value = job.length || '';
             document.getElementById('job-width').value = job.width || '';
             document.getElementById('job-job-type').value = job.jobType || 'corte';
             document.getElementById('job-job-type').dispatchEvent(new Event('change')); // Trigger visibility
             document.getElementById('job-cut-minutes').value = job.cutMinutes || 0;
             document.getElementById('job-engrave-minutes').value = job.engraveMinutes || 0;
             document.getElementById('job-order-date').value = job.orderDate || '';
             document.getElementById('job-delivery-date').value = job.deliveryDate || '';
             document.getElementById('job-status').value = job.status || 'Encargado';
             document.getElementById('job-final-cost').value = (job.finalCost || 0).toFixed(2);
             document.getElementById('job-deposit').value = (job.deposit || 0).toFixed(2);
             document.getElementById('job-observations').value = job.observations || '';

             currentJobQuoteBaseCost = job.baseCost || 0; // Restore saved base cost
             const resultDiv = document.getElementById('job-quote-base-result');
             if (resultDiv) resultDiv.textContent = `Costo Base (Guardado): $${currentJobQuoteBaseCost.toFixed(2)}`;


             setActiveTab(document.querySelector('[data-target=new-job-form]'));
             setTimeout(() => {
                  document.getElementById('job-form').scrollIntoView({ behavior: 'smooth', block: 'start' });
             }, 100);
        }

        function resetJobForm(keepClientId = null) {
            console.log("Reseteando formulario de trabajo...");
             document.getElementById('job-form-title').textContent = 'Nuevo Trabajo';
             const form = document.getElementById('job-form');
             if (form) form.reset();
             document.getElementById('job-id').value = '';
             currentJobQuoteBaseCost = 0;
             document.getElementById('job-quote-base-result').textContent = 'Costo Base Estimado: $0.00';
             document.getElementById('job-final-cost').value = '0.00'; // Reset final cost too
             document.getElementById('job-order-date').value = new Date().toISOString().split('T')[0]; // Default to today
             document.getElementById('job-job-type').dispatchEvent(new Event('change')); // Reset time fields visibility
             const feedbackDiv = document.getElementById('job-form-feedback');
             if (feedbackDiv) feedbackDiv.textContent = ''; feedbackDiv.className = 'mt-2 text-sm feedback';

             if(keepClientId) {
                 const clientSelect = document.getElementById('job-client');
                 if (clientSelect) clientSelect.value = keepClientId;
             }
        }

        async function deleteJob(id) {
             if (!db) { console.error("deleteJob: db no disponible."); return; }
            const job = jobsData.find(j => j.id === id);
             const clientName = job ? (clientsData[job.clientId]?.name || 'Desconocido') : 'Desconocido';
             const jobDetails = job ? (job.details || `ID ${id}`) : `ID ${id}`;

             if (!confirm(`¿Está seguro de querer borrar el trabajo "${jobDetails}" para el cliente "${clientName}"? Esta acción no se puede deshacer.`)) {
                 return;
             }

             // Use a general feedback area if possible, or alert as fallback
             // const feedbackDiv = document.getElementById('some-general-feedback-area');
             try {
                  console.log(`Borrando trabajo ${id}...`)
                 await db.collection('jobs').doc(id).delete();
                 jobsData = jobsData.filter(j => j.id !== id); // Remove from local cache
                 console.log(`Trabajo ${id} borrado.`);
                  alert(`Trabajo "${jobDetails}" borrado.`); // Simple user feedback

                 // Repopulate tables
                 populateJobsTable();
                 populateDeadlinesTable();
                 populateStatusTable();
                 generateReports();

                 if (document.getElementById('job-id').value === id) {
                     resetJobForm(); // Clear form if this was being edited
                 }
             } catch (error) {
                 console.error("Error borrando trabajo:", error);
                 alert(`Error al borrar trabajo: ${error.message}`);
             }
        }

        // --- CRUD Materiales (SuperAdmin) ---
        document.getElementById('material-form-admin')?.addEventListener('submit', async (e) => {
             e.preventDefault();
             if (currentUserRole !== 'superadmin' || !db) return;

             const materialId = document.getElementById('material-id-admin').value;
             const feedbackDiv = document.getElementById('material-form-feedback-admin');
             showFeedback(feedbackDiv, '', 'info'); // Clear feedback

             const materialData = {
                 name: document.getElementById('material-name-admin').value.trim(),
                 thickness: parseFloat(document.getElementById('material-thickness-admin').value) || null,
                 costPerSheet: parseFloat(document.getElementById('material-cost-admin').value) || 0,
                 width: parseFloat(document.getElementById('material-width-admin').value) || null,
                 height: parseFloat(document.getElementById('material-height-admin').value) || null,
                 available: document.getElementById('material-availability-admin').checked,
                 // lastUpdated: firebase.firestore.FieldValue.serverTimestamp()
             };

             // Validation
             let errors = [];
             if (!materialData.name) { errors.push('El nombre es obligatorio.'); }
             if (!materialData.thickness || materialData.thickness <= 0) { errors.push('El grosor debe ser un número positivo.'); }
             if (materialData.costPerSheet < 0) { errors.push('El costo no puede ser negativo.'); }
             if (!materialData.width || materialData.width <= 0) { errors.push('El ancho de plancha debe ser un número positivo.'); }
             if (!materialData.height || materialData.height <= 0) { errors.push('El alto de plancha debe ser un número positivo.'); }

             if (errors.length > 0) {
                 showFeedback(feedbackDiv, errors.join(' '), 'error');
                 return;
             }


             try {
                  showFeedback(feedbackDiv, 'Guardando material...', 'info');
                 if (materialId) { // Editando
                     await db.collection('materials').doc(materialId).update(materialData);
                     materialsData[materialId] = { ...materialsData[materialId], ...materialData };
                     showFeedback(feedbackDiv, 'Material actualizado.', 'success');
                 } else { // Creando
                     // materialData.createdAt = firebase.firestore.FieldValue.serverTimestamp();
                     const docRef = await db.collection('materials').add(materialData);
                     materialsData[docRef.id] = { ...materialData, id: docRef.id };
                     showFeedback(feedbackDiv, 'Material añadido.', 'success');
                 }
                 resetMaterialFormAdmin();
                 populateMaterialsAdminTable();
                 populateMaterialDropdown('job-material'); // Update job form dropdown too
             } catch (error) {
                 console.error("Error guardando material:", error);
                 showFeedback(feedbackDiv, `Error al guardar: ${error.message}`, 'error');
             }
         });

        function editMaterialAdmin(id) {
            if (currentUserRole !== 'superadmin') return;
            const mat = materialsData[id];
             if (!mat) { console.error(`Material ${id} no encontrado.`); return; }

             resetMaterialFormAdmin(); // Clear form first
             document.getElementById('material-form-title-admin').textContent = 'Editar Material';
             document.getElementById('material-id-admin').value = mat.id;
             document.getElementById('material-name-admin').value = mat.name || '';
             document.getElementById('material-thickness-admin').value = mat.thickness || '';
             document.getElementById('material-cost-admin').value = (mat.costPerSheet !== undefined ? mat.costPerSheet : mat.cost) || 0; // Handle legacy 'cost'
             document.getElementById('material-width-admin').value = mat.width || '';
             document.getElementById('material-height-admin').value = mat.height || '';
             document.getElementById('material-availability-admin').checked = mat.available !== false;

             document.getElementById('material-form-admin').scrollIntoView({ behavior: 'smooth', block: 'start' });
             document.getElementById('material-name-admin').focus();
        }

        function resetMaterialFormAdmin() {
            if (currentUserRole !== 'superadmin') return;
            document.getElementById('material-form-title-admin').textContent = 'Añadir Material';
             const form = document.getElementById('material-form-admin');
             if (form) form.reset();
             document.getElementById('material-id-admin').value = '';
             // Set defaults not handled by reset
             document.getElementById('material-availability-admin').checked = true;
              document.getElementById('material-width-admin').value = '1300';
              document.getElementById('material-height-admin').value = '900';

             const feedbackDiv = document.getElementById('material-form-feedback-admin');
             if (feedbackDiv) feedbackDiv.textContent = ''; feedbackDiv.className = 'mt-2 text-sm feedback';
        }

        async function deleteMaterialAdmin(id) {
            if (currentUserRole !== 'superadmin' || !db) return;
            const matName = materialsData[id]?.name || `ID ${id}`;
            // Check if material is used in any job BEFORE confirming
            const isUsed = jobsData.some(job => job.materialId === id);
            let confirmMsg = `¿Seguro que quiere borrar el material "${matName}"?`;
            if (isUsed) {
                confirmMsg += `\n\n¡ADVERTENCIA! Este material está siendo usado en uno o más trabajos existentes. Borrarlo puede causar errores al ver o editar esos trabajos.`
            }
             confirmMsg += "\n\nEsta acción no se puede deshacer.";

             if (!confirm(confirmMsg)) return;

             const feedbackDiv = document.getElementById('material-form-feedback-admin');
             try {
                 showFeedback(feedbackDiv, 'Borrando material...', 'info');
                 await db.collection('materials').doc(id).delete();
                 delete materialsData[id];
                 showFeedback(feedbackDiv, `Material "${matName}" borrado.`, 'success');
                 populateMaterialsAdminTable();
                 populateMaterialDropdown('job-material');
                 if (document.getElementById('material-id-admin').value === id) {
                      resetMaterialFormAdmin(); // Clear form if this was being edited
                 }
             } catch (error) {
                 console.error("Error borrando material:", error);
                 showFeedback(feedbackDiv, `Error al borrar: ${error.message}`, 'error');
             }
        }

        // --- CRUD Configuración (SuperAdmin) ---

        function addMonthlyCostInput(key = '', value = '') {
            const container = document.getElementById('monthly-costs-container');
            if (!container) return;

            const div = document.createElement('div');
            div.className = 'flex items-center space-x-2 cost-entry'; // Added class for selection
            div.innerHTML = `
                <input type="text" placeholder="Descripción (Ej: Luz)" value="${key}" data-cost-key class="flex-grow p-1 border border-gray-300 rounded-md text-sm">
                <input type="number" placeholder="0.00" value="${value}" step="0.01" min="0" data-cost-value class="w-24 p-1 border border-gray-300 rounded-md text-sm text-right">
                <button type="button" onclick="removeMonthlyCostInput(this)" class="text-red-500 hover:text-red-700 text-xl font-bold leading-none px-1" title="Eliminar Costo">&times;</button>
            `;
            container.appendChild(div);
             // Focus the new key input
            div.querySelector('[data-cost-key]').focus();
        }

        function removeMonthlyCostInput(button) {
            // Find the parent div with class 'cost-entry' and remove it
             const costEntryDiv = button.closest('.cost-entry');
             if (costEntryDiv) {
                 costEntryDiv.remove();
             } else {
                 console.warn("Couldn't find parent .cost-entry to remove.");
             }
        }


        document.getElementById('config-form-admin')?.addEventListener('submit', async (e) => {
            e.preventDefault();
            if (currentUserRole !== 'superadmin' || !db) return;

            const feedbackDiv = document.getElementById('config-form-feedback-admin');
             showFeedback(feedbackDiv, '', 'info'); // Clear feedback
             // Clear previous validation styles
             document.querySelectorAll('#monthly-costs-container input').forEach(input => input.classList.remove('border-red-500'));


            const minutesPerMonth = parseInt(document.getElementById('config-minutes-admin').value, 10);
            const costEntries = document.querySelectorAll('#monthly-costs-container .cost-entry'); // Select by class
            const monthlyCosts = {};
             let isValid = true;
             let errors = [];

             if (isNaN(minutesPerMonth) || minutesPerMonth <= 0) {
                 errors.push('Los minutos productivos deben ser un número positivo.');
                 document.getElementById('config-minutes-admin').classList.add('border-red-500');
                 isValid = false;
             } else {
                 document.getElementById('config-minutes-admin').classList.remove('border-red-500');
             }

             costEntries.forEach((div, index) => {
                 const keyInput = div.querySelector('[data-cost-key]');
                 const valueInput = div.querySelector('[data-cost-value]');
                 const key = keyInput.value.trim();
                 const valueStr = valueInput.value.trim();
                 const value = parseFloat(valueStr);

                 // Only process if at least one field has content
                 if (key || valueStr) {
                     let entryIsValid = true;
                     if (!key) {
                         errors.push(`Fila ${index + 1}: Falta descripción del costo.`);
                         keyInput.classList.add('border-red-500');
                         entryIsValid = false;
                     } else {
                         keyInput.classList.remove('border-red-500');
                     }

                     if (valueStr === '' || isNaN(value) || value < 0) {
                         errors.push(`Fila ${index + 1} ('${key || '?'}'): El valor debe ser un número positivo o cero.`);
                         valueInput.classList.add('border-red-500');
                         entryIsValid = false;
                     } else {
                          valueInput.classList.remove('border-red-500');
                     }

                     if (entryIsValid) {
                         if (monthlyCosts.hasOwnProperty(key)) {
                              errors.push(`Fila ${index + 1}: Descripción de costo duplicada "${key}". Use nombres únicos.`);
                              keyInput.classList.add('border-red-500');
                              entryIsValid = false;
                         } else {
                             monthlyCosts[key] = value;
                         }
                     }
                     if (!entryIsValid) isValid = false;
                 }
             });

            if (!isValid) {
                 showFeedback(feedbackDiv, errors.join(' '), 'error');
                 return;
             }


             const configUpdate = {
                 minutes_per_month: minutesPerMonth,
                 monthly_costs: monthlyCosts,
                 // lastUpdated: firebase.firestore.FieldValue.serverTimestamp()
             };

             try {
                 showFeedback(feedbackDiv, 'Guardando configuración...', 'info');
                 // Use set with merge: true to create doc if it doesn't exist, or update if it does
                 await db.collection('config').doc('main').set(configUpdate, { merge: true });

                 // Recalculate and update configData local immediately
                 const totalMonthly = Object.values(monthlyCosts).reduce((sum, val) => sum + val, 0);
                 configData = {
                     ...configData,
                     minutes_per_month: minutesPerMonth,
                     monthly_costs: monthlyCosts,
                     cost_per_minute: minutesPerMonth > 0 ? totalMonthly / minutesPerMonth : 0
                 };
                 console.log("Configuración guardada y actualizada localmente. Nuevo costo/min:", configData.cost_per_minute);

                 // Update UI del costo calculado en el form
                 populateConfigFormAdmin(); // Refreshes form including calculated cost

                 showFeedback(feedbackDiv, 'Configuración guardada con éxito.', 'success');

             } catch (error) {
                 console.error("Error guardando configuración:", error);
                 showFeedback(feedbackDiv, `Error al guardar: ${error.message}`, 'error');
             }
        });

        // --- Impresión ---
        async function printTicket(jobId) {
             console.log(`Intentando imprimir ticket para Job ID: ${jobId}`);
             const job = jobsData.find(j => j.id === jobId);
             if (!job) {
                 alert(`Error: No se encontró el trabajo con ID ${jobId}.`);
                 return;
             }

             // Fetch potentially updated client/material data just in case cache is stale?
             // Or rely on existing cache which is usually sufficient for a ticket.
             const client = clientsData[job.clientId];
             const material = materialsData[job.materialId];
             const printArea = document.getElementById('print-area');
             const printAreaWrapper = document.getElementById('print-area-wrapper');

             if (!printArea || !printAreaWrapper) {
                 console.error("Elementos #print-area o #print-area-wrapper no encontrados.");
                 alert("Error: No se pudo encontrar el área de impresión.");
                 return;
             }

             const finalCost = job.finalCost || 0;
             const deposit = job.deposit || 0;
             const outstanding = Math.max(0, finalCost - deposit);

             let ticketHtml = `
                 <h2>** TICKET TRABAJO ${job.id.substring(0, 6)} **</h2>
                 <p><strong>Pedido:</strong> ${formatDate(job.orderDate)} | <strong>Entrega:</strong> ${formatDate(job.deliveryDate)}</p>
                 <hr>
                 <p><strong>Cliente:</strong> ${client?.name || 'N/A'}</p>
                 ${client?.phone ? `<p><strong>Tel:</strong> ${client.phone}</p>` : ''}
                 <hr>
                 <p><strong>Trabajo:</strong> ${job.details || 'Sin detalles'}</p>
                 ${material ? `<p><em>Mat:</em> ${material.name || '?'} ${material.thickness || '?'}mm</p>` : ''}
                  ${(job.length && job.width) ? `<p><em>Med:</em> ${job.length}x${job.width}mm</p>` : ''}
                 <p><em>Tipo:</em> ${job.jobType || 'N/A'}</p>
                 ${(job.cutMinutes > 0) ? `<p><em>T. Corte:</em> ${job.cutMinutes} min</p>` : ''}
                 ${(job.engraveMinutes > 0) ? `<p><em>T. Grabado:</em> ${job.engraveMinutes} min</p>` : ''}
                 ${job.observations ? `<hr><p><strong>Obs:</strong> ${job.observations}</p>` : ''}
                 <hr>
                 <div class="totals">
                     <p class="item-line"><span>Total:</span> <span>$${finalCost.toFixed(2)}</span></p>
                     <p class="item-line"><span>Seña:</span> <span>$${deposit.toFixed(2)}</span></p>
                     <p class="item-line"><strong><span>Pendiente:</span> <span>$${outstanding.toFixed(2)}</span></strong></p>
                 </div>
                 <hr>
                 <p style="text-align: center; font-size: 8pt; margin-top: 5px;">¡Gracias!</p>
             `;

             printArea.innerHTML = ticketHtml;

             document.body.classList.add('printing-ticket');

             setTimeout(() => {
                 window.print();
                 setTimeout(() => {
                     document.body.classList.remove('printing-ticket');
                     printArea.innerHTML = '';
                      console.log("Clase printing-ticket eliminada.");
                 }, 500); // Shorter delay after print dialog closes/cancels

             }, 150); // Slightly shorter delay before print dialog
         }

        function printCurrentSection() {
             console.log(`Intentando imprimir sección activa: ${activeSectionId}`);
             const sectionToPrint = document.getElementById(activeSectionId);

             if (!sectionToPrint || !sectionToPrint.classList.contains('tab-content')) {
                 alert("No hay una sección válida activa para imprimir.");
                 return;
             }
             // Prevent printing login or home
             if (activeSectionId === 'login' || activeSectionId === 'home') {
                  alert("Esta sección no está diseñada para ser impresa.");
                 return;
             }
              // Prevent printing forms directly unless specifically designed for it
              if (activeSectionId === 'new-job-form' || activeSectionId === 'admin-materials' || activeSectionId === 'admin-config') {
                   if (!confirm("Va a imprimir el formulario. ¿Desea continuar? (Recomendado imprimir las tablas o tickets)")) {
                       return;
                   }
              }


             document.body.classList.add('printing-section');
             sectionToPrint.classList.add('printing-now');

             setTimeout(() => {
                 window.print();
                 setTimeout(() => {
                     document.body.classList.remove('printing-section');
                     sectionToPrint.classList.remove('printing-now');
                     console.log("Clases printing-section/printing-now eliminadas.");
                 }, 500);

             }, 150);
         }

        // --- Funciones Utilitarias ---
        function showFeedback(element, message, type = 'info') {
             if (!element) {
                 console.warn("showFeedback: Elemento no proporcionado. Mensaje:", message);
                 return;
             }
             element.textContent = message;
             element.className = 'mt-2 text-sm feedback'; // Reset base classes
             if (message) { // Only add type class if there is a message
                 switch (type) {
                     case 'success': element.classList.add('feedback-success'); break;
                     case 'error': element.classList.add('feedback-error'); break;
                     case 'info': element.classList.add('feedback-info'); break;
                     default: element.classList.add('feedback-info'); break;
                 }
             }
             // Auto-hide success/info messages
             if ((type === 'success' || type === 'info') && message) {
                 setTimeout(() => {
                     if (element.textContent === message) {
                         element.textContent = '';
                         element.className = 'mt-2 text-sm feedback';
                     }
                 }, 4000);
             }
         }

         function formatDate(dateString) { // Expects YYYY-MM-DD
             if (!dateString || dateString.length < 10) return '-';
             try {
                 const [year, month, day] = dateString.substring(0, 10).split('-');
                 if (!year || !month || !day || year.length !== 4) return dateString;
                 return `${day}/${month}/${year}`;
             } catch (e) {
                 console.warn("formatDate error for:", dateString, e);
                 return dateString;
             }
         }

         function parseDateForComparison(dateString) { // Expects YYYY-MM-DD, returns Date object at start of day UTC
             if (!dateString || dateString.length < 10) return null;
             try {
                  // Important: Use T00:00:00Z to force UTC interpretation and avoid timezone issues
                 const date = new Date(dateString.substring(0, 10) + 'T00:00:00Z');
                 if (isNaN(date.getTime())) return null;
                 return date;
             } catch (e) {
                  console.warn("parseDateForComparison error for:", dateString, e);
                 return null;
             }
         }

         function getStatusClass(status) {
             switch (status) {
                 case 'Encargado': return 'status-encargado';
                 case 'Procesando': return 'status-procesando';
                 case 'Terminado': return 'status-terminado';
                 default: return 'bg-gray-400 text-gray-800 px-2 py-0.5 rounded text-xs font-medium'; // Default style
             }
         }

        // --- Inicialización al Cargar la Página ---
        document.addEventListener('DOMContentLoaded', () => {
            console.log("DOM completamente cargado y parseado.");
            const yearSpan = document.getElementById('current-year');
            if (yearSpan) yearSpan.textContent = new Date().getFullYear();

            // Initial setup for job type visibility
             const jobTypeSelect = document.getElementById('job-job-type');
             if (jobTypeSelect) {
                 jobTypeSelect.dispatchEvent(new Event('change'));
             } else {
                 console.warn("Elemento #job-job-type no encontrado en DOMContentLoaded.");
             }

            // onAuthStateChanged (if auth initialized correctly) will handle the rest.
             if (typeof auth !== 'undefined') {
                 console.log("Esperando estado de autenticación...");
             } else {
                 console.error("El servicio de autenticación de Firebase no parece estar disponible. El login no funcionará.");
                 // Show login section as a fallback if auth failed to initialize
                  showLoginSection();
             }
        });

    </script>
    <!-- ****** END OF JAVASCRIPT ****** -->

</body>
</html>
```