<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Presupuestos Corte Laser</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-firestore-compat.js"></script>
    <style>
        /* ... (Estilos generales SIN CAMBIOS) ... */
        body { font-family: 'Inter', sans-serif; }
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap');
        .tab-content { display: none; } .active-tab-content { display: block; }
        .tab-button { padding: 8px 16px; margin-bottom: -1px; cursor: pointer; border: 1px solid transparent; border-bottom: 2px solid transparent; transition: border-color 0.3s, color 0.3s; color: #6b7280; font-weight: 500; white-space: nowrap; } .tab-button.active-tab { border-color: #d1d5db #d1d5db #fff; border-bottom-color: #3b82f6; color: #2563eb; } .tab-button:hover:not(.active-tab) { border-bottom-color: #9ca3af; color: #4b5563; } .tab-button.superadmin-tab { color: #8b5cf6; } .tab-button.superadmin-tab.active-tab { border-color: #d1d5db #d1d5db #fff; border-bottom-color: #7c3aed; color: #6d28d9; } .tab-button.superadmin-tab:hover:not(.active-tab) { border-bottom-color: #a78bfa; color: #7c3aed; }
        .admin-only, .superadmin-only { display: none; } .public-only { display: block; } body.logged-in .admin-only { display: block; } body.logged-in nav#tab-buttons { display: flex; } body.logged-in .public-only { display: none; } body.role-superadmin .superadmin-only { display: block; } body.logged-in #user-email { display: inline; } body.logged-in .generic-print-button { display: inline-block; } body.logged-in #admin-logout-button { display: inline-block; } body.role-superadmin button.superadmin-tab { display: inline-block; }
        .admin-table { width: 100%; border-collapse: collapse; margin-top: 1rem; font-size: 0.9rem; } .admin-table th, .admin-table td { border: 1px solid #ddd; padding: 6px; text-align: left; vertical-align: middle;} .admin-table th { background-color: #f2f2f2; font-weight: 600; } .admin-table button, .action-button { padding: 4px 8px; font-size: 0.8rem; margin-right: 4px; cursor: pointer; border-radius: 4px; transition: background-color 0.2s; border: none; } .edit-button { background-color: #facc15; color: #422006; } .edit-button:hover { background-color: #eab308; } .delete-button { background-color: #f87171; color: #450a0a; } .delete-button:hover { background-color: #ef4444; } .print-button { background-color: #60a5fa; color: #1e3a8a; } .print-button:hover { background-color: #3b82f6; } .generic-print-button { background-color: #a78bfa; color: #f5f3ff; } .generic-print-button:hover { background-color: #8b5cf6; }
        .status-encargado { background-color: #fbbf24; color: #78350f; padding: 2px 6px; border-radius: 4px; font-weight: 500; font-size: 0.8rem; } .status-procesando { background-color: #f87171; color: #7f1d1d; padding: 2px 6px; border-radius: 4px; font-weight: 500; font-size: 0.8rem; } .status-terminado { background-color: #4ade80; color: #14532d; padding: 2px 6px; border-radius: 4px; font-weight: 500; font-size: 0.8rem; }
        .date-overdue { color: #dc2626; font-weight: bold; }
        .feedback { padding: 8px; margin-top: 8px; border-radius: 4px; font-size: 0.9rem; min-height: 2em; } .feedback-success { background-color: #dcfce7; color: #166534; border: 1px solid #86efac; } .feedback-error { background-color: #fee2e2; color: #991b1b; border: 1px solid #fca5a5; } .feedback-info { background-color: #e0f2fe; color: #075985; border: 1px solid #7dd3fc; }
        /* ... (Fin Estilos generales SIN CAMBIOS) ... */

        /* Default style for print area wrapper - hidden */
        #print-area-wrapper {
             display: none; /* Oculto por defecto en pantalla */
        }

        /* === INICIO: ESTILOS DE IMPRESIÓN REVISADOS === */
        @media print {
            body { -webkit-print-color-adjust: exact !important; print-color-adjust: exact !important; }
            .no-print { display: none !important; }
            header, nav#tab-buttons, footer { display: none !important; }
            /* Ocultar formularios específicos si tienen clase no-print */
            #client-form.no-print, #job-form .no-print, #material-form-admin.no-print, #config-form-admin.no-print { display: none !important; }

            /* --- Estilos para impresión GENERAL DE SECCIÓN (body.printing-section) --- */
            body.printing-section #print-area-wrapper { display: none !important; } /* Ocultar wrapper de ticket si se imprime sección general */
            body.printing-section > *:not(#tab-content-container) { display: none !important; }
            body.printing-section #tab-content-container > *:not(.printing-now) { display: none !important; }
            body.printing-section .printing-now {
                visibility: visible !important; display: block !important; position: static !important; /* Importante: static */
                width: 100% !important; background-color: #fff !important; color: #000 !important;
                padding: 10mm !important; margin: 0 !important; border: none !important; box-shadow: none !important;
                font-size: 10pt !important;
            }
            body.printing-section .printing-now * { visibility: visible !important; } /* Asegurar visibilidad de hijos */
            body.printing-section .printing-now button,
            body.printing-section .printing-now input[type="button"],
            body.printing-section .printing-now input[type="submit"],
            body.printing-section .printing-now .no-print { display: none !important; }
            body.printing-section .printing-now input:not([type="button"]):not([type="submit"]):not([type="checkbox"]),
            body.printing-section .printing-now select,
            body.printing-section .printing-now textarea {
                 border: none !important; background-color: transparent !important; padding: 0 !important; margin: 0 !important;
                 -webkit-appearance: none; appearance: none; color: #000 !important; box-shadow: none !important;
                 width: auto !important; display: inline !important; vertical-align: baseline;
            }
            body.printing-section .printing-now input[type="checkbox"] { display: none !important; }
            body.printing-section .printing-now select { display: inline !important; -webkit-appearance: none; appearance: none; border: none; background: none; padding: 0; }
             /* Estilos tabla en impresión general */
            body.printing-section .printing-now .admin-table { font-size: 9pt; width: 100%; margin-top: 0.5rem; border-collapse: collapse !important; page-break-inside: auto; }
            body.printing-section .printing-now .admin-table tr { page-break-inside: avoid; page-break-after: auto; }
            body.printing-section .printing-now .admin-table th,
            body.printing-section .printing-now .admin-table td {
                padding: 4px !important; border: 1px solid #ccc !important; color: #000 !important;
                background-color: #fff !important; word-wrap: break-word; vertical-align: top;
            }
             body.printing-section .printing-now .admin-table th { background-color: #eee !important; font-weight: bold !important; }
            /* Ocultar la ÚLTIMA columna (Acciones) */
             body.printing-section .printing-now .admin-table th:last-child,
             body.printing-section .printing-now .admin-table td:last-child { display: none !important; }
            /* Forzar colores de estado */
            body.printing-section .printing-now [class*="status-"] { /* Selector más genérico */
                -webkit-print-color-adjust: exact !important; print-color-adjust: exact !important;
                display: inline-block !important; border: 1px solid #ccc !important;
                padding: 1px 4px !important; font-size: 8pt !important;
                color: inherit !important; background-color: inherit !important;
            }
            body.printing-section .printing-now h1, body.printing-section .printing-now h2, body.printing-section .printing-now h3 { color: #000 !important; margin-bottom: 10px; font-size: 14pt; }

            /* --- Estilos específicos para TICKET (body.printing-ticket) --- */
             /* Ocultar todo excepto el wrapper del ticket */
            body.printing-ticket > *:not(#print-area-wrapper) { display: none !important; }
            body.printing-ticket #print-area-wrapper {
                display: block !important; /* Mostrar el wrapper */
                visibility: visible !important; position: static !important;
                width: 80mm !important; max-width: 100%; margin: 5mm auto !important;
                padding: 0 !important; background-color: #fff !important; box-shadow: none !important; border: none !important;
                font-family: 'Courier New', Courier, monospace !important; line-height: 1.3 !important; color: #000 !important;
                font-size: 9pt !important;
             }
            body.printing-ticket #print-area { visibility: visible !important; display: block !important; padding: 3mm !important; }
            body.printing-ticket #print-area * { visibility: visible !important; } /* Asegurar visibilidad dentro del area */
            body.printing-ticket #print-area h2 { font-size: 11pt !important; margin-bottom: 6px !important; text-align: center !important; font-weight: bold !important; }
            body.printing-ticket #print-area p { margin: 2px 0 !important; font-size: 9pt !important; word-wrap: break-word; }
            body.printing-ticket #print-area hr { border: none !important; border-top: 1px dashed #555 !important; margin: 4px 0 !important; }
            body.printing-ticket #print-area strong { font-weight: bold !important; }
            body.printing-ticket #print-area .item-line { display: flex !important; justify-content: space-between !important; }
            body.printing-ticket #print-area .item-line span:last-child { text-align: right !important; }
            body.printing-ticket #print-area .totals { margin-top: 8px !important; border-top: 1px solid #555 !important; padding-top: 4px !important; }
            body.printing-ticket #print-area .detail-label { font-weight: bold; display: inline-block; min-width: 75px;}
            body.printing-ticket #print-area .detail-value { /* Estilo normal para el valor */ }
        }
        /* === FIN: ESTILOS DE IMPRESIÓN REVISADOS === */
    </style>
</head>
<body class="bg-gray-100 text-gray-800">

    <div class="container mx-auto p-4">

        <!-- Header (SIN CAMBIOS) -->
        <header class="bg-white shadow-md rounded-lg p-4 mb-6 no-print">
             <!-- ... (contenido del header sin cambios) ... -->
        </header>

        <!-- Nav Tabs (SIN CAMBIOS) -->
        <nav id="tab-buttons" class="admin-only flex flex-wrap border-b border-gray-300 mb-6 no-print" style="display: none;">
             <!-- ... (botones de tabs sin cambios) ... -->
        </nav>

        <main id="tab-content-container">
            <!-- Secciones HTML (Home, Login, Clients, Jobs, etc.) (SIN CAMBIOS) -->
            <!-- ... (Contenido de todas las secciones sin cambios) ... -->
        </main>

        <!-- Print Area Wrapper (Ahora oculto por display:none por defecto) -->
        <div id="print-area-wrapper" aria-hidden="true" style="display: none;">
            <div id="print-area">
                <!-- Contenido del ticket se inyecta aquí -->
            </div>
        </div>

        <!-- Footer (SIN CAMBIOS) -->
        <footer class="text-center text-gray-500 text-sm mt-8 no-print">
             <!-- ... (contenido del footer sin cambios) ... -->
        </footer>

    </div>

    <!-- ****** START OF JAVASCRIPT ****** -->
    <script>
        // --- Configuración Firebase, Variables Globales, Navegación, Auth, Login/Logout, Carga de Datos, Poblado Dropdowns/Tablas, CRUDs (SIN CAMBIOS) ---
        const firebaseConfig = { apiKey: "AIzaSyAVBHUX8Ey9lLUCiz6mNDOemrNfrR-3Szs", authDomain: "presupuestadorcortelaser.firebaseapp.com", projectId: "presupuestadorcortelaser", storageBucket: "presupuestadorcortelaser.firebasestorage.app", messagingSenderId: "159566854109", appId: "1:159566854109:web:8d7351cef717697f3ea834" };
        let db; let auth;
        try { firebase.initializeApp(firebaseConfig); db = firebase.firestore(); auth = firebase.auth(); console.log("Firebase inicializado."); } catch (error) { console.error("Error Firebase Init:", error); alert("Error crítico: No se pudo inicializar Firebase."); }
        const SUPER_ADMIN_UID = 'WirMlSEvm5UdlAkns4KNr7ND0wr1';
        let materialsData = {}; let configData = { cost_per_minute: 0, minutes_per_month: 2400, monthly_costs: {} }; let clientsData = {}; let jobsData = []; let currentUser = null; let currentUserRole = null; let currentJobQuoteBaseCost = 0; let dataLoaded = { clients: false, jobs: false, materials: false, config: false }; let activeSectionId = 'home';
        function setActiveTab(buttonElement) { if (!buttonElement) return; const targetId = buttonElement.getAttribute('data-target'); if (!targetId) return; console.log("Activando tab:", targetId); activeSectionId = targetId; document.querySelectorAll('#tab-content-container .tab-content').forEach(c => c.classList.remove('active-tab-content', 'printing-now')); document.querySelectorAll('#tab-buttons .tab-button').forEach(b => b.classList.remove('active-tab')); const sectionToShow = document.getElementById(targetId); if (sectionToShow) { sectionToShow.classList.add('active-tab-content'); buttonElement.classList.add('active-tab'); loadDataForSection(targetId); } else { console.error(`Content '${targetId}' not found.`); const defBtn = document.querySelector('#tab-buttons .tab-button[data-target="jobs"]'); if (defBtn) setActiveTab(defBtn); } }
        function showLoginSection() { console.log("Mostrando login"); activeSectionId = 'login'; document.querySelectorAll('#tab-content-container .tab-content').forEach(c => c.classList.remove('active-tab-content', 'printing-now')); document.querySelectorAll('#tab-buttons .tab-button').forEach(b => b.classList.remove('active-tab')); const lSec = document.getElementById('login'); if(lSec) lSec.classList.add('active-tab-content'); const lForm = document.getElementById('login-form'); if(lForm) lForm.reset(); const errDiv = document.getElementById('login-error'); if(errDiv) errDiv.textContent = ''; }
        auth?.onAuthStateChanged(user => { if (!auth) { showLoginSection(); return; } console.log("Auth state:", user ? user.uid : 'null'); currentUser = user; const uSpan = document.getElementById('user-email'); document.body.classList.remove('logged-in', 'role-superadmin', 'role-operator', 'public-only'); if (user) { currentUserRole = (user.uid === SUPER_ADMIN_UID) ? 'superadmin' : 'operator'; console.log("Role:", currentUserRole); document.body.classList.add('logged-in', `role-${currentUserRole}`); if (uSpan) uSpan.textContent = user.email; loadInitialDataForLoggedInUser().then(() => { console.log("Initial data loaded post-login."); const defTab = 'jobs'; const tBtn = document.querySelector(`#tab-buttons .tab-button[data-target="${defTab}"]`); if (tBtn) setActiveTab(tBtn); else { console.error("Default tab btn 'jobs' not found."); const fBtn = document.querySelector('#tab-buttons .tab-button:not(.superadmin-only)') || document.querySelector('#tab-buttons .tab-button.superadmin-only'); if (fBtn) setActiveTab(fBtn); } }).catch(error => { console.error("Error initial data load:", error); alert("Error crítico cargando datos."); }); } else { console.log("Logged out."); currentUserRole = null; document.body.classList.add('public-only'); if (uSpan) uSpan.textContent = ''; materialsData = {}; clientsData = {}; jobsData = []; configData = { cost_per_minute: 0, minutes_per_month: 2400, monthly_costs: {} }; dataLoaded = { clients: false, jobs: false, materials: false, config: false }; document.querySelectorAll('#tab-content-container .tab-content').forEach(c => c.classList.remove('active-tab-content', 'printing-now')); document.querySelectorAll('#tab-buttons .tab-button').forEach(b => b.classList.remove('active-tab')); const hSec = document.getElementById('home'); if (hSec) { hSec.classList.add('active-tab-content'); activeSectionId = 'home'; } } });
        document.getElementById('login-form')?.addEventListener('submit', async (e) => { e.preventDefault(); if (!auth) return; const email = document.getElementById('login-email').value; const pass = document.getElementById('login-password').value; const errDiv = document.getElementById('login-error'); if(errDiv) errDiv.textContent = ''; try { await auth.signInWithEmailAndPassword(email, pass); console.log("Login ok."); } catch (error) { console.error("Login err:", error.code); if(errDiv) { if (error.code === 'auth/user-not-found' || error.code === 'auth/wrong-password' || error.code === 'auth/invalid-credential') errDiv.textContent = 'Email o contraseña incorrectos.'; else if (error.code === 'auth/invalid-email') errDiv.textContent = 'Formato email inválido.'; else errDiv.textContent = 'Error al iniciar sesión.'; } } });
        function logoutUser() { if (!auth) return; console.log("Logging out..."); auth.signOut().then(() => console.log("Logout ok.")).catch(err => { console.error("Logout err:", err); alert("Error logout: " + err.message); }); }
        async function loadInitialDataForLoggedInUser() { if (!db) throw new Error("DB N/A"); console.log("Loading initial data..."); await Promise.all([ loadMaterials(), loadConfig(), loadClients() ]); console.log("Initial data ok."); }
        function loadDataForSection(sectionId) { if (!db) return; console.log(`Loading for ${sectionId}`); if (!currentUser) return; switch(sectionId){ case 'clients': if (!dataLoaded.clients) loadClients(); else populateClientsTable(); break; case 'jobs': loadJobs(); break; case 'deadlines': if (!dataLoaded.jobs) loadJobs().then(populateDeadlinesTable); else populateDeadlinesTable(); break; case 'status': if (!dataLoaded.jobs) loadJobs().then(populateStatusTable); else populateStatusTable(); break; case 'reports': if (!dataLoaded.jobs) loadJobs().then(generateReports); else generateReports(); break; case 'new-job-form': const cP=dataLoaded.clients?Promise.resolve():loadClients(); const mP=dataLoaded.materials?Promise.resolve():loadMaterials(); Promise.all([cP,mP]).then(() => { populateClientDropdown('job-client'); populateMaterialDropdown('job-material'); }).catch(err => console.error("Err loading for New Job:", err)); resetJobForm(); break; case 'admin-materials': if(currentUserRole==='superadmin'){ if(!dataLoaded.materials) loadMaterials(); else populateMaterialsAdminTable(); } break; case 'admin-config': if(currentUserRole==='superadmin'){ if(!dataLoaded.config) loadConfig(); else populateConfigFormAdmin(); } break; } }
        async function loadMaterials() { if (!db) return; console.log("Loading materials..."); try { const snap=await db.collection('materials').orderBy('name').get(); const temp={}; snap.forEach(doc=>temp[doc.id]={...doc.data(),id:doc.id}); materialsData=temp; console.log(`Mats loaded: ${Object.keys(materialsData).length}`); dataLoaded.materials=true; populateMaterialDropdown('job-material'); if(currentUserRole==='superadmin') populateMaterialsAdminTable(); } catch (err) { console.error("Err loading mats:", err); const f=document.getElementById('material-form-feedback-admin'); if(f) showFeedback(f,`Err loading mats: ${err.message}`,'error'); dataLoaded.materials=false; } }
        async function loadConfig() { if (!db) return; console.log("Loading config..."); try { const doc=await db.collection('config').doc('main').get(); if(doc.exists){ const d=doc.data(); configData={minutes_per_month:d.minutes_per_month||2400,monthly_costs:d.monthly_costs||{},cost_per_minute:0}; const tm=Object.values(configData.monthly_costs).reduce((s,v)=>s+(Number(v)||0),0); if(configData.minutes_per_month>0) configData.cost_per_minute=tm/configData.minutes_per_month; else configData.cost_per_minute=0; console.log(`Config loaded. Cost/min: $${configData.cost_per_minute.toFixed(4)}`); } else { console.warn("Config 'main' N/F. Defaults used."); configData={cost_per_minute:0,minutes_per_month:2400,monthly_costs:{}}; } dataLoaded.config=true; if(currentUserRole==='superadmin') populateConfigFormAdmin(); } catch(err) { console.error("Err loading config:", err); const f=document.getElementById('config-form-feedback-admin'); if(f) showFeedback(f,`Err loading config: ${err.message}`,'error'); dataLoaded.config=false; } }
        async function loadClients() { if(!currentUser||!db) return; console.log("Loading clients..."); const b=document.getElementById('clients-table')?.querySelector('tbody'); if(b) b.innerHTML='<tr><td colspan="4" class="text-center py-4">Loading...</td></tr>'; try { const snap=await db.collection('clients').orderBy('name','asc').get(); const temp={}; snap.forEach(doc=>temp[doc.id]={...doc.data(),id:doc.id}); clientsData=temp; console.log(`Clients loaded: ${Object.keys(clientsData).length}`); dataLoaded.clients=true; populateClientsTable(); populateClientDropdown('job-client'); } catch(err) { console.error("Err loading clients:", err); if(b) b.innerHTML=`<tr><td colspan="4" class="text-center py-4 text-red-600">Error: ${err.message}</td></tr>`; dataLoaded.clients=false; } }
        async function loadJobs() { if(!currentUser||!db) return; console.log("Loading jobs..."); ['jobs-table','deadlines-table','status-table','outstanding-table'].forEach(id=>{const b=document.getElementById(id)?.querySelector('tbody'); if(b){const c=b.closest('table').querySelector('thead th')?.length||1; b.innerHTML=`<tr><td colspan="${c}" class="text-center py-4">Loading...</td></tr>`;}}); ['report-total-value','report-total-deposit','report-total-outstanding'].forEach(id=>{const el=document.getElementById(id);if(el)el.textContent='Calculating...';}); try { const snap=await db.collection('jobs').orderBy('deliveryDate','asc').get(); const temp=[]; snap.forEach(doc=>{const d=doc.data(); temp.push({...d, id:doc.id, orderDate:d.orderDate instanceof firebase.firestore.Timestamp?d.orderDate.toDate().toISOString().split('T')[0]:d.orderDate, deliveryDate:d.deliveryDate instanceof firebase.firestore.Timestamp?d.deliveryDate.toDate().toISOString().split('T')[0]:d.deliveryDate, finalCost:Number(d.finalCost||0), deposit:Number(d.deposit||0) }); }); jobsData=temp; console.log(`Jobs loaded: ${jobsData.length}`); dataLoaded.jobs=true; populateJobsTable(); populateDeadlinesTable(); populateStatusTable(); generateReports(); } catch(err) { console.error("Err loading jobs:", err); ['jobs-table','deadlines-table','status-table','outstanding-table'].forEach(id=>{const b=document.getElementById(id)?.querySelector('tbody'); if(b){const c=b.closest('table').querySelector('thead th')?.length||1; b.innerHTML=`<tr><td colspan="${c}" class="text-center py-4 text-red-600">Error: ${err.message}</td></tr>`;}}); dataLoaded.jobs=false; } }
        function populateClientDropdown(id) { const s=document.getElementById(id); if (!s) return; const v=s.value; s.innerHTML='<option value="">Select client...</option>'; Object.values(clientsData).sort((a,b)=>(a.name||"").localeCompare(b.name||"")).forEach(c=>{const o=document.createElement('option'); o.value=c.id; o.textContent=c.name||`ID: ${c.id}`; s.appendChild(o);}); if (Array.from(s.options).some(opt=>opt.value===v)) s.value=v; }
        function populateMaterialDropdown(id) { const s=document.getElementById(id); if (!s) return; const v=s.value; s.innerHTML='<option value="">Select material...</option>'; Object.values(materialsData).filter(m=>m.available!==false).sort((a,b)=>`${a.name||''} ${a.thickness||0}mm`.localeCompare(`${b.name||''} ${b.thickness||0}mm`)).forEach(m=>{const o=document.createElement('option'); o.value=m.id; o.textContent=`${m.name||'No Name'} - ${m.thickness||'?'}mm`; s.appendChild(o);}); if (Array.from(s.options).some(opt=>opt.value===v)) s.value=v; }
        function populateClientsTable() { const b=document.getElementById('clients-table')?.querySelector('tbody'); if(!b)return; if(Object.keys(clientsData).length===0&&dataLoaded.clients){b.innerHTML='<tr><td colspan="4" class="text-center py-4">No clients.</td></tr>';return;} let h=''; Object.values(clientsData).sort((a,b)=>(a.name||"").localeCompare(b.name||"")).forEach(c=>{h+=`<tr data-client-id="${c.id}"><td>${c.name||'N/A'}</td><td>${c.phone||'-'}</td><td>${c.email||'-'}</td><td class="no-print space-x-1 whitespace-nowrap"><button onclick="editClient('${c.id}')" class="edit-button">Edit</button><button onclick="deleteClient('${c.id}')" class="delete-button">Delete</button><button onclick="selectClientForNewJob('${c.id}')" class="action-button bg-blue-500 hover:bg-blue-600 text-white">New Job</button></td></tr>`;}); b.innerHTML=h; }
        function populateJobsTable() { const b=document.getElementById('jobs-table')?.querySelector('tbody'); if(!b)return; if(jobsData.length===0&&dataLoaded.jobs){b.innerHTML='<tr><td colspan="9" class="text-center py-4">No jobs.</td></tr>';return;} const s=[...jobsData].sort((a,b)=>(b.orderDate||"").localeCompare(a.orderDate||"")); let h=''; s.forEach(j=>{const n=clientsData[j.clientId]?.name||'Deleted/Unknown'; const fc=j.finalCost||0; const dp=j.deposit||0; const o=Math.max(0,fc-dp); const dd=j.deliveryDate?parseDateForComparison(j.deliveryDate):null; const t=new Date(); t.setHours(0,0,0,0); const i=dd&&dd<t&&j.status!=='Terminado'; h+=`<tr data-job-id="${j.id}"><td>${n}</td><td class="max-w-xs truncate" title="${j.details||''}">${j.details||'-'}</td><td>${formatDate(j.orderDate)}</td><td class="${i?'date-overdue':''}">${formatDate(j.deliveryDate)}</td><td><span class="${getStatusClass(j.status)}">${j.status||'N/A'}</span></td><td class="text-right">${fc.toFixed(2)}</td><td class="text-right">${dp.toFixed(2)}</td><td class="text-right font-semibold ${o>0.005?'text-red-600':'text-green-600'}">${o.toFixed(2)}</td><td class="no-print space-x-1 whitespace-nowrap"><button onclick="editJob('${j.id}')" class="edit-button">Edit</button><button onclick="deleteJob('${j.id}')" class="delete-button">Delete</button><button onclick="printTicket('${j.id}')" class="print-button">Ticket</button></td></tr>`;}); b.innerHTML=h; }
        function populateDeadlinesTable() { const b=document.getElementById('deadlines-table')?.querySelector('tbody'); if(!b)return; if(jobsData.length===0&&dataLoaded.jobs){b.innerHTML='<tr><td colspan="6" class="text-center py-4">No jobs.</td></tr>';return;} const t=new Date(); t.setHours(0,0,0,0); const u=jobsData.filter(j=>j.status!=='Terminado').sort((a,b)=>(a.deliveryDate||"9999-12-31").localeCompare(b.deliveryDate||"9999-12-31")); if(u.length===0){b.innerHTML='<tr><td colspan="6" class="text-center py-4">No pending jobs.</td></tr>';return;} let h=''; u.forEach(j=>{const n=clientsData[j.clientId]?.name||'Deleted/Unknown'; const dd=j.deliveryDate?parseDateForComparison(j.deliveryDate):null; let dr='-'; let rc=''; if(dd){const dt=dd.getTime()-t.getTime(); const d=Math.ceil(dt/(1000*60*60*24)); dr=d; if(d<0){dr=`Overdue (${Math.abs(d)})`;rc='bg-red-100 date-overdue';} else if(d===0){dr='Today';rc='bg-yellow-100 font-semibold';} else if(d<=3){dr=`${d} day(s)`;rc='bg-yellow-50';} else{dr=`${d} days`;}} h+=`<tr data-job-id="${j.id}" class="${rc}"><td>${n}</td><td class="max-w-xs truncate" title="${j.details||''}">${j.details||'-'}</td><td>${formatDate(j.orderDate)}</td><td>${formatDate(j.deliveryDate)}</td><td><span class="${getStatusClass(j.status)}">${j.status||'N/A'}</span></td><td>${dr}</td></tr>`;}); b.innerHTML=h; }
        function populateStatusTable() { const b=document.getElementById('status-table')?.querySelector('tbody'); if(!b)return; if(jobsData.length===0&&dataLoaded.jobs){b.innerHTML='<tr><td colspan="4" class="text-center py-4">No jobs.</td></tr>';return;} const so={'Procesando':1,'Encargado':2,'Terminado':3}; const s=[...jobsData].sort((a,b)=>{const sd=(so[a.status]||99)-(so[b.status]||99); if(sd!==0)return sd; return(a.deliveryDate||"9999-12-31").localeCompare(b.deliveryDate||"9999-12-31");}); let h=''; s.forEach(j=>{const n=clientsData[j.clientId]?.name||'Deleted/Unknown'; const dd=j.deliveryDate?parseDateForComparison(j.deliveryDate):null; const t=new Date(); t.setHours(0,0,0,0); const i=dd&&dd<t&&j.status!=='Terminado'; h+=`<tr data-job-id="${j.id}"><td>${n}</td><td class="max-w-xs truncate" title="${j.details||''}">${j.details||'-'}</td><td><span class="${getStatusClass(j.status)}">${j.status||'N/A'}</span></td><td class="${i?'date-overdue':''}">${formatDate(j.deliveryDate)}</td></tr>`;}); b.innerHTML=h; }
        function generateReports() { let tv=0; let td=0; let ct={}; jobsData.forEach(j=>{const fc=j.finalCost||0; const dp=j.deposit||0; tv+=fc; td+=dp; const cid=j.clientId; if(!cid) return; if(!ct[cid]) ct[cid]={name:clientsData[cid]?.name||`Unknown (${cid})`, total:0, deposit:0, outstanding:0}; ct[cid].total+=fc; ct[cid].deposit+=dp;}); const to=tv-td; document.getElementById('report-total-value').textContent=`$${tv.toFixed(2)}`; document.getElementById('report-total-deposit').textContent=`$${td.toFixed(2)}`; document.getElementById('report-total-outstanding').textContent=`$${Math.max(0,to).toFixed(2)}`; const otb=document.getElementById('outstanding-table')?.querySelector('tbody'); if(!otb) return; const cwo=Object.values(ct).map(c=>{c.outstanding=Math.max(0,c.total-c.deposit); return c;}).filter(c=>c.outstanding>0.005).sort((a,b)=>b.outstanding-a.outstanding); if(cwo.length===0){otb.innerHTML='<tr><td colspan="4" class="text-center py-4">No outstanding balances.</td></tr>'; return;} let h=''; cwo.forEach(c=>{h+=`<tr><td>${c.name}</td><td class="text-right">${c.total.toFixed(2)}</td><td class="text-right">${c.deposit.toFixed(2)}</td><td class="text-right font-semibold text-red-600">${c.outstanding.toFixed(2)}</td></tr>`;}); otb.innerHTML=h; }
        function populateMaterialsAdminTable() { if(currentUserRole!=='superadmin') return; const b=document.getElementById('materials-admin-table')?.querySelector('tbody'); if(!b)return; if(Object.keys(materialsData).length===0&&dataLoaded.materials){b.innerHTML='<tr><td colspan="6" class="text-center py-4">No materials.</td></tr>';return;} const s=Object.values(materialsData).sort((a,b)=>{const nc=(a.name||"").localeCompare(b.name||""); if(nc!==0) return nc; return(a.thickness||0)-(b.thickness||0);}); let h=''; s.forEach(m=>{const d=(m.width&&m.height)?`${m.width}x${m.height}`:'N/A'; const at=m.available!==false?'Yes':'No'; const ac=m.available!==false?'text-green-600':'text-red-600'; const c=(m.costPerSheet!==undefined?m.costPerSheet:m.cost)||0; h+=`<tr data-material-id="${m.id}"><td>${m.name||'N/A'}</td><td class="text-right">${m.thickness||'-'}</td><td class="text-right">${c.toFixed(2)}</td><td class="text-center">${d}</td><td class="text-center ${ac} font-semibold">${at}</td><td class="no-print space-x-1 whitespace-nowrap"><button onclick="editMaterialAdmin('${m.id}')" class="edit-button">Edit</button><button onclick="deleteMaterialAdmin('${m.id}')" class="delete-button">Delete</button></td></tr>`;}); b.innerHTML=h; }
        function populateConfigFormAdmin() { if(currentUserRole!=='superadmin')return; const mi=document.getElementById('config-minutes-admin'); const cc=document.getElementById('monthly-costs-container'); const ccp=document.getElementById('calculated-cost-per-minute'); if(!mi||!cc||!ccp)return; mi.value=configData.minutes_per_month||2400; cc.innerHTML=''; const costs=configData.monthly_costs||{}; if(Object.keys(costs).length===0) addMonthlyCostInput('E.g., Rent',''); else Object.keys(costs).sort().forEach(key=>addMonthlyCostInput(key, costs[key])); ccp.textContent=`$${(configData.cost_per_minute||0).toFixed(4)} / min`; }

        // --- CRUD Clientes (SIN CAMBIOS) ---
        document.getElementById('client-form')?.addEventListener('submit', async(e)=>{ e.preventDefault(); if (!db) return; const id=document.getElementById('client-id').value; const n=document.getElementById('client-name').value.trim(); const p=document.getElementById('client-phone').value.trim(); const em=document.getElementById('client-email').value.trim().toLowerCase(); const f=document.getElementById('client-form-feedback'); if(!n){showFeedback(f,'Name required.','error'); return;} if(em&&!/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(em)){showFeedback(f,'Invalid email.','error'); return;} const d={name:n,phone:p||null,email:em||null}; try { showFeedback(f,'Saving...','info'); if(id){await db.collection('clients').doc(id).update(d); showFeedback(f,'Client updated.','success'); clientsData[id]={...clientsData[id],...d};} else {const r=await db.collection('clients').add(d); showFeedback(f,'Client added.','success'); clientsData[r.id]={...d,id:r.id};} resetClientForm(); populateClientsTable(); populateClientDropdown('job-client'); } catch(err){showFeedback(f,`Error: ${err.message}`,'error');} });
        function editClient(id) { const c=clientsData[id]; if(!c){showFeedback(document.getElementById('client-form-feedback'),`Client ${id} N/F.`,'error'); return;} resetClientForm(); document.getElementById('client-form-title').textContent='Edit Client'; document.getElementById('client-id').value=c.id; document.getElementById('client-name').value=c.name||''; document.getElementById('client-phone').value=c.phone||''; document.getElementById('client-email').value=c.email||''; document.getElementById('client-name').focus(); document.getElementById('client-form').scrollIntoView({behavior:'smooth',block:'start'}); }
        function resetClientForm() { document.getElementById('client-form-title').textContent='Add Client'; const f=document.getElementById('client-form'); if(f)f.reset(); const i=document.getElementById('client-id'); if(i)i.value=''; const fb=document.getElementById('client-form-feedback'); if(fb)fb.textContent=''; fb.className='mt-2 text-sm feedback'; }
        async function deleteClient(id) { if(!db)return; const n=clientsData[id]?.name||`ID ${id}`; const aj=jobsData.filter(j=>j.clientId===id); let m=`Delete "${n}"?`; if(aj.length>0) m+=`\n\nWARN! ${aj.length} job(s) linked.`; m+="\n\nCannot undo."; if(!confirm(m))return; const f=document.getElementById('client-form-feedback'); try { showFeedback(f,'Deleting...','info'); await db.collection('clients').doc(id).delete(); delete clientsData[id]; showFeedback(f,`Client "${n}" deleted.`,'success'); populateClientsTable(); populateClientDropdown('job-client'); if(jobsData.some(j=>j.clientId===id)){populateJobsTable();populateDeadlinesTable();populateStatusTable();generateReports();} if(document.getElementById('client-id').value===id) resetClientForm(); } catch(err){showFeedback(f,`Error: ${err.message}`,'error');} }
        function selectClientForNewJob(id) { const n=clientsData[id]?.name; if(!n)return; console.log(`Selected client ${n} (${id})`); setActiveTab(document.querySelector('[data-target=new-job-form]')); setTimeout(()=>{const s=document.getElementById('job-client'); if(s){resetJobForm(id); s.value=id; document.getElementById('job-details')?.focus();} else console.error("job-client N/F.");}, 150); }

        // --- CRUD Trabajos (SIN CAMBIOS) ---
        document.getElementById('job-job-type')?.addEventListener('change',(e)=>{const t=e.target.value; const cf=document.getElementById('job-cut-time-field'); const ef=document.getElementById('job-engrave-time-field'); const ci=document.getElementById('job-cut-minutes'); const ei=document.getElementById('job-engrave-minutes'); if(!cf||!ef||!ci||!ei) return; cf.style.display=(t==='corte'||t==='ambos')?'grid':'none'; ef.style.display=(t==='grabado'||t==='ambos')?'grid':'none'; if(t==='grabado') ci.value=0; if(t==='corte') ei.value=0;});
        function calculateJobQuote() { console.log("Calc cost..."); const f=document.getElementById('job-form-feedback'); const r=document.getElementById('job-quote-base-result'); const fc=document.getElementById('job-final-cost'); currentJobQuoteBaseCost=0; try { showFeedback(f,'','info'); const mid=document.getElementById('job-material').value; const l=parseFloat(document.getElementById('job-length').value)||0; const w=parseFloat(document.getElementById('job-width').value)||0; let mc=0; if(mid&&l>0&&w>0){ const m=materialsData[mid]; if(!m) throw new Error("Invalid material."); const sc=parseFloat((m.costPerSheet!==undefined?m.costPerSheet:m.cost)||0); const sw=parseFloat(m.width||0); const sh=parseFloat(m.height||0); if(sw<=0||sh<=0) throw new Error(`Invalid sheet dims ${sw}x${sh} for "${m.name}".`); const sa=sw*sh; const ja=l*w; mc=(sc/sa)*ja; console.log(`Mat Cost: ${mc.toFixed(2)}`); } else if(mid&&(l<=0||w<=0)) showFeedback(f,'Warn: Enter L/W for mat cost.','info'); const jt=document.getElementById('job-job-type').value; const cmin=(jt==='corte'||jt==='ambos')?(parseFloat(document.getElementById('job-cut-minutes').value)||0):0; const emin=(jt==='grabado'||jt==='ambos')?(parseFloat(document.getElementById('job-engrave-minutes').value)||0):0; const tm=cmin+emin; let mac=0; if(configData.cost_per_minute===undefined||configData.cost_per_minute===null) throw new Error("Cost/min N/A. Check Config."); if(configData.cost_per_minute<=0&&tm>0) { let cf=f.textContent; showFeedback(f,(cf?cf+" ":"")+'Warn: Cost/min is $0.','info'); } if(tm>0){mac=tm*configData.cost_per_minute; console.log(`Mach Cost: ${mac.toFixed(2)}`);} currentJobQuoteBaseCost=mc+mac; console.log(`Base Cost: ${currentJobQuoteBaseCost.toFixed(2)}`); if(r) r.textContent=`Est Base: $${currentJobQuoteBaseCost.toFixed(2)}`; if(fc){const fic=currentJobQuoteBaseCost*2; fc.value=fic.toFixed(2); console.log(`Final Cost: ${fic.toFixed(2)}`); let cf=f.textContent.includes('Warn')?f.textContent+" // ":""; showFeedback(f,cf+`Base $${currentJobQuoteBaseCost.toFixed(2)}. Final $${fic.toFixed(2)}.`,'success');} else showFeedback(f,`Base: $${currentJobQuoteBaseCost.toFixed(2)}.`,'success'); } catch(err) { console.error("Calc cost err:", err); currentJobQuoteBaseCost=0; if(r)r.textContent='Error'; if(fc)fc.value='0.00'; showFeedback(f,`Error: ${err.message}`,'error'); } }
        document.getElementById('job-form')?.addEventListener('submit', async(e)=>{ e.preventDefault(); if(!db)return; const id=document.getElementById('job-id').value; const f=document.getElementById('job-form-feedback'); showFeedback(f,'','info'); const d={clientId:document.getElementById('job-client').value, details:document.getElementById('job-details').value.trim(), materialId:document.getElementById('job-material').value, length:parseFloat(document.getElementById('job-length').value)||null, width:parseFloat(document.getElementById('job-width').value)||null, jobType:document.getElementById('job-job-type').value, cutMinutes:parseFloat(document.getElementById('job-cut-minutes').value)||0, engraveMinutes:parseFloat(document.getElementById('job-engrave-minutes').value)||0, orderDate:document.getElementById('job-order-date').value, deliveryDate:document.getElementById('job-delivery-date').value, status:document.getElementById('job-status').value, baseCost:currentJobQuoteBaseCost, finalCost:parseFloat(document.getElementById('job-final-cost').value)||0, deposit:parseFloat(document.getElementById('job-deposit').value)||0, observations:document.getElementById('job-observations').value.trim()||null}; let errs=[]; if(!d.clientId)errs.push('Select client.'); if(!d.details)errs.push('Enter details.'); if(!d.materialId)errs.push('Select material.'); if(!d.length||d.length<=0)errs.push('Length positive.'); if(!d.width||d.width<=0)errs.push('Width positive.'); if(!d.orderDate)errs.push('Order date.'); if(!d.deliveryDate)errs.push('Delivery date.'); if(d.orderDate&&d.deliveryDate&&d.deliveryDate<d.orderDate)errs.push('Delivery < Order.'); if(d.finalCost<0)errs.push('Final cost neg.'); if(d.deposit<0)errs.push('Deposit neg.'); if(d.deposit>d.finalCost)errs.push('Deposit > Total.'); if(errs.length>0){showFeedback(f,errs.join(' '),'error'); return;} if(d.finalCost<=0&&!confirm("Final cost $0. Save?"))return; try { showFeedback(f,'Saving...','info'); if(id){await db.collection('jobs').doc(id).update(d); showFeedback(f,'Job updated.','success');} else {const r=await db.collection('jobs').add(d); d.id=r.id; showFeedback(f,'Job created.','success');} dataLoaded.jobs=false; setActiveTab(document.querySelector('[data-target=jobs]')); } catch(err){showFeedback(f,`Error: ${err.message}`,'error');} });
        function editJob(id) { const j=jobsData.find(j=>j.id===id); if(!j){alert(`Job ${id} N/F.`);return;} console.log("Editing:", j); resetJobForm(); document.getElementById('job-form-title').textContent='Edit Job'; document.getElementById('job-id').value=j.id; document.getElementById('job-client').value=j.clientId||''; document.getElementById('job-details').value=j.details||''; document.getElementById('job-material').value=j.materialId||''; document.getElementById('job-length').value=j.length||''; document.getElementById('job-width').value=j.width||''; document.getElementById('job-job-type').value=j.jobType||'corte'; document.getElementById('job-job-type').dispatchEvent(new Event('change')); document.getElementById('job-cut-minutes').value=j.cutMinutes||0; document.getElementById('job-engrave-minutes').value=j.engraveMinutes||0; document.getElementById('job-order-date').value=j.orderDate||''; document.getElementById('job-delivery-date').value=j.deliveryDate||''; document.getElementById('job-status').value=j.status||'Encargado'; document.getElementById('job-final-cost').value=(j.finalCost||0).toFixed(2); document.getElementById('job-deposit').value=(j.deposit||0).toFixed(2); document.getElementById('job-observations').value=j.observations||''; currentJobQuoteBaseCost=j.baseCost||0; const r=document.getElementById('job-quote-base-result'); if(r)r.textContent=`Base (Saved): $${currentJobQuoteBaseCost.toFixed(2)}`; setActiveTab(document.querySelector('[data-target=new-job-form]')); setTimeout(()=>{document.getElementById('job-form').scrollIntoView({behavior:'smooth',block:'start'});},100); }
        function resetJobForm(keepClientId=null) { console.log("Resetting job form..."); document.getElementById('job-form-title').textContent='New Job'; const f=document.getElementById('job-form'); if(f)f.reset(); document.getElementById('job-id').value=''; currentJobQuoteBaseCost=0; document.getElementById('job-quote-base-result').textContent='Est Base: $0.00'; document.getElementById('job-final-cost').value='0.00'; document.getElementById('job-order-date').value=new Date().toISOString().split('T')[0]; document.getElementById('job-job-type').dispatchEvent(new Event('change')); const fb=document.getElementById('job-form-feedback'); if(fb)fb.textContent=''; fb.className='mt-2 text-sm feedback'; if(keepClientId){const s=document.getElementById('job-client'); if(s)s.value=keepClientId;} }
        async function deleteJob(id) { if(!db)return; const j=jobsData.find(j=>j.id===id); const n=j?(clientsData[j.clientId]?.name||'Unknown'):'Unknown'; const d=j?(j.details||`ID ${id}`):`ID ${id}`; if(!confirm(`Delete job "${d}" for "${n}"?`))return; try { console.log(`Deleting job ${id}...`); await db.collection('jobs').doc(id).delete(); jobsData=jobsData.filter(j=>j.id!==id); console.log(`Job ${id} deleted.`); alert(`Job "${d}" deleted.`); populateJobsTable(); populateDeadlinesTable(); populateStatusTable(); generateReports(); if(document.getElementById('job-id').value===id) resetJobForm(); } catch(err){alert(`Error: ${err.message}`);} }

        // --- CRUD Materiales (SuperAdmin) (SIN CAMBIOS) ---
        document.getElementById('material-form-admin')?.addEventListener('submit', async(e)=>{ e.preventDefault(); if(currentUserRole!=='superadmin'||!db)return; const id=document.getElementById('material-id-admin').value; const f=document.getElementById('material-form-feedback-admin'); showFeedback(f,'','info'); const d={name:document.getElementById('material-name-admin').value.trim(), thickness:parseFloat(document.getElementById('material-thickness-admin').value)||null, costPerSheet:parseFloat(document.getElementById('material-cost-admin').value)||0, width:parseFloat(document.getElementById('material-width-admin').value)||null, height:parseFloat(document.getElementById('material-height-admin').value)||null, available:document.getElementById('material-availability-admin').checked}; let errs=[]; if(!d.name)errs.push('Name.'); if(!d.thickness||d.thickness<=0)errs.push('Thickness.'); if(d.costPerSheet<0)errs.push('Cost.'); if(!d.width||d.width<=0)errs.push('Width.'); if(!d.height||d.height<=0)errs.push('Height.'); if(errs.length>0){showFeedback(f,errs.join(' ')+' required/positive.','error'); return;} try { showFeedback(f,'Saving...','info'); if(id){await db.collection('materials').doc(id).update(d); materialsData[id]={...materialsData[id],...d}; showFeedback(f,'Updated.','success');} else {const r=await db.collection('materials').add(d); materialsData[r.id]={...d,id:r.id}; showFeedback(f,'Added.','success');} resetMaterialFormAdmin(); populateMaterialsAdminTable(); populateMaterialDropdown('job-material'); } catch(err){showFeedback(f,`Error: ${err.message}`,'error');} });
        function editMaterialAdmin(id) { if(currentUserRole!=='superadmin')return; const m=materialsData[id]; if(!m)return; resetMaterialFormAdmin(); document.getElementById('material-form-title-admin').textContent='Edit Material'; document.getElementById('material-id-admin').value=m.id; document.getElementById('material-name-admin').value=m.name||''; document.getElementById('material-thickness-admin').value=m.thickness||''; document.getElementById('material-cost-admin').value=(m.costPerSheet!==undefined?m.costPerSheet:m.cost)||0; document.getElementById('material-width-admin').value=m.width||''; document.getElementById('material-height-admin').value=m.height||''; document.getElementById('material-availability-admin').checked=m.available!==false; document.getElementById('material-form-admin').scrollIntoView({behavior:'smooth',block:'start'}); document.getElementById('material-name-admin').focus(); }
        function resetMaterialFormAdmin() { if(currentUserRole!=='superadmin')return; document.getElementById('material-form-title-admin').textContent='Add Material'; const f=document.getElementById('material-form-admin'); if(f)f.reset(); document.getElementById('material-id-admin').value=''; document.getElementById('material-availability-admin').checked=true; document.getElementById('material-width-admin').value='1300'; document.getElementById('material-height-admin').value='900'; const fb=document.getElementById('material-form-feedback-admin'); if(fb)fb.textContent=''; fb.className='mt-2 text-sm feedback'; }
        async function deleteMaterialAdmin(id) { if(currentUserRole!=='superadmin'||!db)return; const n=materialsData[id]?.name||`ID ${id}`; const iu=jobsData.some(j=>j.materialId===id); let cm=`Delete "${n}"?`; if(iu)cm+=`\n\nWARN: Used in jobs.`; cm+="\n\nCannot undo."; if(!confirm(cm))return; const f=document.getElementById('material-form-feedback-admin'); try { showFeedback(f,'Deleting...','info'); await db.collection('materials').doc(id).delete(); delete materialsData[id]; showFeedback(f,`Material "${n}" deleted.`,'success'); populateMaterialsAdminTable(); populateMaterialDropdown('job-material'); if(document.getElementById('material-id-admin').value===id) resetMaterialFormAdmin(); } catch(err){showFeedback(f,`Error: ${err.message}`,'error');} }

        // --- CRUD Configuración (SuperAdmin) (SIN CAMBIOS) ---
        function addMonthlyCostInput(key='',value='') { const c=document.getElementById('monthly-costs-container'); if(!c)return; const d=document.createElement('div'); d.className='flex items-center space-x-2 cost-entry'; d.innerHTML=`<input type="text" placeholder="Description" value="${key}" data-cost-key class="flex-grow p-1 border border-gray-300 rounded-md text-sm"> <input type="number" placeholder="0.00" value="${value}" step="0.01" min="0" data-cost-value class="w-24 p-1 border border-gray-300 rounded-md text-sm text-right"> <button type="button" onclick="removeMonthlyCostInput(this)" class="text-red-500 hover:text-red-700 text-xl font-bold leading-none px-1" title="Remove">&times;</button>`; c.appendChild(d); d.querySelector('[data-cost-key]').focus(); }
        function removeMonthlyCostInput(button) { const p=button.closest('.cost-entry'); if(p)p.remove(); }
        document.getElementById('config-form-admin')?.addEventListener('submit', async(e)=>{ e.preventDefault(); if(currentUserRole!=='superadmin'||!db)return; const f=document.getElementById('config-form-feedback-admin'); showFeedback(f,'','info'); document.querySelectorAll('#monthly-costs-container input, #config-minutes-admin').forEach(i=>i.classList.remove('border-red-500')); const min=parseInt(document.getElementById('config-minutes-admin').value,10); const ces=document.querySelectorAll('#monthly-costs-container .cost-entry'); const mc={}; let iv=true; let errs=[]; if(isNaN(min)||min<=0){errs.push('Minutes positive.'); document.getElementById('config-minutes-admin').classList.add('border-red-500'); iv=false;} ces.forEach((div,idx)=>{const ki=div.querySelector('[data-cost-key]'); const vi=div.querySelector('[data-cost-value]'); const k=ki.value.trim(); const vs=vi.value.trim(); const v=parseFloat(vs); if(k||vs){let eiv=true; if(!k){errs.push(`Row ${idx+1}: Descrip.`); ki.classList.add('border-red-500'); eiv=false;} if(vs===''||isNaN(v)||v<0){errs.push(`Row ${idx+1} ('${k||'?'}'): Value >= 0.`); vi.classList.add('border-red-500'); eiv=false;} if(eiv){if(mc.hasOwnProperty(k)){errs.push(`Row ${idx+1}: Dup descrip "${k}".`); ki.classList.add('border-red-500'); eiv=false;} else mc[k]=v;} if(!eiv)iv=false;}}); if(!iv){showFeedback(f,errs.join(' '),'error'); return;} const cu={minutes_per_month:min,monthly_costs:mc}; try { showFeedback(f,'Saving...','info'); await db.collection('config').doc('main').set(cu,{merge:true}); const tm=Object.values(mc).reduce((s,v)=>s+v,0); configData={...configData,minutes_per_month:min,monthly_costs:mc,cost_per_minute:min>0?tm/min:0}; console.log("Config saved. New cost/min:", configData.cost_per_minute); populateConfigFormAdmin(); showFeedback(f,'Config saved.','success'); } catch(err){showFeedback(f,`Error: ${err.message}`,'error');} });

        // === INICIO: FUNCIONES DE IMPRESIÓN REVISADAS ===
        async function printTicket(jobId) {
             console.log(`Printing ticket for Job ID: ${jobId}`);
             const job = jobsData.find(j => j.id === jobId);
             if (!job) { alert(`Error: Job ${jobId} not found.`); return; }
             const client = clientsData[job.clientId];
             const material = materialsData[job.materialId];
             const printArea = document.getElementById('print-area');
             const printAreaWrapper = document.getElementById('print-area-wrapper');
             if (!printArea || !printAreaWrapper) { alert("Error: Print area element not found."); return; }

             const finalCost = job.finalCost || 0;
             const deposit = job.deposit || 0;
             const outstanding = Math.max(0, finalCost - deposit);

             // Generar HTML para el ticket (igual que antes, es específico para UN trabajo)
             let ticketHtml = `
                 <h2>** TICKET TRABAJO **</h2>
                 <p><span class="detail-label">ID Trabajo:</span><span class="detail-value">${job.id.substring(0, 6)}</span></p>
                 <p><span class="detail-label">Pedido:</span><span class="detail-value">${formatDate(job.orderDate)}</span></p>
                 <p><span class="detail-label">Entrega:</span><span class="detail-value">${formatDate(job.deliveryDate)}</span></p>
                 <hr>
                 <p><strong>CLIENTE:</strong></p>
                 <p><span class="detail-label">Nombre:</span><span class="detail-value">${client?.name || 'N/A'}</span></p>
                 ${client?.phone ? `<p><span class="detail-label">Tel:</span><span class="detail-value">${client.phone}</span></p>` : ''}
                 <hr>
                 <p><strong>DETALLES TRABAJO:</strong></p>
                 <p>${job.details || '-'}</p>
                 <p><span class="detail-label">Material:</span> <span class="detail-value">${material?.name || '?'} ${material?.thickness || '?'}mm</span></p>
                 ${(job.length && job.width) ? `<p><span class="detail-label">Medidas:</span> <span class="detail-value">${job.length}x${job.width}mm</span></p>` : ''}
                 <p><span class="detail-label">Tipo:</span> <span class="detail-value">${job.jobType || 'N/A'}</span></p>
                 ${(job.cutMinutes > 0) ? `<p><span class="detail-label">T. Corte:</span> <span class="detail-value">${job.cutMinutes} min</span></p>` : ''}
                 ${(job.engraveMinutes > 0) ? `<p><span class="detail-label">T. Grabado:</span> <span class="detail-value">${job.engraveMinutes} min</span></p>` : ''}
                 ${job.observations ? `<hr><p><strong>Obs:</strong> ${job.observations}</p>` : ''}
                 <hr>
                 <div class="totals">
                     <p class="item-line"><span>Total:</span> <span>$${finalCost.toFixed(2)}</span></p>
                     <p class="item-line"><span>Seña:</span> <span>$${deposit.toFixed(2)}</span></p>
                     <p class="item-line"><strong><span>PENDIENTE:</span> <span>$${outstanding.toFixed(2)}</span></strong></p>
                 </div>
                 <hr>
                 <p style="text-align: center; font-size: 8pt; margin-top: 5px;">¡Gracias!</p>
             `;

             printArea.innerHTML = ticketHtml; // Inyectar HTML
             console.log("Ticket HTML inserted into #print-area:", printArea.innerHTML.substring(0, 200) + "..."); // Log para debug

             document.body.classList.add('printing-ticket'); // Aplicar clase para CSS de ticket

             // Usar requestAnimationFrame para esperar el próximo repintado
             requestAnimationFrame(() => {
                 console.log("Calling window.print() for ticket...");
                 window.print();
                 // Limpieza después de un delay mayor
                 setTimeout(() => {
                     document.body.classList.remove('printing-ticket');
                     printArea.innerHTML = '';
                     console.log("Ticket print cleanup done.");
                 }, 1000); // 1 segundo para asegurar
             });
         }

        function printCurrentSection() {
             console.log(`Printing current section: ${activeSectionId}`);
             const sectionToPrint = document.getElementById(activeSectionId);

             if (!sectionToPrint || !sectionToPrint.classList.contains('tab-content')) {
                 alert("Sección activa no válida para imprimir."); return;
             }
             if (activeSectionId === 'login' || activeSectionId === 'home') {
                  alert("Esta sección no se imprime."); return;
             }
             if (activeSectionId === 'new-job-form' || activeSectionId === 'admin-materials' || activeSectionId === 'admin-config') {
                   if (!confirm("Va a imprimir una vista de formulario. ¿Continuar?")) return;
             }

             // Verificar si la sección contiene una tabla para imprimir
             const tableExists = sectionToPrint.querySelector('.admin-table');
             if (!tableExists && !(activeSectionId === 'new-job-form' || activeSectionId === 'admin-materials' || activeSectionId === 'admin-config') ) {
                 alert(`La sección "${activeSectionId}" no contiene una tabla de datos para imprimir.`);
                 // Podríamos decidir no imprimir o permitir imprimir el contenido que haya
                 // return; // Descomentar si sólo se deben imprimir tablas
             }

             console.log(`Applying print styles for section ${activeSectionId}...`);
             document.body.classList.add('printing-section');
             sectionToPrint.classList.add('printing-now');

             // Usar requestAnimationFrame para esperar el próximo repintado
             requestAnimationFrame(() => {
                 console.log("Calling window.print() for section...");
                 window.print();
                 // Limpieza después de un delay mayor
                 setTimeout(() => {
                     document.body.classList.remove('printing-section');
                     sectionToPrint.classList.remove('printing-now');
                     console.log("Section print cleanup done.");
                 }, 1000); // 1 segundo para asegurar
             });
         }
        // === FIN: FUNCIONES DE IMPRESIÓN REVISADAS ===

        // --- Funciones Utilitarias (SIN CAMBIOS) ---
        function showFeedback(el, msg, type='info') { if(!el)return; el.textContent=msg; el.className='mt-2 text-sm feedback'; if(msg){switch(type){case 'success': el.classList.add('feedback-success'); break; case 'error': el.classList.add('feedback-error'); break; default: el.classList.add('feedback-info'); break;}} if((type==='success'||type==='info')&&msg) setTimeout(()=>{if(el.textContent===msg){el.textContent=''; el.className='mt-2 text-sm feedback';}}, 4000); }
        function formatDate(dStr) { if(!dStr||dStr.length<10)return '-'; try {const [y,m,d]=dStr.substring(0,10).split('-'); if(!y||!m||!d||y.length!==4)return dStr; return`${d}/${m}/${y}`; } catch(e){return dStr;} }
        function parseDateForComparison(dStr) { if(!dStr||dStr.length<10)return null; try {const d=new Date(dStr.substring(0,10)+'T00:00:00Z'); if(isNaN(d.getTime()))return null; return d;} catch(e){return null;} }
        function getStatusClass(s) { switch(s){case 'Encargado': return 'status-encargado'; case 'Procesando': return 'status-procesando'; case 'Terminado': return 'status-terminado'; default: return 'bg-gray-400 text-gray-800 px-2 py-0.5 rounded text-xs font-medium';} }

        // --- Inicialización (SIN CAMBIOS) ---
        document.addEventListener('DOMContentLoaded', () => {
            console.log("DOM loaded."); const y=document.getElementById('current-year'); if(y)y.textContent=new Date().getFullYear(); const j=document.getElementById('job-job-type'); if(j)j.dispatchEvent(new Event('change'));
             if(typeof auth!=='undefined') console.log("Waiting for auth state...");
             else { console.error("Auth N/A. Showing login."); showLoginSection(); alert("Error: Auth service failed."); }
        });

    </script>
    <!-- ****** END OF JAVASCRIPT ****** -->

</body>
</html>