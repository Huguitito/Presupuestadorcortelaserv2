<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Presupuestos Corte Laser</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-auth-compat.js"></script> <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-firestore-compat.js"></script>
    <style>
        /* Estilo para la imagen de fondo */
        .bg-laser-machine {
            background-image: url('https://placehold.co/1920x1080/333333/cccccc?text=Máquina+Láser+(Placeholder)');
            background-size: cover;
            background-position: center;
        }
        /* Ocultar secciones por defecto */
        .page-section { display: none; }
        .active-section { display: block; }

        /* Estilos adicionales */
        body { font-family: 'Inter', sans-serif; }
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap');

        /* Estilo para el logo en PDF (Placeholder) */
        .pdf-logo { width: 50px; height: 50px; background-color: #ccc; text-align: center; line-height: 50px; font-size: 10px; color: #555; margin-bottom: 10px; }

        /* Ocultar elementos de admin por defecto */
        .admin-only { display: none; }
        /* Mostrar elementos de admin cuando el usuario está logueado (se añade clase 'logged-in' al body) */
        body.logged-in .admin-only { display: block; } /* O 'inline-block', 'flex', etc. según necesidad */
        body.logged-in .public-only { display: none; } /* Ocultar botón de login si ya está logueado */

         /* Estilos para tablas de admin */
         .admin-table { width: 100%; border-collapse: collapse; margin-top: 1rem; }
         .admin-table th, .admin-table td { border: 1px solid #ddd; padding: 8px; text-align: left; }
         .admin-table th { background-color: #f2f2f2; }
         .admin-table button { padding: 4px 8px; font-size: 0.8rem; margin-right: 4px; }
    </style>
</head>
<body class="bg-gray-100 text-gray-800">

    <div class="container mx-auto p-4">

        <header class="bg-white shadow-md rounded-lg p-4 mb-6">
            <div class="flex flex-col md:flex-row justify-between items-center">
                 <div>
                    <h1 class="text-3xl font-bold text-blue-600 mb-2">Presupuestos Corte Laser</h1>
                    <div class="text-sm text-gray-600">
                        <p>Dirección: Tu Calle 123, Ciudad | Teléfono: (123) 456-7890 | Email: info@tuempresa.com</p>
                        <p>Redes Sociales: [Iconos o Enlaces]</p>
                    </div>
                 </div>
                 <div class="mt-4 md:mt-0">
                     <button id="admin-login-button" onclick="showSection('admin')" class="public-only bg-gray-600 hover:bg-gray-700 text-white text-sm font-bold py-1 px-3 rounded transition duration-300">
                         Admin Login
                     </button>
                     <button id="admin-logout-button" onclick="logoutAdmin()" class="admin-only bg-red-600 hover:bg-red-700 text-white text-sm font-bold py-1 px-3 rounded transition duration-300">
                         Logout Admin
                     </button>
                 </div>
            </div>
            <nav class="mt-4 flex justify-center md:justify-start space-x-4 border-t pt-4">
                <button onclick="showSection('home')" class="text-blue-600 hover:text-blue-800 font-semibold">Inicio</button>
                <button onclick="showSection('quote')" class="text-blue-600 hover:text-blue-800 font-semibold">Cotizador</button>
                <button onclick="showSection('materials')" class="text-blue-600 hover:text-blue-800 font-semibold">Materiales</button>
                <button onclick="showSection('contact')" class="text-blue-600 hover:text-blue-800 font-semibold">Contacto</button>
                <button onclick="showSection('admin')" class="admin-only text-purple-600 hover:text-purple-800 font-semibold">Admin Panel</button> </nav>
        </header>

        <section id="home" class="page-section active-section bg-laser-machine text-white p-10 rounded-lg shadow-lg text-center flex flex-col items-center justify-center min-h-[50vh]">
           <div class="bg-black bg-opacity-50 p-6 rounded-lg">
                <h2 class="text-4xl font-bold mb-4">Corte y Grabado Láser a tu Medida</h2>
                <p class="text-lg mb-6">Ofrecemos servicios de precisión en corte y grabado láser sobre una variedad de materiales. Obtén una cotización instantánea para tu proyecto.</p>
                <button onclick="showSection('quote')" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-6 rounded-lg text-xl shadow-md transition duration-300">
                    Calcular Presupuesto
                </button>
            </div>
        </section>

        <section id="quote" class="page-section bg-white p-6 rounded-lg shadow-lg">
             <h2 class="text-2xl font-bold mb-6 text-center text-blue-600">Calcula tu Presupuesto</h2>
            <form id="quote-form" class="space-y-4">
                <div>
                    <label for="material" class="block text-sm font-medium text-gray-700">Material:</label>
                    <select id="material" name="material" required class="mt-1 block w-full p-2 border border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500">
                        <option value="">Selecciona un material...</option>
                        </select>
                </div>
                <div>
                    <label for="length" class="block text-sm font-medium text-gray-700">Largo (mm):</label>
                    <input type="number" id="length" name="length" required min="1" class="mt-1 block w-full p-2 border border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500">
                </div>
                <div>
                    <label for="width" class="block text-sm font-medium text-gray-700">Ancho (mm):</label>
                    <input type="number" id="width" name="width" required min="1" class="mt-1 block w-full p-2 border border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500">
                </div>
                <div>
                    <label for="job-type" class="block text-sm font-medium text-gray-700">Tipo de Trabajo:</label>
                    <select id="job-type" name="job-type" required class="mt-1 block w-full p-2 border border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500">
                        <option value="corte">Solo Corte</option>
                        <option value="grabado">Solo Grabado</option>
                        <option value="ambos">Corte y Grabado</option>
                    </select>
                </div>
                 <div id="time-estimation-fields" class="space-y-4">
                     <p class="text-sm text-gray-600">Para calcular el costo de máquina, por favor estima los minutos requeridos:</p>
                    <div id="cut-time-field">
                        <label for="cut-minutes" class="block text-sm font-medium text-gray-700">Minutos Estimados de Corte:</label>
                        <input type="number" id="cut-minutes" name="cut-minutes" min="0" value="0" class="mt-1 block w-full p-2 border border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500">
                    </div>
                     <div id="engrave-time-field">
                        <label for="engrave-minutes" class="block text-sm font-medium text-gray-700">Minutos Estimados de Grabado:</label>
                        <input type="number" id="engrave-minutes" name="engrave-minutes" min="0" value="0" class="mt-1 block w-full p-2 border border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500">
                    </div>
                 </div>
                <button type="submit" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-lg shadow-md transition duration-300">
                    Calcular Costo
                </button>
            </form>
            <div id="quote-result" class="mt-6 p-4 border border-gray-200 rounded-lg bg-gray-50" style="display: none;">
                <h3 class="text-xl font-semibold mb-4 text-center text-blue-600">Presupuesto Estimado</h3>
                <div id="result-details" class="space-y-2 text-sm"></div>
                 <p id="result-total" class="text-lg font-bold mt-4 text-center"></p>
                <button id="generate-pdf" class="mt-4 w-full bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-4 rounded-lg shadow-md transition duration-300">
                    Generar PDF
                </button>
            </div>
             <div id="quote-error" class="mt-4 text-red-600 text-center" style="display: none;"></div>
        </section>

        <section id="materials" class="page-section bg-white p-6 rounded-lg shadow-lg">
            <h2 class="text-2xl font-bold mb-6 text-center text-blue-600">Materiales Disponibles</h2>
            <div id="materials-list" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                <p class="text-gray-500">Cargando materiales...</p>
            </div>
        </section>

        <section id="contact" class="page-section bg-white p-6 rounded-lg shadow-lg">
             <h2 class="text-2xl font-bold mb-6 text-center text-blue-600">Contacto</h2>
            <p class="text-center mb-6 text-gray-600">¿Tienes preguntas o un diseño específico? Contáctanos.</p>
            <form id="contact-form" class="space-y-4">
                <div>
                    <label for="contact-name" class="block text-sm font-medium text-gray-700">Nombre:</label>
                    <input type="text" id="contact-name" name="contact-name" required class="mt-1 block w-full p-2 border border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500">
                </div>
                <div>
                    <label for="contact-email" class="block text-sm font-medium text-gray-700">Email:</label>
                    <input type="email" id="contact-email" name="contact-email" required class="mt-1 block w-full p-2 border border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500">
                </div>
                <div>
                    <label for="contact-message" class="block text-sm font-medium text-gray-700">Mensaje:</label>
                    <textarea id="contact-message" name="contact-message" rows="4" required class="mt-1 block w-full p-2 border border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500"></textarea>
                </div>
                 <div>
                    <label for="contact-file" class="block text-sm font-medium text-gray-700">Adjuntar Diseño (Opcional):</label>
                    <input type="file" id="contact-file" name="contact-file" class="mt-1 block w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-blue-50 file:text-blue-700 hover:file:bg-blue-100">
                     <p class="text-xs text-gray-500 mt-1">Nota: Para enviar el archivo, por favor usa tu correo electrónico o un servicio externo. Este formulario solo enviará el texto.</p>
                </div>
                <button type="submit" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-lg shadow-md transition duration-300">
                    Enviar Mensaje (via Email)
                </button>
            </form>
        </section>

        <section id="admin" class="page-section bg-white p-6 rounded-lg shadow-lg">
            <h2 class="text-2xl font-bold mb-6 text-center text-purple-600">Panel de Administración</h2>

            <div id="admin-login-form" class="public-only max-w-md mx-auto">
                 <h3 class="text-xl font-semibold mb-4 text-center">Iniciar Sesión</h3>
                 <form id="login-form" class="space-y-4">
                    <div>
                        <label for="admin-email" class="block text-sm font-medium text-gray-700">Email:</label>
                        <input type="email" id="admin-email" required class="mt-1 block w-full p-2 border border-gray-300 rounded-md shadow-sm focus:ring-purple-500 focus:border-purple-500">
                    </div>
                    <div>
                        <label for="admin-password" class="block text-sm font-medium text-gray-700">Contraseña:</label>
                        <input type="password" id="admin-password" required class="mt-1 block w-full p-2 border border-gray-300 rounded-md shadow-sm focus:ring-purple-500 focus:border-purple-500">
                    </div>
                    <button type="submit" class="w-full bg-purple-600 hover:bg-purple-700 text-white font-bold py-2 px-4 rounded-lg shadow-md transition duration-300">
                        Entrar
                    </button>
                    <div id="login-error" class="mt-2 text-red-600 text-sm text-center"></div>
                 </form>
            </div>

            <div id="admin-content" class="admin-only space-y-8">

                <div>
                    <h3 class="text-xl font-semibold mb-4 text-purple-700">Gestionar Materiales</h3>
                    <form id="material-form" class="bg-gray-50 p-4 rounded border border-gray-200 space-y-3 mb-6">
                        <h4 id="material-form-title" class="text-lg font-medium">Añadir Nuevo Material</h4>
                        <input type="hidden" id="material-id"> <div>
                            <label for="material-name" class="block text-sm font-medium text-gray-700">Nombre:</label>
                            <input type="text" id="material-name" required class="mt-1 block w-full p-2 border border-gray-300 rounded-md">
                        </div>
                        <div>
                            <label for="material-thickness" class="block text-sm font-medium text-gray-700">Grosor (mm):</label>
                            <input type="number" id="material-thickness" required min="0.1" step="0.1" class="mt-1 block w-full p-2 border border-gray-300 rounded-md">
                        </div>
                        <div>
                            <label for="material-cost" class="block text-sm font-medium text-gray-700">Costo por Plancha ($):</label>
                            <input type="number" id="material-cost" required min="0" step="0.01" class="mt-1 block w-full p-2 border border-gray-300 rounded-md">
                        </div>
                        <div>
                            <label for="material-width" class="block text-sm font-medium text-gray-700">Ancho Plancha (mm, opcional):</label>
                            <input type="number" id="material-width" placeholder="1300" class="mt-1 block w-full p-2 border border-gray-300 rounded-md">
                        </div>
                         <div>
                            <label for="material-height" class="block text-sm font-medium text-gray-700">Alto Plancha (mm, opcional):</label>
                            <input type="number" id="material-height" placeholder="900" class="mt-1 block w-full p-2 border border-gray-300 rounded-md">
                        </div>
                        <div>
                            <label for="material-availability" class="flex items-center">
                                <input type="checkbox" id="material-availability" checked class="rounded border-gray-300 text-purple-600 shadow-sm focus:border-purple-300 focus:ring focus:ring-purple-200 focus:ring-opacity-50">
                                <span class="ml-2 text-sm text-gray-600">Disponible</span>
                            </label>
                        </div>
                        <div class="flex space-x-2">
                            <button type="submit" class="bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-4 rounded">Guardar Material</button>
                            <button type="button" onclick="resetMaterialForm()" class="bg-gray-500 hover:bg-gray-600 text-white font-bold py-2 px-4 rounded">Cancelar Edición</button>
                        </div>
                         <div id="material-form-feedback" class="mt-2 text-sm"></div>
                    </form>

                    <div class="overflow-x-auto">
                         <table id="materials-admin-table" class="admin-table">
                            <thead>
                                <tr>
                                    <th>Nombre</th>
                                    <th>Grosor (mm)</th>
                                    <th>Costo/Plancha ($)</th>
                                    <th>Dimensiones (mm)</th>
                                    <th>Disponible</th>
                                    <th>Acciones</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr><td colspan="6" class="text-center p-4">Cargando materiales...</td></tr>
                            </tbody>
                        </table>
                    </div>
                </div>

                <div>
                    <h3 class="text-xl font-semibold mb-4 text-purple-700">Gestionar Configuración de Costos</h3>
                    <form id="config-form" class="bg-gray-50 p-4 rounded border border-gray-200 space-y-3">
                        <h4 class="text-lg font-medium">Costos Mensuales y Parámetros</h4>
                         <div>
                            <label for="config-minutes" class="block text-sm font-medium text-gray-700">Minutos Base por Mes:</label>
                            <input type="number" id="config-minutes" required min="1" value="2400" class="mt-1 block w-full p-2 border border-gray-300 rounded-md">
                        </div>
                        <fieldset id="monthly-costs-fieldset" class="border p-3 rounded">
                            <legend class="text-sm font-medium px-1">Costos Mensuales ($)</legend>
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-3">
                                 </div>
                        </fieldset>
                        <button type="submit" class="bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-4 rounded">Guardar Configuración</button>
                         <div id="config-form-feedback" class="mt-2 text-sm"></div>
                    </form>
                </div>

            </div> </section>

        <footer class="text-center text-gray-500 text-sm mt-8">
            © <span id="current-year"></span> Presupuestos Corte Laser. Todos los derechos reservados.
        </footer>
    </div>

    <script>
        // --- Configuración de Firebase ---
        const firebaseConfig = {
            apiKey: "AIzaSyAVBHUX8Ey9lLUCiz6mNDOemrNfrR-3Szs",
            authDomain: "presupuestadorcortelaser.firebaseapp.com",
            projectId: "presupuestadorcortelaser",
            storageBucket: "presupuestadorcortelaser.appspot.com",
            messagingSenderId: "159566854109",
            appId: "1:159566854109:web:8d7351cef717697f3ea834"
        };

        // --- Inicialización de Firebase ---
        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();
        const auth = firebase.auth(); // Inicializar Auth

        // --- Variables Globales ---
        let materialsData = {};
        let configData = {};
        let lastQuoteDetails = {};
        let currentAdminUser = null; // Para saber si el admin está logueado

        // --- Navegación ---
        function showSection(sectionId) {
            document.querySelectorAll('.page-section').forEach(section => {
                section.classList.remove('active-section');
            });
            const sectionToShow = document.getElementById(sectionId);
            if(sectionToShow) {
                sectionToShow.classList.add('active-section');
            } else {
                console.error(`Sección con ID '${sectionId}' no encontrada.`);
                document.getElementById('home').classList.add('active-section'); // Ir a inicio si falla
            }

             // Ocultar el panel de admin si no está logueado y se intenta acceder directamente
             if (sectionId === 'admin' && !currentAdminUser) {
                 document.getElementById('admin-login-form').style.display = 'block';
                 document.getElementById('admin-content').style.display = 'none';
             } else if (sectionId === 'admin' && currentAdminUser) {
                 document.getElementById('admin-login-form').style.display = 'none';
                 document.getElementById('admin-content').style.display = 'block';
                 // Cargar datos del admin panel si aún no se han cargado
                 loadAdminData();
             }
        }

        // --- Autenticación Admin ---
        auth.onAuthStateChanged(user => {
            if (user) {
                // Usuario logueado - ASUME QUE ES EL ADMIN
                // ¡IMPORTANTE! En una app real, deberías verificar si este 'user'
                // tiene permisos de admin (ej. comparando su UID o usando Custom Claims)
                console.log("Admin logueado:", user.email);
                currentAdminUser = user;
                document.body.classList.add('logged-in'); // Añade clase para mostrar/ocultar elementos CSS
                if (document.getElementById('admin').classList.contains('active-section')) {
                    showSection('admin'); // Recargar vista de admin si estaba activa
                }
            } else {
                // Usuario deslogueado
                console.log("Admin deslogueado.");
                currentAdminUser = null;
                document.body.classList.remove('logged-in');
                 if (document.getElementById('admin').classList.contains('active-section')) {
                    showSection('admin'); // Mostrar formulario de login si estaba en admin
                }
            }
        });

        // Login
        document.getElementById('login-form')?.addEventListener('submit', async (e) => {
            e.preventDefault();
            const email = document.getElementById('admin-email').value;
            const password = document.getElementById('admin-password').value;
            const errorDiv = document.getElementById('login-error');
            errorDiv.textContent = ''; // Limpiar errores

            try {
                await auth.signInWithEmailAndPassword(email, password);
                // onAuthStateChanged se encargará de actualizar la UI
                errorDiv.textContent = ''; // Limpiar errores si login exitoso
                // No es necesario llamar a showSection aquí, onAuthStateChanged lo hará
            } catch (error) {
                console.error("Error de login:", error);
                errorDiv.textContent = `Error: ${error.message}`;
            }
        });

        // Logout
        function logoutAdmin() {
            auth.signOut().catch(error => {
                console.error("Error al hacer logout:", error);
                alert("Error al cerrar sesión.");
            });
        }

        // --- Carga de Datos (Públicos y Admin) ---
        async function loadInitialData() {
            // Esta función ahora carga principalmente los datos públicos (para cotizador y lista)
            try {
                // Cargar Materiales (para select y lista pública)
                const materialsSnapshot = await db.collection('materials').get();
                const materialSelect = document.getElementById('material');
                const materialsListDiv = document.getElementById('materials-list');
                // Limpiar antes de añadir
                materialSelect.innerHTML = '<option value="">Selecciona un material...</option>';
                materialsListDiv.innerHTML = '';
                materialsData = {}; // Resetear datos locales

                if (materialsSnapshot.empty) {
                     console.warn("No se encontraron materiales en Firebase.");
                     materialsListDiv.innerHTML = '<p class="text-orange-500">No hay materiales configurados.</p>';
                } else {
                    materialsSnapshot.forEach(doc => {
                        const material = doc.data();
                        material.id = doc.id; // Guardar ID para admin
                        materialsData[doc.id] = material;

                        // Añadir al selector público
                        const option = document.createElement('option');
                        option.value = doc.id;
                        const materialName = material.name || 'N/A';
                        const thickness = material.thickness_mm || '?';
                        option.textContent = `${materialName} (${thickness}mm)`;
                        materialSelect.appendChild(option);

                        // Añadir a la lista pública
                        const costPerSheet = typeof material.cost_per_sheet === 'number' ? material.cost_per_sheet.toFixed(2) : 'N/A';
                        const sheetWidth = material.sheet_width_mm || 1300;
                        const sheetHeight = material.sheet_height_mm || 900;
                        const availability = typeof material.availability === 'boolean' ? (material.availability ? 'Disponible' : 'Consultar') : 'Consultar';
                        const materialCard = `
                            <div class="border border-gray-200 rounded-lg p-4 shadow hover:shadow-md transition-shadow duration-200">
                                <h3 class="font-semibold text-lg text-blue-600">${materialName} (${thickness}mm)</h3>
                                <p class="text-sm text-gray-600">Costo/Plancha (${sheetWidth}x${sheetHeight}mm): $${costPerSheet}</p>
                                <p class="text-sm text-gray-600">Disponibilidad: ${availability}</p>
                                <button onclick="selectMaterialAndGoToQuote('${doc.id}')" class="mt-2 bg-blue-500 hover:bg-blue-600 text-white text-sm font-bold py-1 px-3 rounded transition duration-300">
                                    Cotizar con este material
                                </button>
                            </div>`;
                        materialsListDiv.innerHTML += materialCard;
                    });
                }

                // Cargar Configuración (para cálculo de costos)
                const configDoc = await db.collection('config').doc('main').get();
                if (configDoc.exists) {
                    configData = configDoc.data();
                    if (configData.monthly_costs && configData.minutes_per_month && configData.minutes_per_month > 0) {
                        const costs = configData.monthly_costs;
                        const totalMonthly = Object.values(costs).reduce((sum, val) => sum + (typeof val === 'number' ? val : 0), 0);
                        configData.cost_per_minute = totalMonthly / configData.minutes_per_month;
                    } else {
                        configData.cost_per_minute = 0;
                        console.warn("Datos de costos/minutos inválidos en Firebase ('config/main'). Costo por minuto será 0.");
                    }
                } else {
                    configData = { cost_per_minute: 0 }; // Datos por defecto si no existe
                    console.error("Documento 'config/main' no encontrado. Costo por minuto será 0.");
                }

            } catch (error) {
                console.error("Error crítico al cargar datos iniciales:", error);
                // Mostrar error más genérico al usuario
                 document.getElementById('quote-error').textContent = 'Error al cargar datos. Intenta recargar.';
                 document.getElementById('quote-error').style.display = 'block';
                 document.getElementById('materials-list').innerHTML = '<p class="text-red-500">Error al cargar materiales.</p>';
            }
        }

        // Cargar datos específicos del panel de admin (tabla materiales, form config)
        function loadAdminData() {
            if (!currentAdminUser) return; // Solo si está logueado

            // Cargar tabla de materiales para admin
            const tableBody = document.getElementById('materials-admin-table')?.querySelector('tbody');
            if (!tableBody) return;
            tableBody.innerHTML = '<tr><td colspan="6" class="text-center p-4">Actualizando...</td></tr>'; // Limpiar tabla

            let rowsHtml = '';
            // Usar materialsData ya cargado
            Object.values(materialsData).sort((a, b) => (a.name || '').localeCompare(b.name || '')).forEach(material => {
                 const cost = typeof material.cost_per_sheet === 'number' ? material.cost_per_sheet.toFixed(2) : 'N/A';
                 const dims = `${material.sheet_width_mm || '-'}x${material.sheet_height_mm || '-'}`;
                 const available = typeof material.availability === 'boolean' ? (material.availability ? 'Sí' : 'No') : '?';
                 rowsHtml += `
                    <tr>
                        <td>${material.name || 'N/A'}</td>
                        <td>${material.thickness_mm || '?'}</td>
                        <td>$${cost}</td>
                        <td>${dims}</td>
                        <td>${available}</td>
                        <td>
                            <button onclick="editMaterial('${material.id}')" class="bg-yellow-500 hover:bg-yellow-600 text-white rounded">Editar</button>
                            <button onclick="deleteMaterial('${material.id}')" class="bg-red-500 hover:bg-red-600 text-white rounded">Borrar</button>
                        </td>
                    </tr>
                 `;
            });
            tableBody.innerHTML = rowsHtml || '<tr><td colspan="6" class="text-center p-4">No hay materiales definidos.</td></tr>';


            // Cargar formulario de configuración
            const configMinutesInput = document.getElementById('config-minutes');
            const costsFieldset = document.getElementById('monthly-costs-fieldset')?.querySelector('.grid'); // Target the grid div

            if (configMinutesInput) {
                configMinutesInput.value = configData.minutes_per_month || 2400;
            }
            if (costsFieldset) {
                costsFieldset.innerHTML = ''; // Limpiar campos anteriores
                const costs = configData.monthly_costs || {};
                // Definir los campos esperados para asegurar el orden y la presencia
                const expectedCosts = ['alquiler', 'sueldos', 'luz', 'impuestos', 'amortizacion', 'tubo_laser', 'mantenimiento'];
                expectedCosts.forEach(key => {
                    const value = costs[key] || 0;
                    const label = key.charAt(0).toUpperCase() + key.slice(1).replace('_', ' '); // Formatear etiqueta
                    costsFieldset.innerHTML += `
                        <div>
                            <label for="cost-${key}" class="block text-xs font-medium text-gray-600">${label}:</label>
                            <input type="number" id="cost-${key}" name="${key}" value="${value}" min="0" step="0.01" required class="mt-1 block w-full p-1 border border-gray-300 rounded-md text-sm">
                        </div>
                    `;
                });
                 // Añadir otros costos encontrados en Firebase que no estaban en la lista esperada
                 Object.keys(costs).forEach(key => {
                    if (!expectedCosts.includes(key)) {
                         const value = costs[key] || 0;
                         const label = key.charAt(0).toUpperCase() + key.slice(1).replace('_', ' ');
                         costsFieldset.innerHTML += `
                            <div>
                                <label for="cost-${key}" class="block text-xs font-medium text-gray-600">${label}:</label>
                                <input type="number" id="cost-${key}" name="${key}" value="${value}" min="0" step="0.01" required class="mt-1 block w-full p-1 border border-gray-300 rounded-md text-sm">
                            </div>
                        `;
                    }
                 });
            }
        }


        // --- CRUD Materiales (Admin) ---
        const materialForm = document.getElementById('material-form');
        const materialFormFeedback = document.getElementById('material-form-feedback');

        materialForm?.addEventListener('submit', async (e) => {
            e.preventDefault();
            if (!currentAdminUser) {
                showFeedback(materialFormFeedback, 'Error: Debes estar logueado como admin.', 'error');
                return;
            }

            const materialId = document.getElementById('material-id').value; // ID si estamos editando
            const name = document.getElementById('material-name').value;
            const thickness = parseFloat(document.getElementById('material-thickness').value);
            const cost = parseFloat(document.getElementById('material-cost').value);
            const width = parseInt(document.getElementById('material-width').value) || null; // null si está vacío
            const height = parseInt(document.getElementById('material-height').value) || null;
            const availability = document.getElementById('material-availability').checked;

            if (!name || isNaN(thickness) || isNaN(cost) || thickness <=0 || cost < 0) {
                 showFeedback(materialFormFeedback, 'Error: Nombre, Grosor (>0) y Costo (>=0) son requeridos.', 'error');
                 return;
            }

            const materialData = {
                name: name,
                thickness_mm: thickness,
                cost_per_sheet: cost,
                sheet_width_mm: width,
                sheet_height_mm: height,
                availability: availability
            };

            // Limpiar campos nulos opcionales antes de guardar
             if (materialData.sheet_width_mm === null) delete materialData.sheet_width_mm;
             if (materialData.sheet_height_mm === null) delete materialData.sheet_height_mm;


            showFeedback(materialFormFeedback, 'Guardando...', 'info');

            try {
                if (materialId) {
                    // Editar existente
                    await db.collection('materials').doc(materialId).update(materialData);
                    showFeedback(materialFormFeedback, 'Material actualizado correctamente.', 'success');
                } else {
                    // Añadir nuevo
                    await db.collection('materials').add(materialData);
                    showFeedback(materialFormFeedback, 'Material añadido correctamente.', 'success');
                }
                resetMaterialForm();
                await loadInitialData(); // Recargar todos los datos públicos
                loadAdminData(); // Recargar tabla admin
            } catch (error) {
                console.error("Error guardando material:", error);
                showFeedback(materialFormFeedback, `Error al guardar: ${error.message}`, 'error');
            }
        });

        function editMaterial(id) {
            const material = materialsData[id];
            if (!material) return;

            document.getElementById('material-form-title').textContent = 'Editar Material';
            document.getElementById('material-id').value = id;
            document.getElementById('material-name').value = material.name || '';
            document.getElementById('material-thickness').value = material.thickness_mm || '';
            document.getElementById('material-cost').value = material.cost_per_sheet || '';
            document.getElementById('material-width').value = material.sheet_width_mm || '';
            document.getElementById('material-height').value = material.sheet_height_mm || '';
            document.getElementById('material-availability').checked = material.availability || false;

            // Scroll al formulario para visibilidad
            materialForm?.scrollIntoView({ behavior: 'smooth' });
        }

        function resetMaterialForm() {
            document.getElementById('material-form-title').textContent = 'Añadir Nuevo Material';
            materialForm?.reset(); // Resetea el formulario HTML
            document.getElementById('material-id').value = ''; // Limpiar ID oculto
            document.getElementById('material-availability').checked = true; // Default a disponible
            showFeedback(materialFormFeedback, '', 'info'); // Limpiar feedback
        }

        async function deleteMaterial(id) {
            if (!currentAdminUser) {
                alert('Error: Debes estar logueado como admin.');
                return;
            }
            if (!confirm(`¿Estás seguro de que quieres borrar el material "${materialsData[id]?.name || id}"? Esta acción no se puede deshacer.`)) {
                return;
            }

            try {
                await db.collection('materials').doc(id).delete();
                alert('Material borrado correctamente.');
                await loadInitialData(); // Recargar datos públicos
                loadAdminData(); // Recargar tabla admin
            } catch (error) {
                console.error("Error borrando material:", error);
                alert(`Error al borrar: ${error.message}`);
            }
        }

        // --- CRUD Configuración (Admin) ---
         const configForm = document.getElementById('config-form');
         const configFormFeedback = document.getElementById('config-form-feedback');

         configForm?.addEventListener('submit', async (e) => {
             e.preventDefault();
             if (!currentAdminUser) {
                 showFeedback(configFormFeedback, 'Error: Debes estar logueado como admin.', 'error');
                 return;
             }

             const minutes = parseInt(document.getElementById('config-minutes').value);
             const costsInputs = configForm.querySelectorAll('#monthly-costs-fieldset input[type="number"]');
             const monthlyCosts = {};
             let valid = true;

             costsInputs.forEach(input => {
                 const value = parseFloat(input.value);
                 if (isNaN(value) || value < 0) {
                     valid = false;
                 }
                 monthlyCosts[input.name] = value; // Usar el 'name' del input como clave
             });


             if (isNaN(minutes) || minutes <= 0 || !valid) {
                 showFeedback(configFormFeedback, 'Error: Ingresa valores numéricos válidos (minutos > 0, costos >= 0).', 'error');
                 return;
             }

             const configUpdateData = {
                 minutes_per_month: minutes,
                 monthly_costs: monthlyCosts
             };

             showFeedback(configFormFeedback, 'Guardando configuración...', 'info');

             try {
                 // Usar set con merge:true para crear/actualizar el documento 'main'
                 await db.collection('config').doc('main').set(configUpdateData, { merge: true });
                 showFeedback(configFormFeedback, 'Configuración guardada correctamente.', 'success');
                 await loadInitialData(); // Recargar datos para recalcular costo/minuto
             } catch (error) {
                 console.error("Error guardando configuración:", error);
                 showFeedback(configFormFeedback, `Error al guardar: ${error.message}`, 'error');
             }
         });


         // --- Funciones Utilitarias ---
         function showFeedback(element, message, type = 'info') {
             if (!element) return;
             element.textContent = message;
             element.className = 'mt-2 text-sm'; // Reset classes
             if (type === 'success') {
                 element.classList.add('text-green-600');
             } else if (type === 'error') {
                 element.classList.add('text-red-600');
             } else {
                 element.classList.add('text-blue-600');
             }
         }

        // --- Funcionalidad Cotizador (sin cambios) ---
        document.getElementById('quote-form')?.addEventListener('submit', function(event) {
            event.preventDefault();
            calculateQuote();
        });
        document.getElementById('job-type')?.addEventListener('change', function() {
            const jobType = this.value;
            const cutTimeField = document.getElementById('cut-time-field');
            const engraveTimeField = document.getElementById('engrave-time-field');
            if (cutTimeField) cutTimeField.style.display = (jobType === 'corte' || jobType === 'ambos') ? 'block' : 'none';
            if (engraveTimeField) engraveTimeField.style.display = (jobType === 'grabado' || jobType === 'ambos') ? 'block' : 'none';
            const cutMinutesInput = document.getElementById('cut-minutes');
            const engraveMinutesInput = document.getElementById('engrave-minutes');
            if (cutTimeField && cutTimeField.style.display === 'none' && cutMinutesInput) cutMinutesInput.value = 0;
            if (engraveTimeField && engraveTimeField.style.display === 'none' && engraveMinutesInput) engraveMinutesInput.value = 0;
        });
        function calculateQuote() { /* ... (código de cálculo sin cambios) ... */
            const form = document.getElementById('quote-form');
            const resultDiv = document.getElementById('quote-result');
            const resultDetailsDiv = document.getElementById('result-details');
            const resultTotalP = document.getElementById('result-total');
            const errorDiv = document.getElementById('quote-error');
            if (!form || !resultDiv || !resultDetailsDiv || !resultTotalP || !errorDiv) return;
            errorDiv.style.display = 'none'; resultDiv.style.display = 'none';
            const materialId = form.material.value;
            const lengthMm = parseFloat(form.length.value);
            const widthMm = parseFloat(form.width.value);
            const jobType = form['job-type'].value;
            const cutMinutes = parseFloat(form['cut-minutes']?.value) || 0;
            const engraveMinutes = parseFloat(form['engrave-minutes']?.value) || 0;
            if (!materialId) { errorDiv.textContent = 'Selecciona material.'; errorDiv.style.display = 'block'; return; }
            if (isNaN(lengthMm) || isNaN(widthMm) || lengthMm <= 0 || widthMm <= 0) { errorDiv.textContent = 'Largo/Ancho inválidos.'; errorDiv.style.display = 'block'; return; }
            if (isNaN(cutMinutes) || cutMinutes < 0 || isNaN(engraveMinutes) || engraveMinutes < 0) { errorDiv.textContent = 'Minutos inválidos.'; errorDiv.style.display = 'block'; return; }
            if ((jobType === 'corte' || jobType === 'ambos') && cutMinutes <= 0) { errorDiv.textContent = 'Estima minutos de corte.'; errorDiv.style.display = 'block'; return; }
            if ((jobType === 'grabado' || jobType === 'ambos') && engraveMinutes <= 0) { errorDiv.textContent = 'Estima minutos de grabado.'; errorDiv.style.display = 'block'; return; }
            const selectedMaterial = materialsData[materialId];
            if (!selectedMaterial || typeof selectedMaterial.cost_per_sheet !== 'number') { errorDiv.textContent = 'Datos de material inválidos.'; errorDiv.style.display = 'block'; return; }
            const sheetWidthMm = selectedMaterial.sheet_width_mm || 1300;
            const sheetHeightMm = selectedMaterial.sheet_height_mm || 900;
            const sheetAreaMm2 = sheetWidthMm * sheetHeightMm;
            if (sheetAreaMm2 <= 0) { errorDiv.textContent = 'Dimensiones plancha inválidas.'; errorDiv.style.display = 'block'; return; }
            const requestedAreaMm2 = lengthMm * widthMm;
            const materialCost = (requestedAreaMm2 / sheetAreaMm2) * selectedMaterial.cost_per_sheet;
            let totalMinutes = 0;
            if (jobType === 'corte') totalMinutes = cutMinutes; else if (jobType === 'grabado') totalMinutes = engraveMinutes; else if (jobType === 'ambos') totalMinutes = cutMinutes + engraveMinutes;
            const costPerMinute = configData.cost_per_minute;
            if (typeof costPerMinute !== 'number' || costPerMinute < 0) { console.error("Costo/minuto inválido:", costPerMinute); if (totalMinutes > 0) { errorDiv.textContent = 'Error costo/minuto.'; errorDiv.style.display = 'block'; return; } }
            const machineCost = totalMinutes * (costPerMinute || 0);
            const totalCost = materialCost + machineCost;
            if (isNaN(totalCost)) { errorDiv.textContent = 'Error cálculo final.'; errorDiv.style.display = 'block'; return; }
            const materialNameDisplay = `${selectedMaterial.name || 'N/A'} (${selectedMaterial.thickness_mm || '?'}mm)`;
            lastQuoteDetails = { materialName: materialNameDisplay, lengthMm: lengthMm, widthMm: widthMm, jobType: jobType, cutMinutes: jobType === 'corte' || jobType === 'ambos' ? cutMinutes : 0, engraveMinutes: jobType === 'grabado' || jobType === 'ambos' ? engraveMinutes : 0, materialCost: materialCost, machineCost: machineCost, totalCost: totalCost, costPerMinute: costPerMinute || 0, totalMinutes: totalMinutes };
            resultDetailsDiv.innerHTML = `<p><strong>Material:</strong> ${lastQuoteDetails.materialName}</p><p><strong>Dimensiones:</strong> ${lengthMm} mm x ${widthMm} mm</p><p><strong>Tipo Trabajo:</strong> ${jobType.charAt(0).toUpperCase() + jobType.slice(1)}</p><hr class="my-2"><p>Costo Material: $${materialCost.toFixed(2)}</p>${totalMinutes > 0 ? `<p>Tiempo Est.: ${totalMinutes} min</p>` : ''}${machineCost > 0 ? `<p>Costo Máquina (@ $${(costPerMinute || 0).toFixed(2)}/min): $${machineCost.toFixed(2)}</p>` : ''}${machineCost === 0 && totalMinutes > 0 && (costPerMinute || 0) === 0 ? '<p class="text-orange-600 text-xs">Advertencia: Costo máquina 0.</p>' : ''}`;
            resultTotalP.textContent = `Total Estimado: $${totalCost.toFixed(2)}`;
            resultDiv.style.display = 'block';
        }

        // --- Generación PDF (sin cambios) ---
        document.getElementById('generate-pdf')?.addEventListener('click', function() { /* ... (código PDF sin cambios) ... */
             if (!lastQuoteDetails.materialName) { alert("Calcula presupuesto primero."); return; }
             if (typeof window.jspdf === 'undefined') { alert("Error librería PDF."); return; }
             const { jsPDF } = window.jspdf; const doc = new jsPDF(); const margin = 15; let y = margin;
             doc.setFontSize(10); doc.setFillColor(200, 200, 200); doc.rect(margin, y, 30, 15, 'F'); doc.setTextColor(100, 100, 100); doc.text("LOGO", margin + 7, y + 10); y += 25;
             doc.setFontSize(18); doc.setTextColor(0, 0, 0); doc.text("Presupuesto Corte Láser", margin, y); y += 10;
             doc.setFontSize(10); doc.setTextColor(100, 100, 100); doc.text("Tu Empresa Laser", margin, y); y += 5; doc.text("Tu Calle 123, Ciudad", margin, y); y += 5; doc.text("Tel: (123) 456-7890 | Email: info@tuempresa.com", margin, y); y += 10;
             doc.setDrawColor(200, 200, 200); doc.line(margin, y, doc.internal.pageSize.width - margin, y); y += 10;
             doc.setFontSize(12); doc.setTextColor(0, 0, 0); doc.text("Detalles del Proyecto:", margin, y); y += 7;
             doc.setFontSize(10); function addDetailLine(label, value) { try { doc.text(`${label}:`, margin, y); doc.text(String(value), margin + 50, y); y += 6; } catch (e) { console.error(`Error PDF line: ${label}`, e);}}
             addDetailLine("Material", lastQuoteDetails.materialName); addDetailLine("Dimensiones", `${lastQuoteDetails.lengthMm} mm x ${lastQuoteDetails.widthMm} mm`); addDetailLine("Tipo Trabajo", lastQuoteDetails.jobType.charAt(0).toUpperCase() + lastQuoteDetails.jobType.slice(1)); if (lastQuoteDetails.cutMinutes > 0) addDetailLine("Min. Corte Est.", `${lastQuoteDetails.cutMinutes}`); if (lastQuoteDetails.engraveMinutes > 0) addDetailLine("Min. Grabado Est.", `${lastQuoteDetails.engraveMinutes}`); y += 5;
             addDetailLine("Costo Material", `$${lastQuoteDetails.materialCost.toFixed(2)}`); if (lastQuoteDetails.machineCost > 0) { addDetailLine("Costo Máquina", `$${lastQuoteDetails.machineCost.toFixed(2)} (@ $${lastQuoteDetails.costPerMinute.toFixed(2)}/min)`); } else if (lastQuoteDetails.totalMinutes > 0) { addDetailLine("Costo Máquina", `$0.00`); } y += 5;
             doc.setFontSize(12); doc.setFont(undefined, 'bold'); addDetailLine("Total Estimado", `$${lastQuoteDetails.totalCost.toFixed(2)}`); doc.setFont(undefined, 'normal'); y += 15;
             doc.setFontSize(9); doc.setTextColor(150, 150, 150); doc.text("Notas:", margin, y); y += 4; doc.text("- Presupuesto estimado...", margin, y); y += 4; doc.text("- Precios sujetos a cambio...", margin, y); y += 4; doc.text("- Válido por 15 días.", margin, y);
             try { doc.save(`Presupuesto_Laser_${Date.now()}.pdf`); } catch (e) { alert("Error al guardar PDF."); console.error("Error save PDF:", e); }
        });

        // --- Página Materiales (sin cambios) ---
        function selectMaterialAndGoToQuote(materialId) { /* ... (sin cambios) ... */
             showSection('quote'); const materialSelect = document.getElementById('material'); if (materialSelect) { materialSelect.value = materialId; } const quoteSection = document.getElementById('quote'); if (quoteSection) { quoteSection.scrollIntoView({ behavior: 'smooth' }); }
        }

        // --- Formulario Contacto (sin cambios) ---
        document.getElementById('contact-form')?.addEventListener('submit', function(event) { /* ... (sin cambios, usa mailto:) ... */
            event.preventDefault(); const nameInput = document.getElementById('contact-name'); const emailInput = document.getElementById('contact-email'); const messageInput = document.getElementById('contact-message'); if (!nameInput || !emailInput || !messageInput) { console.error("Elementos form contacto no encontrados."); alert("Error en formulario."); return; } const name = nameInput.value; const email = emailInput.value; const message = messageInput.value; const subject = encodeURIComponent(`Consulta Presupuestos Laser - ${name}`); const body = encodeURIComponent(`Nombre: ${name}\nEmail: ${email}\n\nMensaje:\n${message}\n\n(Archivo adjunto debe enviarse manualmente)`); const mailtoLink = `mailto:info@tuempresa.com?subject=${subject}&body=${body}`; try { window.location.href = mailtoLink; alert("Se abrirá tu cliente de correo. Adjunta el archivo manualmente si es necesario."); } catch (e) { console.error("Error mailto:", e); alert("No se pudo abrir cliente de correo. Envía manualmente a info@tuempresa.com"); }
        });

        // --- Inicialización ---
        document.addEventListener('DOMContentLoaded', () => {
            loadInitialData().then(() => {
                 showSection('home');
                 const yearSpan = document.getElementById('current-year');
                 if (yearSpan) yearSpan.textContent = new Date().getFullYear();
                 const jobTypeSelect = document.getElementById('job-type');
                 if (jobTypeSelect) jobTypeSelect.dispatchEvent(new Event('change'));
                 // No cargamos loadAdminData aquí, se carga al entrar a la sección admin
            }).catch(error => {
                console.error("Fallo inicialización:", error);
                document.body.innerHTML = '<p class="text-red-600 text-center p-10">Error crítico al cargar. Revisa consola.</p>';
            });
        });

    </script>

</body>
</html>
